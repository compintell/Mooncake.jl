<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tangents · Mooncake.jl</title><meta name="title" content="Tangents · Mooncake.jl"/><meta property="og:title" content="Tangents · Mooncake.jl"/><meta property="twitter:title" content="Tangents · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../../utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../../utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../../utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../developer_tools/">Developer Tools</a></li><li class="is-active"><a class="tocitem" href>Tangents</a><ul class="internal"><li><a class="tocitem" href="#Testing-Functionality"><span>Testing Functionality</span></a></li></ul></li><li><a class="tocitem" href="../forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="../internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Documentation</a></li><li class="is-active"><a href>Tangents</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tangents</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/compintell/Mooncake.jl/blob/main/docs/src/developer_documentation/tangents.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tangents"><a class="docs-heading-anchor" href="#Tangents">Tangents</a><a id="Tangents-1"></a><a class="docs-heading-anchor-permalink" href="#Tangents" title="Permalink"></a></h1><p>As discussed in <a href="../../understanding_mooncake/rule_system/#Representing-Gradients">Representing Gradients</a>, Mooncake requires that each &quot;primal&quot; type be associated to a unique &quot;tangent&quot; type, given by the function <a href="../misc_internals_notes/#tangent_type">tangent_type</a>. Moreover, we must be able to &quot;split&quot; a given tangent into its <em>fdata</em> (&quot;forwards-data&quot;) and <em>rdata</em> (&quot;reverse-data&quot;), whose types are given by <a href="../internal_docstrings/#Mooncake.fdata_type-Tuple{Any}"><code>Mooncake.fdata_type</code></a> and <a href="../internal_docstrings/#Mooncake.rdata_type-Tuple{Any}"><code>Mooncake.rdata_type</code></a> respectively. Furthermore, we (at the very least) require methods of <code>rrule!!</code> for a few core functions in order to be able to differentiate through construction and the getting / setting of fields.</p><p><em>Very</em> occassionally it may be necessary to specify your own tangent type. This is not an entirely trivial undertaking, as there is quite a lot of functionality that must be added to make it work properly. So, before diving in to add your own custom type, seriously consider whether it is worth the effort, and whether the default definition given by Mooncake are really inadequate for your use-case.</p><h2 id="Testing-Functionality"><a class="docs-heading-anchor" href="#Testing-Functionality">Testing Functionality</a><a id="Testing-Functionality-1"></a><a class="docs-heading-anchor-permalink" href="#Testing-Functionality" title="Permalink"></a></h2><p>The interface is given in the form of three functions, each of which specifiy which functions you must implement methods for when creating a custom tangent type:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent_interface" href="#Mooncake.TestUtils.test_tangent_interface"><code>Mooncake.TestUtils.test_tangent_interface</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent_interface(rng::AbstractRNG, p; interface_only=false)</code></pre><p>Verify that standard functionality for tangents runs, and is consistent. This function is the defacto formal definition of the &quot;tangent interface&quot; – if this function runs without error for a given value of <code>p</code>, then that <code>p</code> satisfies the tangent interface.</p><p><strong>Extended Help</strong></p><p>Verifies that the following functions are implemented correctly (as far as possible) for <code>p</code> / its type, and its tangents / their type:</p><ul><li><a href="../internal_docstrings/#Mooncake.tangent_type-Tuple{Any}"><code>Mooncake.tangent_type</code></a></li><li><a href="../internal_docstrings/#Mooncake.zero_tangent_internal-Tuple{Union{Int128, Int16, Int32, Int64, Int8}, Union{Mooncake.NoCache, IdDict{Any, Any}}}"><code>Mooncake.zero_tangent_internal</code></a></li><li><a href="../internal_docstrings/#Mooncake.randn_tangent_internal-Union{Tuple{P}, Tuple{Random.AbstractRNG, P, Union{Mooncake.NoCache, IdDict{Any, Any}}}} where P&lt;:Union{Float16, Float32, Float64}"><code>Mooncake.randn_tangent_internal</code></a></li><li><a href="../internal_docstrings/#Mooncake.TestUtils.has_equal_data-Tuple{Any, Any}"><code>Mooncake.TestUtils.has_equal_data</code></a></li><li><a href="../internal_docstrings/#Mooncake.increment_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent, Mooncake.NoTangent}"><code>Mooncake.increment_internal!!</code></a></li><li><a href="../internal_docstrings/#Mooncake.set_to_zero_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent}"><code>Mooncake.set_to_zero_internal!!</code></a></li><li><a href="../internal_docstrings/#Mooncake._add_to_primal_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Any, Mooncake.NoTangent, Bool}"><code>Mooncake._add_to_primal_internal</code></a></li><li><a href="../internal_docstrings/#Mooncake._diff_internal-Union{Tuple{P}, Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, P, P}} where P"><code>Mooncake._diff_internal</code></a></li><li><a href="../internal_docstrings/#Mooncake._dot_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Mooncake.NoTangent, Mooncake.NoTangent}"><code>Mooncake._dot_internal</code></a></li><li><a href="../internal_docstrings/#Mooncake._scale_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Float64, Mooncake.NoTangent}"><code>Mooncake._scale_internal</code></a></li><li><a href="../internal_docstrings/#Mooncake.TestUtils.populate_address_map_internal-Union{Tuple{T}, Tuple{P}, Tuple{Dict{Ptr{Nothing}, Ptr{Nothing}}, P, T}} where {P, T}"><code>Mooncake.TestUtils.populate_address_map_internal</code></a></li></ul><p>In conjunction with the functions tested by <a href="#Mooncake.TestUtils.test_tangent_splitting"><code>test_tangent_splitting</code></a>, these functions constitute a complete set of functions which must be applicable to <code>p</code> in order to ensure that it operates correctly in the context of reverse-mode AD. This list should be up to date at any given point in time, but the best way to verify that you&#39;ve implemented everything is simply to run this function, and see whether it errors / produces a failing test.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/81ff93392ec36d0b2957357e0e192ca5f7316db3/src/test_utils.jl#L801-L829">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent_splitting" href="#Mooncake.TestUtils.test_tangent_splitting"><code>Mooncake.TestUtils.test_tangent_splitting</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent_splitting(rng::AbstractRNG, p::P) where {P}</code></pre><p>Verify that tangent splitting functionality associated to primal <code>p</code> works correctly. Ensure that <a href="#Mooncake.TestUtils.test_tangent_interface"><code>test_tangent_interface</code></a> runs for <code>p</code> before running these tests.</p><p><strong>Extended Help</strong></p><p>Verifies that the following functionality work correctly for <code>p</code> / its type / tangents:</p><ul><li><a href="../internal_docstrings/#Mooncake.fdata_type-Tuple{Any}"><code>Mooncake.fdata_type</code></a></li><li><a href="../internal_docstrings/#Mooncake.rdata_type-Tuple{Any}"><code>Mooncake.rdata_type</code></a></li><li><a href="../internal_docstrings/#Mooncake.fdata-Tuple{T} where T"><code>Mooncake.fdata</code></a></li><li><a href="../internal_docstrings/#Mooncake.rdata-Tuple{T} where T"><code>Mooncake.rdata</code></a></li><li><a href="../internal_docstrings/#Mooncake.uninit_fdata-Tuple{Any}"><code>Mooncake.uninit_fdata</code></a></li><li><a href="../internal_docstrings/#Mooncake.tangent_type-Tuple{Any}"><code>Mooncake.tangent_type</code></a> (binary method)</li><li><a href="../internal_docstrings/#Mooncake.tangent-Tuple{Mooncake.NoFData, Mooncake.NoRData}"><code>Mooncake.tangent</code></a> (binary method)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/81ff93392ec36d0b2957357e0e192ca5f7316db3/src/test_utils.jl#L1122-L1138">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_rule_and_type_interactions" href="#Mooncake.TestUtils.test_rule_and_type_interactions"><code>Mooncake.TestUtils.test_rule_and_type_interactions</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_rule_and_type_interactions(rng::AbstractRNG, p)</code></pre><p>Check that a collection of standard functions for which we <em>ought</em> to have a working rrule for <code>p</code> work, and produce the correct answer. For example, the <code>rrule!!</code> for <code>typeof</code> should work correctly on any type, we should have a working rule for <code>getfield</code> for any struct-type, and we should have a rule for <code>setfield!</code> for any mutable struct type. See extended help for more info.</p><p><strong>Extended Help</strong></p><p>The purpose of this test is to ensure that, for any given <code>p</code>, the full range of primitive functions that <em>ought</em> to work on it, do indeed work on it.</p><p>This is one part of the interface where some care <em>might</em> be required. If, for some reason, it should <em>never</em> be the case that e.g. for a particular <code>p</code>, <code>getfield</code> should be called, then it may make no sense at all to run these tests. In such cases, the author of the type is responsible for knowing what they are doing. Please open an issue to discuss for your type if you are at all unsure what to do.</p><p>When defining a custom tangent type for <code>P</code>, the functions that you will need to pay attention to writing rules for are</p><ul><li><a href="../internal_docstrings/#Mooncake._new_-Union{Tuple{N}, Tuple{T}, Tuple{Type{T}, Vararg{Any, N}}} where {T, N}"><code>Mooncake._new_</code></a></li><li><a href="../internal_docstrings/#Mooncake.lgetfield-Union{Tuple{f}, Tuple{Any, Val{f}}} where f"><code>Mooncake.lgetfield</code></a></li><li><a href="../internal_docstrings/#Mooncake.lsetfield!-Union{Tuple{name}, Tuple{Any, Val{name}, Any}} where name"><code>Mooncake.lsetfield!</code></a></li></ul><p>In all cases, you may wish to consult the current implementations of <code>rrule!!</code> for these functions for inspiration regarding how you might implement them for your type.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/81ff93392ec36d0b2957357e0e192ca5f7316db3/src/test_utils.jl#L1217-L1245">source</a></section></article><p>You can call all three of these functions at once using</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_data" href="#Mooncake.TestUtils.test_data"><code>Mooncake.TestUtils.test_data</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_data(rng::AbstractRNG, p::P)</code></pre><p>Verify that all tangent / fdata / rdata functionality work properly for <code>x</code>. Furthermore, verify that all primitives listed in <code>TestUtils.test_rule_and_type_interactions</code> work correctly on <code>x</code>. This functionality is particularly useful if you are writing your own custom tangent / fdata / rdata types and want to be confident that you have implemented the functionality that you need in order to make these custom types work with all the rules written in Mooncake itself.</p><p>You should consult the docstrings for <a href="#Mooncake.TestUtils.test_tangent_interface"><code>test_tangent_interface</code></a>, <a href="#Mooncake.TestUtils.test_tangent_splitting"><code>test_tangent_splitting</code></a>, and <a href="#Mooncake.TestUtils.test_rule_and_type_interactions"><code>test_rule_and_type_interactions</code></a>, in order to see what is required to satisfy the full tangent interface for <code>p</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/compintell/Mooncake.jl/blob/81ff93392ec36d0b2957357e0e192ca5f7316db3/src/test_utils.jl#L1351-L1364">source</a></section></article><p>If all the tests in these functions pass, then you have satisfied the interface.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../developer_tools/">« Developer Tools</a><a class="docs-footer-nextpage" href="../forwards_mode_design/">Forwards-Mode Design »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Thursday 6 March 2025 19:17">Thursday 6 March 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
