<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Internal Docstrings · Mooncake.jl</title><meta name="title" content="Internal Docstrings · Mooncake.jl"/><meta property="og:title" content="Internal Docstrings · Mooncake.jl"/><meta property="twitter:title" content="Internal Docstrings · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body>
<!-- NAVBAR START -->
<style>
    html {
        scroll-padding-top: calc(55px + 1rem);
    }

    /* Documenter css tweaks */
    .docs-sidebar {
        margin-top: 3.75rem;
    }

    #documenter {
        margin-top: 3.75rem;
    }

    .docs-version-selector {
        margin-bottom: 60px !important;
    }

    @media screen and (max-width: 1056px) {
        .docs-version-selector {
            margin-bottom: 60px !important;
        }

        .docs-sidebar {
            margin-top: 0 !important;
        }
    }
    /* Documenter css tweaks ends here */

    :root {
        --heading-color: white;
        --item-color: rgb(165, 165, 165);
        --primary-bg: #073c44;
        --hover-color: #8faad2;
        --deprecated-bg: #ff4d4d;
        --deprecated-text: white;
    }

    .ext-navigation {
        position: fixed;
        height: 3.75rem;
        top: 0;
        width: 100%;
        background-color: var(--primary-bg);
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        padding: 0 1.0625rem;
        transition: transform 0.3s;
    }

    .ext-navbar-logo {
        margin-left: 0.625rem;
    }

    .ext-nav-links {
        display: flex;
        align-items: center;
        list-style-type: none;
        margin: 0;
        padding: 0;
        flex-grow: 1;
    }

    .ext-nav-links li {
        margin-left: 1rem !important;
    }

    .ext-nav-link {
        color: white !important;
        text-decoration: none;
        font-size: 1.0625rem !important;
        transition: color 0.2s ease;
        cursor: pointer;
    }

    .ext-nav-link:hover,
    .ext-navbar-item-single a:hover {
        color: var(--hover-color) !important;
    }

    .ext-navbar-item-single a {
        color: #fff !important;
    }

    .ext-menu-toggle {
        display: none;
        font-size: 1.5rem;
        color: white;
        cursor: pointer;
    }

    .ext-dropdown {
        display: none;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        grid-template-rows: auto auto auto;
        padding: 1.875rem;
        position: absolute;
        width: 100%;
        left: 0;
        background-color: #083c44;
        line-height: 1.875rem;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(-0.625rem);
    }

    #library-handler::after {
        content: "▼";
        font-size: 0.6875rem;
        margin-left: 0.3125rem;
        transition: transform 0.3s ease-in-out;
    }

    #library-handler.open::after {
        content: "▲";
    }

    .ext-dropdown.show {
        display: grid;
        opacity: 1;
        transform: translateY(0);
    }

    .ext-dropdown ul {
        height: auto;
        width: 12.5rem;
        margin-bottom: 1.25rem;
    }

    .ext-dropdown ul li {
        text-align: left;
        display: flex;
        align-items: center;
    }

    .navbar-sub-item {
        list-style: none;
    }

    .ext-dropdown ul a li {
        color: var(--item-color);
        width: 15.625rem;
        border-radius: 3px;
        padding: 0.125rem 0.625rem;
        transition: background-color 0.2s ease;
    }

    .ext-dropdown ul a li:hover {
        background-color: rgba(107, 107, 107, 0.5);
    }

    .ext-dropdown-item-heading {
        color: var(--heading-color);
        text-align: center;
    }

    .deprecated-badge {
        background-color: var(--deprecated-bg);
        color: var(--deprecated-text);
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        margin-left: 0.5rem;
        line-height: 1;
    }

    /* Responsive styling */
    @media (max-width: 966px) {
        .ext-dropdown {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .ext-nav-links {
            display: none;
            flex-direction: column;
            width: 100%;
            background-color: var(--primary-bg);
            position: absolute;
            top: 3.75rem;
            left: 0;
            padding: 0.625rem 0;
            height: auto;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgb(141, 141, 141) grey;
        }

        .ext-nav-links.show {
            display: flex;
        }

        .ext-nav-links li {
            margin: 0.625rem 0;
            text-align: center;
        }

        .ext-menu-toggle {
            display: block;
            margin-left: auto;
        }

        .ext-navigation.hide {
            transform: translateY(-3.75rem);
        }

        .ext-dropdown {
            place-content: center;
            text-align: center;
            grid-template-columns: 1fr;
            line-height: 1.25rem;
            padding: 0.625rem;
        }

        .ext-dropdown ul {
            width: 100%;
            text-align: center;
            margin-bottom: 0.3125rem;
        }

        .ext-dropdown ul li {
            text-align: center;
            /* justify-content: center; */
        }

        .ext-dropdown ul a li {
            width: 100%;
        }

        .ext-dropdown ul a li:hover {
            background-color: var(--primary-bg);
            color: #fff;
        }

        /* Modified scroll bar */
        .ext-nav-links::-webkit-scrollbar {
            width: 5px;
        }

        .ext-nav-links::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px grey;
        }

        .ext-nav-links::-webkit-scrollbar-thumb {
            background: rgb(141, 141, 141);
            border-radius: 3px;
        }

        .ext-nav-links::-webkit-scrollbar-thumb:hover {
            background: #9b9b9b;
        }
    }
</style>
<nav class="ext-navigation">
    <a href="https://turinglang.org/">
        <img src="https://turinglang.org/assets/images/turing-logo.svg" alt="Turing Logo" class="ext-navbar-logo" height="24px" width="40px">
    </a>
    <a style="color: white !important; font-size: 21.25px !important; margin-left: 10px;" href="https://turinglang.org/">Turing.jl</a>
    <ul class="ext-nav-links">
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/docs-00-getting-started/">Get Started</a>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/00-introduction/">Tutorials</a>
        </li>
        <li>
            <p class="ext-nav-link" id="library-handler">Libraries</p>
            <div class="ext-dropdown" id="ext-dropdown-items">
                <ul>
                    <li class="ext-dropdown-item-heading">Modelling Languages</li>
                    <a href="https://turinglang.org/DynamicPPL.jl/">
                        <li>DynamicPPL</li>
                    </a>
                    <a href="https://turinglang.org/JuliaBUGS.jl/">
                        <li>JuliaBUGS</li>
                    </a>
                    <a href="https://turinglang.org/TuringGLM.jl/">
                        <li>TuringGLM</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">MCMC</li>
                    <a href="https://turinglang.org/AdvancedHMC.jl/">
                        <li>AdvancedHMC</li>
                    </a>
                    <a href="https://turinglang.org/AbstractMCMC.jl/">
                        <li>AbstractMCMC</li>
                    </a>
                    <a href="https://github.com/theogf/ThermodynamicIntegration.jl">
                        <li>ThermodynamicIntegration</li>
                    </a>
                    <a href="https://turinglang.org/AdvancedPS.jl/">
                        <li>AdvancedPS</li>
                    </a>
                    <a href="https://turinglang.org/SliceSampling.jl/">
                        <li>SliceSampling</li>
                    </a>
                    <a href="https://turinglang.org/EllipticalSliceSampling.jl/">
                        <li>EllipticalSliceSampling</li>
                    </a>
                    <a href="https://turinglang.org/NestedSamplers.jl/">
                        <li>NestedSamplers</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Diagnostics</li>
                    <a href="https://turinglang.org/MCMCChains.jl/">
                        <li>MCMCChains</li>
                    </a>
                    <a href="https://turinglang.org/MCMCDiagnosticTools.jl/">
                        <li>MCMCDiagnosticTools</li>
                    </a>
                    <a href="https://turinglang.org/ParetoSmooth.jl/">
                        <li>ParetoSmooth</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Gaussian Processes</li>
                    <a href="https://juliagaussianprocesses.github.io/AbstractGPs.jl/">
                        <li>AbstractGPs</li>
                    </a>
                    <a href="https://juliagaussianprocesses.github.io/KernelFunctions.jl/">
                        <li>KernelFunctions</li>
                    </a>
                    <a href="https://juliagaussianprocesses.github.io/ApproximateGPs.jl/">
                        <li>ApproximateGPs</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/Bijectors.jl/">Bijectors</a>
                    </li>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/TuringCallbacks.jl/">TuringCallbacks</a>
                    </li>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/Deprecated/TuringBenchmarking/">TuringBenchmarking</a>
                        <span class="deprecated-badge">Deprecated</span>
                    </li>
                </ul>
            </div>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/news/">News</a>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/team/">Team</a>
        </li>
    </ul>
    <a href="https://x.com/TuringLang" style="margin-left: 15px; padding-top: 2px">
        <svg fill="#ffffff" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="32px" viewBox="-209.92 -209.92 931.84 931.84" xml:space="preserve" stroke="#ffffff">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <g id="7935ec95c421cee6d86eb22ecd12f847">
                    <path style="display: inline"
                        d="M459.186,151.787c0.203,4.501,0.305,9.023,0.305,13.565 c0,138.542-105.461,298.285-298.274,298.285c-59.209,0-114.322-17.357-160.716-47.104c8.212,0.973,16.546,1.47,25.012,1.47 c49.121,0,94.318-16.759,130.209-44.884c-45.887-0.841-84.596-31.154-97.938-72.804c6.408,1.227,12.968,1.886,19.73,1.886 c9.55,0,18.816-1.287,27.617-3.68c-47.955-9.633-84.1-52.001-84.1-102.795c0-0.446,0-0.882,0.011-1.318 c14.133,7.847,30.294,12.562,47.488,13.109c-28.134-18.796-46.637-50.885-46.637-87.262c0-19.212,5.16-37.218,14.193-52.7 c51.707,63.426,128.941,105.156,216.072,109.536c-1.784-7.675-2.718-15.674-2.718-23.896c0-57.891,46.941-104.832,104.832-104.832 c30.173,0,57.404,12.734,76.525,33.102c23.887-4.694,46.313-13.423,66.569-25.438c-7.827,24.485-24.434,45.025-46.089,58.002 c21.209-2.535,41.426-8.171,60.222-16.505C497.448,118.542,479.666,137.004,459.186,151.787z">
                    </path>
                </g>
            </g>
        </svg>
    </a>
    <a href="https://github.com/TuringLang/Turing.jl">
        <svg width="32px" height="32px" viewBox="-8.2 -8.2 36.40 36.40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <title>github [#142]</title>
                <desc>Created with Sketch.</desc>
                <defs></defs>
                <g id="Page-1" stroke-width="0.0002" fill="none" fill-rule="evenodd">
                    <g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#ffffff">
                        <g id="icons" transform="translate(56.000000, 160.000000)">
                            <path
                                d="M94,7399 C99.523,7399 104,7403.59 104,7409.253 C104,7413.782 101.138,7417.624 97.167,7418.981 C96.66,7419.082 96.48,7418.762 96.48,7418.489 C96.48,7418.151 96.492,7417.047 96.492,7415.675 C96.492,7414.719 96.172,7414.095 95.813,7413.777 C98.04,7413.523 100.38,7412.656 100.38,7408.718 C100.38,7407.598 99.992,7406.684 99.35,7405.966 C99.454,7405.707 99.797,7404.664 99.252,7403.252 C99.252,7403.252 98.414,7402.977 96.505,7404.303 C95.706,7404.076 94.85,7403.962 94,7403.958 C93.15,7403.962 92.295,7404.076 91.497,7404.303 C89.586,7402.977 88.746,7403.252 88.746,7403.252 C88.203,7404.664 88.546,7405.707 88.649,7405.966 C88.01,7406.684 87.619,7407.598 87.619,7408.718 C87.619,7412.646 89.954,7413.526 92.175,7413.785 C91.889,7414.041 91.63,7414.493 91.54,7415.156 C90.97,7415.418 89.522,7415.871 88.63,7414.304 C88.63,7414.304 88.101,7413.319 87.097,7413.247 C87.097,7413.247 86.122,7413.234 87.029,7413.87 C87.029,7413.87 87.684,7414.185 88.139,7415.37 C88.139,7415.37 88.726,7417.2 91.508,7416.58 C91.513,7417.437 91.522,7418.245 91.522,7418.489 C91.522,7418.76 91.338,7419.077 90.839,7418.982 C86.865,7417.627 84,7413.783 84,7409.253 C84,7403.59 88.478,7399 94,7399"
                                id="github-[#142]">
                            </path>
                        </g>
                    </g>
                </g>
            </g>
        </svg>
    </a>
    <span class="ext-menu-toggle">&#9776;</span>
</nav>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const menuToggle = document.querySelector(".ext-menu-toggle");
        const navLinks = document.querySelector(".ext-nav-links");
        const nav = document.querySelector(".ext-navigation");
        const navigationHandler = document.getElementById("library-handler");
        const navigationItemsContainer =
            document.getElementById("ext-dropdown-items");
        let lastScrollY = window.scrollY;

        function setAppropriateHeight() {
            if (window.innerWidth <= 768) {
                const viewportHeight = window.innerHeight;
                const navHeight = nav.offsetHeight;
                navLinks.style.maxHeight = `${viewportHeight - navHeight}px`;
                navLinks.style.overflowY = "auto";
            } else {
                navLinks.style.maxHeight = "";
                navLinks.style.overflowY = "";
            }
        }

        // Toggle main menu for mobile
        menuToggle.addEventListener("click", () => {
            navLinks.classList.toggle("show");
            if (navLinks.classList.contains("show")) {
                setAppropriateHeight();
                // Ensure the dropdown is hidden when menu is first opened
                navigationItemsContainer.style.display = "none";
                navigationItemsContainer.classList.remove("show");
            }
        });

        // Close menus if clicked outside
        document.addEventListener("click", (event) => {
            if (
                !navLinks.contains(event.target) &&
                !menuToggle.contains(event.target)
            ) {
                navLinks.classList.remove("show");
                navigationItemsContainer.classList.remove("show");
                navigationHandler.classList.remove("open");
            }
        });

        // Hide navigation bar on scroll down in mobile view
        window.addEventListener("scroll", () => {
            if (window.innerWidth <= 768) {
                nav.classList.toggle("hide", window.scrollY > lastScrollY);
                lastScrollY = window.scrollY;
            }
        });

        // Library API script
        navigationHandler.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default action of the link
            if (navigationItemsContainer.classList.contains("show")) {
                navigationItemsContainer.classList.remove("show");
                navigationHandler.classList.remove("open");
                setTimeout(() => {
                    navigationItemsContainer.style.display = "none";
                }, 500); // Match the timeout to the CSS transition duration
            } else {
                navigationItemsContainer.style.display = "grid";
                navigationHandler.classList.add("open");
                setTimeout(() => {
                    navigationItemsContainer.classList.add("show");
                }, 10); // Delay to ensure the display change takes effect before adding class
            }
            setAppropriateHeight(); // Recalculate height when dropdown changes
        });

        // Handle window resize
        window.addEventListener("resize", setAppropriateHeight);

        // Initial setup
        setAppropriateHeight();
    });
</script>
<!-- NAVBAR END -->

<div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Mooncake.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../../utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../../utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../../utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../tangents/">Tangents</a></li><li><a class="tocitem" href="../custom_tangent_type/">Writing Custom Tangent Types</a></li><li><a class="tocitem" href="../ir_representation/">IR Representation</a></li><li><a class="tocitem" href="../forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../reverse_mode_design/">Reverse-Mode Design</a></li><li><a class="tocitem" href="../misc_internals_notes/">Misc. Internals Notes</a></li><li class="is-active"><a class="tocitem" href>Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Documentation</a></li><li class="is-active"><a href>Internal Docstrings</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Internal Docstrings</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl/blob/main/docs/src/developer_documentation/internal_docstrings.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Internal-Docstrings"><a class="docs-heading-anchor" href="#Internal-Docstrings">Internal Docstrings</a><a id="Internal-Docstrings-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-Docstrings" title="Permalink"></a></h1><p>Docstrings listed here are <em>not</em> part of the public Mooncake.jl interface. Consequently, they can change between non-breaking changes to Mooncake.jl without warning.</p><p>The purpose of this is to make it easy for developers to find docstrings straightforwardly via the docs, as opposed to having to ctrl+f through Mooncake.jl&#39;s source code, or looking at the docstrings via the Julia REPL.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.GLOBAL_INTERPRETER" href="#Mooncake.GLOBAL_INTERPRETER"><code>Mooncake.GLOBAL_INTERPRETER</code></a> — <span class="docstring-category">Constant</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">const GLOBAL_INTERPRETER</code></pre><p>Globally cached interpreter. Should only be accessed via <code>get_interpreter</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/abstract_interpretation.jl#L198-L202">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.ADInfo" href="#Mooncake.ADInfo"><code>Mooncake.ADInfo</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ADInfo</code></pre><p>This data structure is used to hold &quot;global&quot; information associated to a particular call to <code>build_rrule</code>. It is used as a means of communication between <code>make_ad_stmts!</code> and the codegen which produces the forwards- and reverse-passes.</p><ul><li><code>interp</code>: a <code>MooncakeInterpreter</code>.</li><li><code>block_stack_id</code>: the ID associated to the block stack – the stack which keeps track of   which blocks we visited during the forwards-pass, and which is used on the reverse-pass   to determine which blocks to visit.</li><li><code>block_stack</code>: the block stack. Can always be found at <code>block_stack_id</code> in the forwards-   and reverse-passes.</li><li><code>entry_id</code>: ID associated to the block inserted at the start of execution in the the   forwards-pass, and the end of execution in the pullback.</li><li><code>shared_data_pairs</code>: the <code>SharedDataPairs</code> used to define the captured variables passed   to both the forwards- and reverse-passes.</li><li><code>arg_types</code>: a map from <code>Argument</code> to its static type.</li><li><code>ssa_insts</code>: a map from <code>ID</code> associated to lines to the primal <code>NewInstruction</code>. This   contains the line of code, its static / inferred type, and some other detailss. See   <code>Core.Compiler.NewInstruction</code> for a full list of fields.</li><li><code>arg_rdata_ref_ids</code>: the dict mapping from arguments to the <code>ID</code> which creates and   initialises the <code>Ref</code> which contains the reverse data associated to that argument.   Recall that the heap allocations associated to this <code>Ref</code> are always optimised away in   the final programme.</li><li><code>ssa_rdata_ref_ids</code>: the same as <code>arg_rdata_ref_ids</code>, but for each <code>ID</code> associated to an   ssa rather than each argument.</li><li><code>debug_mode</code>: if <code>true</code>, run in &quot;debug mode&quot; – wraps all rule calls in <code>DebugRRule</code>. This   is applied recursively, so that debug mode is also switched on in derived rules.</li><li><code>is_used_dict</code>: for each <code>ID</code> associated to a line of code, is <code>false</code> if line is not used   anywhere in any other line of code.</li><li><code>lazy_zero_rdata_ref_id</code>: for any arguments whose type doesn&#39;t permit the construction of   a zero-valued rdata directly from the type alone (e.g. a struct with an abstractly-   typed field), we need to have a zero-valued rdata available on the reverse-pass so that   this zero-valued rdata can be returned if the argument (or a part of it) is never used   during the forwards-pass and consequently doesn&#39;t obtain a value on the reverse-pass.   To achieve this, we construct a <code>LazyZeroRData</code> for each of the arguments on the   forwards-pass, and make use of it on the reverse-pass. This field is the ID that will be   associated to this information.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L83-L122">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.ADStmtInfo" href="#Mooncake.ADStmtInfo"><code>Mooncake.ADStmtInfo</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ADStmtInfo</code></pre><p>Data structure which contains the result of <code>make_ad_stmts!</code>. Fields are</p><ul><li><code>line</code>: the ID associated to the primal line from which this is derived</li><li><code>comms_id</code>: an <code>ID</code> from one of the lines in <code>fwds</code>, whose value will be made   available on the reverse-pass in the same <code>ID</code>. Nothing is asserted about <em>how</em> this   value is made available on the reverse-pass of AD, so this package is free to do this in   whichever way is most efficient, in particular to group these communication <code>ID</code> on a   per-block basis.</li><li><code>fwds</code>: the instructions which run the forwards-pass of AD</li><li><code>rvs</code>: the instructions which run the reverse-pass of AD / the pullback</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L307-L319">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BlockStack" href="#Mooncake.BlockStack"><code>Mooncake.BlockStack</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><p>The block stack is the stack used to keep track of which basic blocks are visited on the forwards pass, and therefore which blocks need to be visited on the reverse pass. There is one block stack per derived rule. By using Int32, we assume that there aren&#39;t more than <code>typemax(Int32)</code> unique basic blocks in a given function, which ought to be reasonable.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L74-L80">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.CannotProduceZeroRDataFromType" href="#Mooncake.CannotProduceZeroRDataFromType"><code>Mooncake.CannotProduceZeroRDataFromType</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">CannotProduceZeroRDataFromType()</code></pre><p>Returned by <code>zero_rdata_from_type</code> if is not possible to construct the zero rdata element for a given type. See <code>zero_rdata_from_type</code> for more info.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L650-L655">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.DebugPullback" href="#Mooncake.DebugPullback"><code>Mooncake.DebugPullback</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">DebugPullback(pb, y, x)</code></pre><p>Construct a callable which is equivalent to <code>pb</code>, but which enforces type-based pre- and post-conditions to <code>pb</code>. Let <code>dx = pb.pb(dy)</code>, for some rdata <code>dy</code>, then this function</p><ul><li>checks that <code>dy</code> has the correct rdata type for <code>y</code>, and</li><li>checks that each element of <code>dx</code> has the correct rdata type for <code>x</code>.</li></ul><p>Reverse pass counterpart to <a href="#Mooncake.DebugRRule"><code>DebugRRule</code></a></p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/debug_mode.jl#L2-L11">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.DebugPullback-Tuple{Any}" href="#Mooncake.DebugPullback-Tuple{Any}"><code>Mooncake.DebugPullback</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">(pb::DebugPullback)(dy)</code></pre><p>Apply type checking to enforce pre- and post-conditions on <code>pb.pb</code>. See the docstring for <code>DebugPullback</code> for details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/debug_mode.jl#L18-L23">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.DebugRRule" href="#Mooncake.DebugRRule"><code>Mooncake.DebugRRule</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">DebugRRule(rule)</code></pre><p>Construct a callable which is equivalent to <code>rule</code>, but inserts additional type checking. In particular:</p><ul><li>check that the fdata in each argument is of the correct type for the primal</li><li>check that the fdata in the <code>CoDual</code> returned from the rule is of the correct type for the   primal.</li></ul><p>This happens recursively. For example, each element of a <code>Vector{Any}</code> is compared against each element of the associated fdata to ensure that its type is correct, as this cannot be guaranteed from the static type alone.</p><p>Some additional dynamic checks are also performed (e.g. that an fdata array of the same size as its primal).</p><p>Let <code>rule</code> return <code>y, pb!!</code>, then <code>DebugRRule(rule)</code> returns <code>y, DebugPullback(pb!!)</code>. <code>DebugPullback</code> inserts the same kind of checks as <code>DebugRRule</code>, but on the reverse-pass. See the docstring for details.</p><p><em>Note:</em> at any given point in time, the checks performed by this function constitute a necessary but insufficient set of conditions to ensure correctness. If you find that an error isn&#39;t being caught by these tests, but you believe it ought to be, please open an issue or (better still) a PR.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/debug_mode.jl#L49-L74">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.DebugRRule-Union{NTuple{N, Mooncake.CoDual}, Tuple{N}} where N" href="#Mooncake.DebugRRule-Union{NTuple{N, Mooncake.CoDual}, Tuple{N}} where N"><code>Mooncake.DebugRRule</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">(rule::DebugRRule)(x::CoDual...)</code></pre><p>Apply type checking to enforce pre- and post-conditions on <code>rule.rule</code>. See the docstring for <code>DebugRRule</code> for details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/debug_mode.jl#L81-L86">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.DefaultCtx" href="#Mooncake.DefaultCtx"><code>Mooncake.DefaultCtx</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">struct DefaultCtx end</code></pre><p>Context for all usually used AD primitives. Anything which is a primitive in a MinimalCtx is a primitive in the DefaultCtx automatically. If you are adding a rule for the sake of performance, it should be a primitive in the DefaultCtx, but not the MinimalCtx.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/contexts.jl#L10-L16">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.DynamicDerivedRule" href="#Mooncake.DynamicDerivedRule"><code>Mooncake.DynamicDerivedRule</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">DynamicDerivedRule(interp::MooncakeInterpreter, debug_mode::Bool)</code></pre><p>For internal use only.</p><p>A callable data structure which, when invoked, calls an rrule specific to the dynamic types of its arguments. Stores rules in an internal cache to avoid re-deriving.</p><p>This is used to implement dynamic dispatch.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1713-L1722">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.FData" href="#Mooncake.FData"><code>Mooncake.FData</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">FData(data::NamedTuple)</code></pre><p>The component of a <code>struct</code> which is propagated alongside the primal on the forwards-pass of AD. For example, the tangents for <code>Float64</code>s do not need to be propagated on the forwards- pass of reverse-mode AD, so any <code>Float64</code> fields of <code>Tangent</code> do not need to appear in the associated <code>FData</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L13-L20">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.InvalidFDataException" href="#Mooncake.InvalidFDataException"><code>Mooncake.InvalidFDataException</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">InvalidFDataException(msg::String)</code></pre><p>Exception indicating that there is a problem with the fdata associated to a primal.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L277-L281">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.InvalidRDataException" href="#Mooncake.InvalidRDataException"><code>Mooncake.InvalidRDataException</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">InvalidRDataException(msg::String)</code></pre><p>Exception indicating that there is a problem with the rdata associated to a primal.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L733-L737">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.LazyDerivedRule" href="#Mooncake.LazyDerivedRule"><code>Mooncake.LazyDerivedRule</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">LazyDerivedRule(interp, mi::Core.MethodInstance, debug_mode::Bool)</code></pre><p>For internal use only.</p><p>A type-stable wrapper around a <code>DerivedRule</code>, which only instantiates the <code>DerivedRule</code> when it is first called. This is useful, as it means that if a rule does not get run, it does not have to be derived.</p><p>If <code>debug_mode</code> is <code>true</code>, then the rule constructed will be a <code>DebugRRule</code>. This is useful when debugging, but should usually be switched off for production code as it (in general) incurs some runtime overhead.</p><p>Note: the signature of the primal for which this is a rule is stored in the type. The only reason to keep this around is for debugging – it is very helpful to have this type visible in the stack trace when something goes wrong, as it allows you to trivially determine which bit of your code is the culprit.</p><p><strong>Extended Help</strong></p><p>There are two main reasons why deferring the construction of a <code>DerivedRule</code> until we need to use it is crucial.</p><p>The first is to do with recursion. Consider the following function:</p><pre><code class="language-julia hljs">f(x) = x &gt; 0 ? f(x - 1) : x</code></pre><p>If we generate the <code>IRCode</code> for this function, we will see something like the following:</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode_by_type(Tuple{typeof(f), Float64})[1][1]
1 1 ─ %1  = Base.lt_float(0.0, _2)::Bool
  │   %2  = Base.or_int(%1, false)::Bool
  └──       goto #6 if not %2
  2 ─ %4  = Base.sub_float(_2, 1.0)::Float64
  │   %5  = Base.lt_float(0.0, %4)::Bool
  │   %6  = Base.or_int(%5, false)::Bool
  └──       goto #4 if not %6
  3 ─ %8  = Base.sub_float(%4, 1.0)::Float64
  │   %9  = invoke Main.f(%8::Float64)::Float64
  └──       goto #5
  4 ─       goto #5
  5 ┄ %12 = φ (#3 =&gt; %9, #4 =&gt; %4)::Float64
  └──       return %12
  6 ─       return _2</code></pre><p>Suppose that we decide to construct a <code>DerivedRule</code> immediately whenever we find an <code>:invoke</code> statement in a rule that we&#39;re currently building a <code>DerivedRule</code> for. In the above example, we produce an infinite recursion when we attempt to produce a <code>DerivedRule</code> for %9, because it has the same signature as the call which generates this IR. By instead adopting a policy of constructing a <code>LazyDerivedRule</code> whenever we encounter an <code>:invoke</code> statement, we avoid this problem.</p><p>The second reason that delaying the construction of a <code>DerivedRule</code>, is essential is that it ensures that we don&#39;t derive rules for method instances which aren&#39;t run. Suppose that function B contains code for which we can&#39;t derive a rule – perhaps it contains an unsupported language feature like a <code>PhiCNode</code> or an <code>UpsilonNode</code>. Suppose that function A contains an <code>:invoke</code> which refers to function <code>B</code>, but that this call is on a branch which deals with error handling, and doesn&#39;t get run run unless something goes wrong. By deferring the derivation of the rule for B, we only ever attempt to derive it if we land on this error handling branch. Conversely, if we attempted to derive the rule for B when we derive the rule for A, we would be unable to complete the derivation of the rule for A.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1742-L1803">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.LazyZeroRData" href="#Mooncake.LazyZeroRData"><code>Mooncake.LazyZeroRData</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">LazyZeroRData{P, Tdata}()</code></pre><p>This type is a lazy placeholder for <code>zero_like_rdata_from_type</code>. This is used to defer construction of zero data to the reverse pass. Calling <code>instantiate</code> on an instance of this will construct a zero data.</p><p>Users should construct using <code>LazyZeroRData(p)</code>, where <code>p</code> is an value of type <code>P</code>. This constructor, and <code>instantiate</code>, are specialised to minimise the amount of data which must be stored. For example, <code>Float64</code>s do not need any data, so <code>LazyZeroRData(0.0)</code> produces an instance of a singleton type, meaning that various important optimisations can be performed in AD.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L807-L819">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.MinimalCtx" href="#Mooncake.MinimalCtx"><code>Mooncake.MinimalCtx</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">struct MinimalCtx end</code></pre><p>Functions should only be primitives in this context if not making them so would cause AD to fail. In particular, do not add primitives to this context if you are writing them for performance only – instead, make these primitives in the DefaultCtx.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/contexts.jl#L1-L7">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.MutableTangent" href="#Mooncake.MutableTangent"><code>Mooncake.MutableTangent</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">MutableTangent{Tfields&lt;:NamedTuple}</code></pre><p>Default type used to represent the tangent of a <code>mutable struct</code>. See <a href="../misc_internals_notes/#tangent_type"><code>tangent_type</code></a> for more info.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L46-L51">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.NoFData" href="#Mooncake.NoFData"><code>Mooncake.NoFData</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">NoFData</code></pre><p>Singleton type which indicates that there is nothing to be propagated on the forwards-pass in addition to the primal data.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L1-L6">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.NoPullback-Union{NTuple{N, Mooncake.CoDual}, Tuple{N}} where N" href="#Mooncake.NoPullback-Union{NTuple{N, Mooncake.CoDual}, Tuple{N}} where N"><code>Mooncake.NoPullback</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">NoPullback(args::CoDual...)</code></pre><p>Construct a <code>NoPullback</code> from the arguments passed to an <code>rrule!!</code>. For each argument, extracts the primal value, and constructs a <code>LazyZeroRData</code>. These are stored in a <code>NoPullback</code> which, in the reverse-pass of AD, instantiates these <code>LazyZeroRData</code>s and returns them in order to perform the reverse-pass of AD.</p><p>The advantage of this approach is that if it is possible to construct the zero rdata element for each of the arguments lazily, the <code>NoPullback</code> generated will be a singleton type. This means that AD can avoid generating a stack to store this pullback, which can result in significant performance improvements.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/codual.jl#L97-L109">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.NoRData" href="#Mooncake.NoRData"><code>Mooncake.NoRData</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">NoRData()</code></pre><p>Nothing to propagate backwards on the reverse-pass.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L385-L389">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.NoTangent" href="#Mooncake.NoTangent"><code>Mooncake.NoTangent</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">NoTangent</code></pre><p>The type in question has no meaningful notion of a tangent space. Generally, you shouldn&#39;t use this – just let the default recursive tangent construction work. You might need to use this for <code>primitive type</code>s though.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L1-L8">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.PossiblyUninitTangent" href="#Mooncake.PossiblyUninitTangent"><code>Mooncake.PossiblyUninitTangent</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">PossiblyUninitTangent{T}</code></pre><p>Represents a <code>T</code> which maybe or may not be present. Does not distinguish between 0 and not being present.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L11-L16">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.RRuleZeroWrapper" href="#Mooncake.RRuleZeroWrapper"><code>Mooncake.RRuleZeroWrapper</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">RRuleZeroWrapper(rule)</code></pre><p>This struct is used to ensure that <code>ZeroRData</code>s, which are used as placeholder zero elements whenever an actual instance of a zero rdata for a particular primal type cannot be constructed without also having an instance of said type, never reach rules. On the pullback, we increment the cotangent dy by an amount equal to zero. This ensures that if it is a <code>ZeroRData</code>, we instead get an actual zero of the correct type. If it is not a zero rdata, the computation <em>should</em> be elided via inlining + constant prop.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L278-L287">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.SharedDataPairs" href="#Mooncake.SharedDataPairs"><code>Mooncake.SharedDataPairs</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">SharedDataPairs()</code></pre><p>A data structure used to manage the captured data in the <code>OpaqueClosures</code> which implement the bulk of the forwards- and reverse-passes of AD. An entry <code>(id, data)</code> at element <code>n</code> of the <code>pairs</code> field of this data structure means that <code>data</code> will be available at register <code>id</code> during the forwards- and reverse-passes of <code>AD</code>.</p><p>This is achieved by storing all of the data in the <code>pairs</code> field in the captured tuple which is passed to an <code>OpaqueClosure</code>, and extracting this data into registers associated to the corresponding <code>ID</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1-L12">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.Stack" href="#Mooncake.Stack"><code>Mooncake.Stack</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Stack{T}()</code></pre><p>A stack specialised for reverse-mode AD.</p><p>Semantically equivalent to a usual stack, but never de-allocates memory once allocated.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/stack.jl#L1-L7">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.Tangent" href="#Mooncake.Tangent"><code>Mooncake.Tangent</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Tangent{Tfields&lt;:NamedTuple}</code></pre><p>Default type used to represent the tangent of a <code>struct</code>. See <a href="../misc_internals_notes/#tangent_type"><code>tangent_type</code></a> for more info.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L34-L39">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.UnhandledLanguageFeatureException" href="#Mooncake.UnhandledLanguageFeatureException"><code>Mooncake.UnhandledLanguageFeatureException</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">UnhandledLanguageFeatureException(message::String)</code></pre><p>An exception used to indicate that some aspect of the Julia language which AD cannot handle has been encountered.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L232-L237">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.ZeroRData" href="#Mooncake.ZeroRData"><code>Mooncake.ZeroRData</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ZeroRData()</code></pre><p>Singleton type indicating zero-valued rdata. This should only ever appear as an intermediate quantity in the reverse-pass of AD when the type of the primal is not fully inferable, or a field of a type is abstractly typed.</p><p>If you see this anywhere in actual code, or if it appears in a hand-written rule, this is an error – please open an issue in such a situation.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/zero_like_rdata.jl#L1-L10">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__exclude_unsupported_output-Tuple{T} where T" href="#Mooncake.__exclude_unsupported_output-Tuple{T} where T"><code>Mooncake.__exclude_unsupported_output</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__exclude_unsupported_output(y)</code></pre><p>Required for the robust design of <a href="https://juliadiff.org/DifferentiationInterface.jl/DifferentiationInterface/stable/api/#DifferentiationInterface.value_and_pullback"><code>value_and_pullback</code></a>, <a href="../../interface/#Mooncake.prepare_pullback_cache"><code>prepare_pullback_cache</code></a>.   Ensures that <code>y</code> contains no aliasing, circular references, <code>Ptr</code>s or non differentiable datatypes.  In the forward pass f(args...) output can only return a &quot;Tree&quot; like datastructure with leaf nodes as primitive types.   Refer https://github.com/chalk-lab/Mooncake.jl/issues/517#issuecomment-2715202789 and related issue for details.   Internally calls <a href="#Mooncake.__exclude_unsupported_output_internal!-Union{Tuple{T}, Tuple{T, Set{UInt64}}} where T"><code>__exclude_unsupported_output_internal!</code></a>. The design is modelled after <code>zero_tangent</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interface.jl#L197-L206">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__exclude_unsupported_output_internal!-Union{Tuple{T}, Tuple{T, Set{UInt64}}} where T" href="#Mooncake.__exclude_unsupported_output_internal!-Union{Tuple{T}, Tuple{T, Set{UInt64}}} where T"><code>Mooncake.__exclude_unsupported_output_internal!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__exclude_unsupported_output_internal(y::T, address_set::Set{UInt}) where {T}</code></pre><p>For checking if output<code>y</code> is a valid Mutable/immutable composite or a primitive type. Performs a recursive depth first search over the function output <code>y</code> with an <code>isbitstype()</code> check base case. The visited memory addresses are stored inside <code>address_set</code>. If the set already contains a newly visited address, it errors out indicating an Alais or Circular reference. Also errors out if <code>y</code> is or contains a Pointer. It is called internally by <a href="#Mooncake.__exclude_unsupported_output-Tuple{T} where T"><code>__exclude_unsupported_output(y)</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interface.jl#L212-L220">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__flatten_varargs-Union{Tuple{nvargs}, Tuple{Bool, Any, Val{nvargs}}} where nvargs" href="#Mooncake.__flatten_varargs-Union{Tuple{nvargs}, Tuple{Bool, Any, Val{nvargs}}} where nvargs"><code>Mooncake.__flatten_varargs</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__flatten_varargs(isva::Bool, args, ::Val{nvargs}) where {nvargs}</code></pre><p>If isva, inputs (5.0, (4.0, 3.0)) are transformed into (5.0, 4.0, 3.0).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L969-L973">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__get_value-Tuple{Mooncake.BasicBlockCode.ID, Mooncake.BasicBlockCode.IDPhiNode}" href="#Mooncake.__get_value-Tuple{Mooncake.BasicBlockCode.ID, Mooncake.BasicBlockCode.IDPhiNode}"><code>Mooncake.__get_value</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__get_value(edge::ID, x::IDPhiNode)</code></pre><p>Helper functionality for conclude<em>rvs</em>block.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1561-L1565">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__insts_to_instruction_stream-Tuple{Vector{Any}}" href="#Mooncake.__insts_to_instruction_stream-Tuple{Vector{Any}}"><code>Mooncake.__insts_to_instruction_stream</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__insts_to_instruction_stream(insts::Vector{Any})</code></pre><p>Produces an instruction stream whose</p><ul><li><code>stmt</code> (v1.11 and up) / <code>inst</code> (v1.10) field is <code>insts</code>,</li><li><code>type</code> field is all <code>Any</code>,</li><li><code>info</code> field is all <code>Core.Compiler.NoCallInfo</code>,</li><li><code>line</code> field is all <code>Int32(1)</code>, and</li><li><code>flag</code> field is all <code>Core.Compiler.IR_FLAG_REFINED</code>.</li></ul><p>As such, if you wish to ensure that your <code>IRCode</code> prints nicely, you should ensure that its linetable field has at least one element.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L38-L50">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__pop_blk_stack!-Tuple{Mooncake.Stack{Int32}}" href="#Mooncake.__pop_blk_stack!-Tuple{Mooncake.Stack{Int32}}"><code>Mooncake.__pop_blk_stack!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__pop_blk_stack!(block_stack::BlockStack)</code></pre><p>Equivalent to <code>pop!(block_stack)</code>. Going via this function, rather than just calling <code>pop!</code> directly, makes it easy to figure out how much time is spent popping the block stack when profiling performance, and to know that this function was hit when debugging.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1697-L1703">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__push_blk_stack!-Tuple{Mooncake.Stack{Int32}, Int32}" href="#Mooncake.__push_blk_stack!-Tuple{Mooncake.Stack{Int32}, Int32}"><code>Mooncake.__push_blk_stack!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__push_blk_stack!(block_stack::BlockStack, id::Int32)</code></pre><p>Equivalent to <code>push!(block_stack, id)</code>. Going via this function, rather than just calling push! directly, is helpful for debugging and performance analysis – it makes it very straightforward to figure out much time is spent pushing to the block stack when profiling.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1355-L1361">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__switch_case-Tuple{Int32, Int32}" href="#Mooncake.__switch_case-Tuple{Int32, Int32}"><code>Mooncake.__switch_case</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__switch_case(id::Int32, predecessor_id::Int32)</code></pre><p>Helper function emitted by <code>make_switch_stmts</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1706-L1710">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__unflatten_codual_varargs-Union{Tuple{nargs}, Tuple{Bool, Any, Val{nargs}}} where nargs" href="#Mooncake.__unflatten_codual_varargs-Union{Tuple{nargs}, Tuple{Bool, Any, Val{nargs}}} where nargs"><code>Mooncake.__unflatten_codual_varargs</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__unflatten_codual_varargs(isva::Bool, args, ::Val{nargs}) where {nargs}</code></pre><p>If isva and nargs=2, then inputs <code>(CoDual(5.0, 0.0), CoDual(4.0, 0.0), CoDual(3.0, 0.0))</code> are transformed into <code>(CoDual(5.0, 0.0), CoDual((5.0, 4.0), (0.0, 0.0)))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L980-L985">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__value_and_gradient!!-Union{Tuple{N}, Tuple{R}, Tuple{R, Vararg{Mooncake.CoDual, N}}} where {R, N}" href="#Mooncake.__value_and_gradient!!-Union{Tuple{N}, Tuple{R}, Tuple{R, Vararg{Mooncake.CoDual, N}}} where {R, N}"><code>Mooncake.__value_and_gradient!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__value_and_gradient!!(rule, f::CoDual, x::CoDual...)</code></pre><p><em>Note:</em> this is not part of the public Mooncake.jl interface, and may change without warning.</p><p>Equivalent to <code>__value_and_pullback!!(rule, 1.0, f, x...)</code> – assumes <code>f</code> returns a <code>Float64</code>.</p><pre><code class="language-julia hljs"># Set up the problem.
f(x, y) = sum(x .* y)
x = [2.0, 2.0]
y = [1.0, 1.0]
rule = build_rrule(f, x, y)

# Allocate tangents. These will be written to in-place. You are free to re-use these if you
# compute gradients multiple times.
tf = zero_tangent(f)
tx = zero_tangent(x)
ty = zero_tangent(y)

# Do AD.
Mooncake.__value_and_gradient!!(
    rule, Mooncake.CoDual(f, tf), Mooncake.CoDual(x, tx), Mooncake.CoDual(y, ty)
)
# output

(4.0, (NoTangent(), [1.0, 1.0], [2.0, 2.0]))</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interface.jl#L75-L103">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.__value_and_pullback!!-Union{Tuple{T}, Tuple{N}, Tuple{R}, Tuple{R, T, Vararg{Mooncake.CoDual, N}}} where {R, N, T}" href="#Mooncake.__value_and_pullback!!-Union{Tuple{T}, Tuple{N}, Tuple{R}, Tuple{R, T, Vararg{Mooncake.CoDual, N}}} where {R, N, T}"><code>Mooncake.__value_and_pullback!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__value_and_pullback!!(rule, ȳ, f::CoDual, x::CoDual...; y_cache=nothing)</code></pre><p><em>Note:</em> this is not part of the public Mooncake.jl interface, and may change without warning.</p><p>In-place version of <code>value_and_pullback!!</code> in which the arguments have been wrapped in <code>CoDual</code>s. Note that any mutable data in <code>f</code> and <code>x</code> will be incremented in-place. As such, if calling this function multiple times with different values of <code>x</code>, should be careful to ensure that you zero-out the tangent fields of <code>x</code> each time.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interface.jl#L1-L10">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._add_to_primal" href="#Mooncake._add_to_primal"><code>Mooncake._add_to_primal</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_add_to_primal(p::P, t::T, unsafe::Bool=false) where {P, T}</code></pre><p>Adds <code>t</code> to <code>p</code>, returning a <code>P</code>. It must be the case that <code>tangent_type(P) == T</code>.</p><p>If <code>unsafe</code> is <code>true</code> and <code>P</code> is a composite type, then <code>_add_to_primal</code> will construct a new instance of <code>P</code> by directly invoking the <code>:new</code> instruction for <code>P</code>, rather than attempting to use the default constructor for <code>P</code>. This is fine if you are confident that the new <code>P</code> constructed by adding <code>t</code> to <code>p</code> will always be a valid instance of <code>P</code>, but could cause problems if you are not confident of this.</p><p>This is, for example, fine for the following type:</p><pre><code class="language-julia hljs">struct Foo{T}
    x::Vector{T}
    y::Vector{T}
    function Foo(x::Vector{T}, y::Vector{T}) where {T}
        @assert length(x) == length(y)
        return new{T}(x, y)
    end
end</code></pre><p>Here, the value returned by <code>_add_to_primal</code> will satisfy the invariant asserted in the inner constructor for <code>Foo</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L804-L828">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._add_to_primal_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Any, Mooncake.NoTangent, Bool}" href="#Mooncake._add_to_primal_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Any, Mooncake.NoTangent, Bool}"><code>Mooncake._add_to_primal_internal</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_add_to_primal_internal(c::MaybeCache, x, t, ::Bool)</code></pre><p>Implementation for <a href="#Mooncake._add_to_primal"><code>_add_to_primal</code></a>. Use <code>c</code> to handle circular referencing and aliasing correctly. If <code>c</code> is a <code>NoCache</code>, assume there is no circular references or aliasing in either <code>x</code> or <code>t</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L833-L839">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._copy_output-Tuple{Core.SimpleVector}" href="#Mooncake._copy_output-Tuple{Core.SimpleVector}"><code>Mooncake._copy_output</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_copy_output(x::T)</code></pre><p>Returns a copy of <code>x</code>, of the same type <code>T</code>. Allocates new memory for the copy. Required as Base.copy() does not work for all supported primal types. For example, <code>Base.copy</code> does not work for <code>Core.svec</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interface.jl#L312-L317">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._copy_to_output!!-Tuple{Number, Number}" href="#Mooncake._copy_to_output!!-Tuple{Number, Number}"><code>Mooncake._copy_to_output!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_copy_to_output!!(dst::T, src::T)</code></pre><p>Copy the contents of <code>src</code> to <code>dst</code>, with zero or minimal new memory allocation. The type of <code>dst</code> and <code>src</code> must be the same. Required as Base.copy!() does not work for all supported primal types. For example, <code>Base.copy!</code> does not work for <code>Core.svec</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interface.jl#L242-L247">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._diff-Union{Tuple{P}, Tuple{P, P}} where P" href="#Mooncake._diff-Union{Tuple{P}, Tuple{P, P}} where P"><code>Mooncake._diff</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_diff(p::P, q::P) where {P}</code></pre><p>Required for testing.</p><p>Computes the difference between <code>p</code> and <code>q</code>, which <em>must</em> be of the same type, <code>P</code>. Returns a tangent of type <code>tangent_type(P)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L964-L971">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._diff_internal-Union{Tuple{P}, Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, P, P}} where P" href="#Mooncake._diff_internal-Union{Tuple{P}, Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, P, P}} where P"><code>Mooncake._diff_internal</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_diff_internal(c::MaybeCache, p::P, q::P) where {P}</code></pre><p>Implmentation for <a href="#Mooncake._diff-Union{Tuple{P}, Tuple{P, P}} where P"><code>_diff</code></a>. Use <code>c</code> to correctly handle circular references and aliasing. If <code>c</code> is a <code>NoCache</code> then assume no circular references or aliasing in either <code>p</code> or <code>q</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L974-L980">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._dot-Union{Tuple{T}, Tuple{T, T}} where T" href="#Mooncake._dot-Union{Tuple{T}, Tuple{T, T}} where T"><code>Mooncake._dot</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_dot(t::T, s::T)::Float64 where {T}</code></pre><p>Required for testing. Should be defined for all standard tangent types.</p><p>Inner product between tangents <code>t</code> and <code>s</code>. Must return a <code>Float64</code>. Always available because all tangent types correspond to finite-dimensional vector spaces.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L770-L778">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._dot_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Mooncake.NoTangent, Mooncake.NoTangent}" href="#Mooncake._dot_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Mooncake.NoTangent, Mooncake.NoTangent}"><code>Mooncake._dot_internal</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_dot_internal(c::MaybeCache, t::T, s::T) where {T}</code></pre><p>Implementation for <a href="#Mooncake._dot-Union{Tuple{T}, Tuple{T, T}} where T"><code>_dot</code></a>. Use <code>c</code> to handle circular references and aliasing. If <code>c</code> is a <code>NoCache</code>, assume that neither <code>t</code> nor <code>s</code> contain either circular references or aliasing.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L781-L787">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._findall-Tuple{Any, Tuple}" href="#Mooncake._findall-Tuple{Any, Tuple}"><code>Mooncake._findall</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_findall(cond, x::Tuple)</code></pre><p>Type-stable version of <code>findall</code> for <code>Tuple</code>s. Should constant-fold if <code>cond</code> can be determined from the type of <code>x</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L70-L75">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._foreigncall_-Union{Tuple{N}, Tuple{calling_convention}, Tuple{nreq}, Tuple{RT}, Tuple{name}, Tuple{Val{name}, Val{RT}, Tuple, Val{nreq}, Val{calling_convention}, Vararg{Any, N}}} where {name, RT, nreq, calling_convention, N}" href="#Mooncake._foreigncall_-Union{Tuple{N}, Tuple{calling_convention}, Tuple{nreq}, Tuple{RT}, Tuple{name}, Tuple{Val{name}, Val{RT}, Tuple, Val{nreq}, Val{calling_convention}, Vararg{Any, N}}} where {name, RT, nreq, calling_convention, N}"><code>Mooncake._foreigncall_</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">function _foreigncall_(
    ::Val{name}, ::Val{RT}, AT::Tuple, ::Val{nreq}, ::Val{calling_convention}, x...
) where {name, RT, nreq, calling_convention}</code></pre><p>:foreigncall nodes get translated into calls to this function. For example,</p><pre><code class="language-julia hljs">Expr(:foreigncall, :foo, Tout, (A, B), nreq, :ccall, args...)</code></pre><p>becomes</p><pre><code class="language-julia hljs">_foreigncall_(Val(:foo), Val(Tout), (Val(A), Val(B)), Val(nreq), Val(:ccall), args...)</code></pre><p>Please consult the Julia documentation for more information on how foreigncall nodes work, and consult this package&#39;s tests for examples.</p><p>Credit: Umlaut.jl has the original implementation of this function. This is largely copied over from there.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/rrules/foreigncall.jl#L30-L49">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._map-Union{Tuple{N}, Tuple{F}, Tuple{F, Vararg{Any, N}}} where {F, N}" href="#Mooncake._map-Union{Tuple{N}, Tuple{F}, Tuple{F, Vararg{Any, N}}} where {F, N}"><code>Mooncake._map</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_map(f, x...)</code></pre><p>Same as <code>map</code> but requires all elements of <code>x</code> to have equal length. The usual function <code>map</code> doesn&#39;t enforce this for <code>Array</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L145-L150">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._map_if_assigned!-Union{Tuple{P}, Tuple{F}, Tuple{F, DenseArray, DenseArray{P}, DenseArray}} where {F, P}" href="#Mooncake._map_if_assigned!-Union{Tuple{P}, Tuple{F}, Tuple{F, DenseArray, DenseArray{P}, DenseArray}} where {F, P}"><code>Mooncake._map_if_assigned!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_map_if_assigned!(f::F, y::DenseArray, x1::DenseArray{P}, x2::DenseArray)</code></pre><p>Similar to the other method of <code>_map_if_assigned!</code> – for all <code>n</code>, if <code>x1[n]</code> is assigned, writes <code>f(x1[n], x2[n])</code> to <code>y[n]</code>, otherwise leaves <code>y[n]</code> unchanged.</p><p>Requires that <code>y</code>, <code>x1</code>, and <code>x2</code> have the same size.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L124-L131">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._map_if_assigned!-Union{Tuple{P}, Tuple{F}, Tuple{F, DenseArray, DenseArray{P}}} where {F, P}" href="#Mooncake._map_if_assigned!-Union{Tuple{P}, Tuple{F}, Tuple{F, DenseArray, DenseArray{P}}} where {F, P}"><code>Mooncake._map_if_assigned!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_map_if_assigned!(f, y::DenseArray, x::DenseArray{P}) where {P}</code></pre><p>For all <code>n</code>, if <code>x[n]</code> is assigned, then writes the value returned by <code>f(x[n])</code> to <code>y[n]</code>, otherwise leaves <code>y[n]</code> unchanged.</p><p>Equivalent to <code>map!(f, y, x)</code> if <code>P</code> is a bits type as element will always be assigned.</p><p>Requires that <code>y</code> and <code>x</code> have the same size.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L104-L113">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._new_-Union{Tuple{N}, Tuple{T}, Tuple{Type{T}, Vararg{Any, N}}} where {T, N}" href="#Mooncake._new_-Union{Tuple{N}, Tuple{T}, Tuple{Type{T}, Vararg{Any, N}}} where {T, N}"><code>Mooncake._new_</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_new_(::Type{T}, x::Vararg{Any, N}) where {T, N}</code></pre><p>One-liner which calls the <code>:new</code> instruction with type <code>T</code> with arguments <code>x</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L255-L259">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._scale-Tuple{Float64, Any}" href="#Mooncake._scale-Tuple{Float64, Any}"><code>Mooncake._scale</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_scale(a::Float64, t::T) where {T}</code></pre><p>Required for testing. Should be defined for all standard tangent types.</p><p>Multiply tangent <code>t</code> by scalar <code>a</code>. Always possible because any given tangent type must correspond to a vector field. Not using <code>*</code> in order to avoid piracy.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L732-L740">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._scale_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Float64, Mooncake.NoTangent}" href="#Mooncake._scale_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Float64, Mooncake.NoTangent}"><code>Mooncake._scale_internal</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_scale_internal(c::MaybeCache, a::Float64, t)</code></pre><p>Implementation for <a href="#Mooncake._scale-Tuple{Float64, Any}"><code>_scale</code></a>. Use <code>c</code> to handle circular references and aliasing in <code>t</code>. If <code>c</code> is a <code>NoCache</code> assume no circular references or aliasing in <code>c</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L743-L748">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._splat_new_-Union{Tuple{P}, Tuple{Type{P}, Tuple}} where P" href="#Mooncake._splat_new_-Union{Tuple{P}, Tuple{Type{P}, Tuple}} where P"><code>Mooncake._splat_new_</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_splat_new_(::Type{P}, x::Tuple) where {P}</code></pre><p>Function which replaces instances of <code>:splatnew</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/rrules/new.jl#L69-L73">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake._typeof-Tuple{Any}" href="#Mooncake._typeof-Tuple{Any}"><code>Mooncake._typeof</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_typeof(x)</code></pre><p>Central definition of typeof, which is specific to the use-required in this package.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L1-L5">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.ad_stmt_info-Tuple{Mooncake.BasicBlockCode.ID, Union{Nothing, Mooncake.BasicBlockCode.ID}, Any, Any}" href="#Mooncake.ad_stmt_info-Tuple{Mooncake.BasicBlockCode.ID, Union{Nothing, Mooncake.BasicBlockCode.ID}, Any, Any}"><code>Mooncake.ad_stmt_info</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ad_stmt_info(line::ID, comms_id::Union{ID, Nothing}, fwds, rvs)</code></pre><p>Convenient constructor for <code>ADStmtInfo</code>. If either <code>fwds</code> or <code>rvs</code> is not a vector, <code>__vec</code> promotes it to a single-element <code>Vector</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L327-L332">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.add_data!-Tuple{Mooncake.ADInfo, Any}" href="#Mooncake.add_data!-Tuple{Mooncake.ADInfo, Any}"><code>Mooncake.add_data!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">add_data!(info::ADInfo, data)::ID</code></pre><p>Equivalent to <code>add_data!(info.shared_data_pairs, data)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L201-L205">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.add_data!-Tuple{Mooncake.SharedDataPairs, Any}" href="#Mooncake.add_data!-Tuple{Mooncake.SharedDataPairs, Any}"><code>Mooncake.add_data!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">add_data!(p::SharedDataPairs, data)::ID</code></pre><p>Puts <code>data</code> into <code>p</code>, and returns the <code>id</code> associated to it. This <code>id</code> should be assumed to be available during the forwards- and reverse-passes of AD, and it should further be assumed that the value associated to this <code>id</code> is always <code>data</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L18-L24">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.add_data_if_not_singleton!-Tuple{Union{Mooncake.ADInfo, Mooncake.SharedDataPairs}, Any}" href="#Mooncake.add_data_if_not_singleton!-Tuple{Union{Mooncake.ADInfo, Mooncake.SharedDataPairs}, Any}"><code>Mooncake.add_data_if_not_singleton!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">add_data_if_not_singleton!(p::Union{ADInfo, SharedDataPairs}, x)</code></pre><p>Returns <code>x</code> if it is a singleton, or the <code>ID</code> of the ssa which will contain it on the forwards- and reverse-passes. The reason for this is that if something is a singleton, it can be inserted directly into the IR.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L208-L214">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.always_initialised-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.always_initialised-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.always_initialised</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">always_initialised(::Type{P}) where {P}</code></pre><p>Returns a tuple with number of fields equal to the number of fields in <code>P</code>. The nth field is set to <code>true</code> if the nth field of <code>P</code> is initialised, and <code>false</code> otherwise.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L204-L209">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.arrayify-Union{Tuple{Mooncake.CoDual{A}}, Tuple{A}} where A&lt;:(AbstractArray{&lt;:Union{Float32, Float64, ComplexF64, ComplexF32}})" href="#Mooncake.arrayify-Union{Tuple{Mooncake.CoDual{A}}, Tuple{A}} where A&lt;:(AbstractArray{&lt;:Union{Float32, Float64, ComplexF64, ComplexF32}})"><code>Mooncake.arrayify</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">arrayify(x::CoDual{&lt;:AbstractArray{&lt;:BlasFloat}})</code></pre><p>Return the primal field of <code>x</code>, and convert its fdata into an array of the same type as the primal. This operation is not guaranteed to be possible for all array types, but seems to be possible for all array types of interest so far.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/rrules/blas.jl#L29-L35">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.build_primitive_rrule-Tuple{Type{&lt;:Tuple}}" href="#Mooncake.build_primitive_rrule-Tuple{Type{&lt;:Tuple}}"><code>Mooncake.build_primitive_rrule</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">build_primitive_rrule(sig::Type{&lt;:Tuple})</code></pre><p>Construct an rrule for signature <code>sig</code>. For this function to be called in <code>build_rrule</code>, you must also ensure that <code>is_primitive(context_type, sig)</code> is <code>true</code>. The callable returned by this must obey the rrule interface, but there are no restrictions on the type of callable itself. For example, you might return a callable <code>struct</code>. By default, this function returns <code>rrule!!</code> so, most of the time, you should just implement a method of <code>rrule!!</code>.</p><p><strong>Extended Help</strong></p><p>The purpose of this function is to permit computation at rule construction time, which can be re-used at runtime. For example, you might wish to derive some information from <code>sig</code> which you use at runtime (e.g. the fdata type of one of the arguments). While constant propagation will often optimise this kind of computation away, it will sometimes fail to do so in hard-to-predict circumstances. Consequently, if you need certain computations not to happen at runtime in order to guarantee good performance, you might wish to e.g. emit a callable <code>struct</code> with type parameters which are the result of this computation. In this context, the motivation for using this function is the same as that of using staged programming (e.g. via <code>@generated</code> functions) more generally.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/Mooncake.jl#L70-L90">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.build_rrule-Tuple" href="#Mooncake.build_rrule-Tuple"><code>Mooncake.build_rrule</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">build_rrule(args...; kwargs...)</code></pre><p>Helper method: equivalent to extracting the signature from <code>args</code> and calling <code>build_rrule(sig; kwargs...)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1038-L1043">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.build_rrule-Tuple{Type{&lt;:Tuple}}" href="#Mooncake.build_rrule-Tuple{Type{&lt;:Tuple}}"><code>Mooncake.build_rrule</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">build_rrule(sig::Type{&lt;:Tuple}; kwargs...)</code></pre><p>Helper method: Equivalent to <code>build_rrule(Mooncake.get_interpreter(), sig; kwargs...)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1049-L1053">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.build_rrule-Union{Tuple{C}, Tuple{Mooncake.MooncakeInterpreter{C}, Any}} where C" href="#Mooncake.build_rrule-Union{Tuple{C}, Tuple{Mooncake.MooncakeInterpreter{C}, Any}} where C"><code>Mooncake.build_rrule</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">build_rrule(interp::MooncakeInterpreter{C}, sig_or_mi; debug_mode=false) where {C}</code></pre><p>Returns a <code>DerivedRule</code> which is an <code>rrule!!</code> for <code>sig_or_mi</code> in context <code>C</code>. See the docstring for <code>rrule!!</code> for more info.</p><p>If <code>debug_mode</code> is <code>true</code>, then all calls to rules are replaced with calls to <code>DebugRRule</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1069-L1076">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.can_produce_zero_rdata_from_type-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.can_produce_zero_rdata_from_type-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.can_produce_zero_rdata_from_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">can_produce_zero_rdata_from_type(::Type{P}) where {P}</code></pre><p>Returns whether or not the zero element of the rdata type for primal type <code>P</code> can be obtained from <code>P</code> alone.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L616-L621">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.codual_type-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.codual_type-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.codual_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">codual_type(P::Type)</code></pre><p>The type of the <code>CoDual</code> which contains instances of <code>P</code> and associated tangents.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/codual.jl#L53-L57">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.comms_channel-Tuple{Mooncake.ADStmtInfo}" href="#Mooncake.comms_channel-Tuple{Mooncake.ADStmtInfo}"><code>Mooncake.comms_channel</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">comms_channel(info::ADStmtInfo)</code></pre><p>Return the element of <code>fwds</code> whose <code>ID</code> is the communcation <code>ID</code>. Returns <code>Nothing</code> if <code>comms_id</code> is <code>nothing</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L345-L350">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.conclude_rvs_block-Tuple{Mooncake.BasicBlockCode.BBlock, Vector{Mooncake.BasicBlockCode.ID}, Bool, Mooncake.ADInfo}" href="#Mooncake.conclude_rvs_block-Tuple{Mooncake.BasicBlockCode.BBlock, Vector{Mooncake.BasicBlockCode.ID}, Bool, Mooncake.ADInfo}"><code>Mooncake.conclude_rvs_block</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">conclude_rvs_block(
    blk::BBlock, pred_ids::Vector{ID}, pred_is_unique_pred::Bool, info::ADInfo
)</code></pre><p>Generates code which is inserted at the end of each counterpart block in the reverse-pass. Handles phi nodes, and choosing the correct next block to switch to.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1522-L1529">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.const_ad_stmt-Tuple{Any, Mooncake.BasicBlockCode.ID, Mooncake.ADInfo}" href="#Mooncake.const_ad_stmt-Tuple{Any, Mooncake.BasicBlockCode.ID, Mooncake.ADInfo}"><code>Mooncake.const_ad_stmt</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">const_ad_stmt(stmt, line::ID, info::ADInfo)</code></pre><p>Implementation of <code>make_ad_stmts!</code> used for constants.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L555-L559">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.const_codual-Tuple{Any, Mooncake.ADInfo}" href="#Mooncake.const_codual-Tuple{Any, Mooncake.ADInfo}"><code>Mooncake.const_codual</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">const_codual(stmt, info::ADInfo)</code></pre><p>Build a <code>CoDual</code> from <code>stmt</code>, with zero / uninitialised fdata. If the resulting CoDual is a bits type, then it is returned. If it is not, then the CoDual is put into shared data, and the ID associated to it in the forwards- and reverse-passes returned.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L579-L585">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.const_codual_stmt-Tuple{Any, Mooncake.ADInfo}" href="#Mooncake.const_codual_stmt-Tuple{Any, Mooncake.ADInfo}"><code>Mooncake.const_codual_stmt</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">const_codual_stmt(stmt, info::ADInfo)</code></pre><p>Returns a <code>:call</code> expression which will return a <code>CoDual</code> whose primal is <code>stmt</code>, and whose tangent is whatever <code>uninit_tangent</code> returns.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L564-L569">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.const_prop_gotoifnots!-Tuple{Core.Compiler.IRCode}" href="#Mooncake.const_prop_gotoifnots!-Tuple{Core.Compiler.IRCode}"><code>Mooncake.const_prop_gotoifnots!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">const_prop_gotoifnots(ir::IRCode)</code></pre><p>Replace all occurences in <code>ir</code> of <code>goto %n if not true</code> in block <code>b</code> with a <code>goto b + 1</code>, and all occurences of <code>goto %n if not false</code> with <code>goto n</code>, and make the adjustments to <code>ir</code> that this necessitates.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L408-L414">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.create_comms_insts!-Tuple{Vector{Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.ADStmtInfo}}}, Mooncake.ADInfo}" href="#Mooncake.create_comms_insts!-Tuple{Vector{Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.ADStmtInfo}}}, Mooncake.ADInfo}"><code>Mooncake.create_comms_insts!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">create_comms_insts!(ad_stmts_blocks::ADStmts, info::ADInfo)</code></pre><p>This function produces code which can be inserted into the forwards-pass and reverse-pass at specific locations to implement the promise associated to the <code>comms_id</code> field of the <code>ADStmtInfo</code> type – namely that if you assign a value to <code>comms_id</code> on the forwards-pass, the same value will be available at <code>comms_id</code> on the reverse-pass.</p><p>For each basic block represented in <code>ADStmts</code>:</p><ol><li>create a stack containing a <code>Tuple</code> which can hold all of the values associated to the  <code>comms_id</code>s for each statement. Put this stack in shared data.</li><li>create instructions which can be inserted at the <em>end</em> of the block generated to perform  the forwards-pass (in <code>forwards_pass_ir</code>) which will put all of the data associated to  the <code>comms_id</code>s into shared data, and</li><li>create instruction which can be inserted at the <em>start</em> of the block generated to perform  the reverse-pass (in <code>pullback_ir</code>), which will extract all of the data put into  shared data by the instructions generated by the previous point, and assigned them to  the <code>comms_id</code>s.</li></ol><p>Returns two a <code>Tuple{Vector{IDInstPair}, Vector{IDInstPair}</code>. The nth element of each <code>Vector</code> corresponds to the instructions to be inserted into the forwards- and reverse passes resp. for the nth block in <code>ad_stmts_blocks</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1225-L1247">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.deref_and_zero_stmts-Tuple{Any, Any, Any}" href="#Mooncake.deref_and_zero_stmts-Tuple{Any, Any, Any}"><code>Mooncake.deref_and_zero_stmts</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">deref_and_zero_stmts(P, ref_id, val_id)</code></pre><p>Equivalent to something like</p><pre><code class="language-julia hljs">val = ref[]
ref[] = zero_rdata_from_type(P)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1572-L1580">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.fcodual_type-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.fcodual_type-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.fcodual_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fcodual_type(P::Type)</code></pre><p>The type of the <code>CoDual</code> which contains instances of <code>P</code> and its fdata.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/codual.jl#L64-L68">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.fdata-Tuple{T} where T" href="#Mooncake.fdata-Tuple{T} where T"><code>Mooncake.fdata</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fdata(t)::fdata_type(typeof(t))</code></pre><p>Extract the forwards data from tangent <code>t</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L240-L244">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.fdata_field_type-Union{Tuple{P}, Tuple{Type{P}, Int64}} where P" href="#Mooncake.fdata_field_type-Union{Tuple{P}, Tuple{Type{P}, Int64}} where P"><code>Mooncake.fdata_field_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fdata_field_type(::Type{P}, n::Int) where {P}</code></pre><p>Returns the type of to the nth field of the fdata type associated to <code>P</code>. Will be a <code>PossiblyUninitTangent</code> if said field can be undefined.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L228-L233">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.fdata_type-Tuple{Any}" href="#Mooncake.fdata_type-Tuple{Any}"><code>Mooncake.fdata_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fdata_type(T)</code></pre><p>Returns the type of the forwards data associated to a tangent of type <code>T</code>.</p><p><strong>Extended help</strong></p><p>Rules in Mooncake.jl do not operate on tangents directly. Rather, functionality is defined to split each tangent into two components, that we call <em>fdata</em> (forwards-pass data) and <em>rdata</em> (reverse-pass data). In short, any component of a tangent which is identified by its address (e.g. a <code>mutable struct</code>s or an <code>Array</code>) gets passed around on the forwards-pass of AD and is incremented in-place on the reverse-pass, while components of tangents identified by their value get propagated and accumulated only on the reverse-pass.</p><p>Given a tangent type <code>T</code>, you can find out what type its fdata and rdata must be with <code>fdata_type(T)</code> and <code>rdata_type(T)</code> respectively. A consequence of this is that there is exactly one valid fdata type and rdata type for each primal type.</p><p>Given a tangent <code>t</code>, you can get its fdata and rdata using <code>f = fdata(t)</code> and <code>r = rdata(t)</code> respectively. <code>f</code> and <code>r</code> can be re-combined to recover the original tangent using the binary version of <code>tangent</code>: <code>tangent(f, r)</code>. It must always hold that</p><pre><code class="language-julia hljs">tangent(fdata(t), rdata(t)) === t</code></pre><p>The need for all of this is explained in the docs, but for now it suffices to consider our running examples again, and to see what their fdata and rdata look like.</p><p><strong>Int</strong></p><p><code>Int</code>s are non-differentiable types, so there is nothing to pass around on the forwards- or reverse-pass. Therefore</p><pre><code class="language-julia-repl hljs">julia&gt; fdata_type(tangent_type(Int)), rdata_type(tangent_type(Int))
(NoFData, NoRData)</code></pre><p><strong>Float64</strong></p><p>The tangent type of <code>Float64</code> is <code>Float64</code>. <code>Float64</code>s are identified by their value / have no fixed address, so</p><pre><code class="language-julia-repl hljs">julia&gt; (fdata_type(Float64), rdata_type(Float64))
(NoFData, Float64)</code></pre><p><strong>Vector{Float64}</strong></p><p>The tangent type of <code>Vector{Float64}</code> is <code>Vector{Float64}</code>. A <code>Vector{Float64}</code> is identified by its address, so</p><pre><code class="language-julia-repl hljs">julia&gt; (fdata_type(Vector{Float64}), rdata_type(Vector{Float64}))
(Vector{Float64}, NoRData)</code></pre><p><strong>Tuple{Float64, Vector{Float64}, Int}</strong></p><p>This is an example of a type which has both fdata and rdata. The tangent type for <code>Tuple{Float64, Vector{Float64}, Int}</code> is <code>Tuple{Float64, Vector{Float64}, NoTangent}</code>. <code>Tuple</code>s have no fixed memory address, so we interogate each field on its own. We have already established the fdata and rdata types for each element, so we recurse to obtain:</p><pre><code class="language-julia-repl hljs">julia&gt; T = tangent_type(Tuple{Float64, Vector{Float64}, Int})
Tuple{Float64, Vector{Float64}, NoTangent}

julia&gt; (fdata_type(T), rdata_type(T))
(Tuple{NoFData, Vector{Float64}, NoFData}, Tuple{Float64, NoRData, NoRData})</code></pre><p>The zero tangent for <code>(5.0, [5.0])</code> is <code>t = (0.0, [0.0])</code>. <code>fdata(t)</code> returns <code>(NoFData(), [0.0])</code>, where the second element is <code>===</code> to the second element of <code>t</code>. <code>rdata(t)</code> returns <code>(0.0, NoRData())</code>. In this example, <code>t</code> contains a mixture of data, some of which is identified by its value, and some of which is identified by its address, so there is some fdata and some rdata.</p><p><strong>Structs</strong></p><p>Structs are handled in more-or-less the same way as <code>Tuple</code>s, albeit with the possibility of undefined fields needing to be explicitly handled. For example, a struct such as</p><pre><code class="language-julia-repl hljs">julia&gt; struct Foo
           x::Float64
           y
           z::Int
       end</code></pre><p>has tangent type</p><pre><code class="language-julia-repl hljs">julia&gt; tangent_type(Foo)
Tangent{@NamedTuple{x::Float64, y, z::NoTangent}}</code></pre><p>Its fdata and rdata are given by special <code>FData</code> and <code>RData</code> types:</p><pre><code class="language-julia-repl hljs">julia&gt; (fdata_type(tangent_type(Foo)), rdata_type(tangent_type(Foo)))
(Mooncake.FData{@NamedTuple{x::NoFData, y, z::NoFData}}, Mooncake.RData{@NamedTuple{x::Float64, y, z::NoRData}})</code></pre><p>Practically speaking, <code>FData</code> and <code>RData</code> both have the same structure as <code>Tangent</code>s and are just used in different contexts.</p><p><strong>Mutable Structs</strong></p><p>The fdata for a <code>mutable struct</code>s is its tangent, and it has no rdata. This is because <code>mutable struct</code>s have fixed memory addresses, and can therefore be incremented in-place. For example,</p><pre><code class="language-julia-repl hljs">julia&gt; mutable struct Bar
           x::Float64
           y
           z::Int
       end</code></pre><p>has tangent type</p><pre><code class="language-julia-repl hljs">julia&gt; tangent_type(Bar)
MutableTangent{@NamedTuple{x::Float64, y, z::NoTangent}}</code></pre><p>and fdata / rdata types</p><pre><code class="language-julia-repl hljs">julia&gt; (fdata_type(tangent_type(Bar)), rdata_type(tangent_type(Bar)))
(MutableTangent{@NamedTuple{x::Float64, y, z::NoTangent}}, NoRData)</code></pre><p><strong>Primitive Types</strong></p><p>As with tangents, each primitive type must specify what its fdata and rdata is. See specific examples for details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L33-L153">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.fix_up_invoke_inference!-Tuple{Core.Compiler.IRCode}" href="#Mooncake.fix_up_invoke_inference!-Tuple{Core.Compiler.IRCode}"><code>Mooncake.fix_up_invoke_inference!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fix_up_invoke_inference!(ir::IRCode)</code></pre><p><strong>The Problem</strong></p><p>Consider the following:</p><pre><code class="language-julia hljs">@noinline function bar!(x)
    x .*= 2
end

function foo!(x)
    bar!(x)
    return nothing
end</code></pre><p>In this case, the IR associated to <code>Tuple{typeof(foo), Vector{Float64}}</code> will be something along the lines of</p><pre><code class="language-julia hljs">julia&gt; Base.code_ircode_by_type(Tuple{typeof(foo), Vector{Float64}})
1-element Vector{Any}:
2 1 ─     invoke Main.bar!(_2::Vector{Float64})::Any
3 └──     return Main.nothing
   =&gt; Nothing</code></pre><p>Observe that the type inferred for the first line is <code>Any</code>. Inference is at liberty to do this without any risk of performance problems because the first line is not used anywhere else in the function. Had this line been used elsewhere in the function, inference would have inferred its type to be <code>Vector{Float64}</code>.</p><p>This causes performance problems for Mooncake, because it uses the return type to do various things, including allocating storage for quantities required on the reverse-pass. Consequently, inference infering <code>Any</code> rather than <code>Vector{Float64}</code> causes type instabilities in the code that Mooncake generates, which can have catastrophic conseqeuences for performance.</p><p><strong>The Solution</strong></p><p><code>:invoke</code> expressions contain the <code>Core.MethodInstance</code> associated to them, which contains a <code>Core.CodeCache</code>, which contains the return type of the <code>:invoke</code>. This function looks for <code>:invoke</code> statements whose return type is inferred to be <code>Any</code> in <code>ir</code>, and modifies it to be the return type given by the code cache.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L75-L117">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.flat_product-Tuple" href="#Mooncake.flat_product-Tuple"><code>Mooncake.flat_product</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">flat_product(xs...)</code></pre><p>Equivalent to <code>vec(collect(Iterators.product(xs...)))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L264-L268">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.foreigncall_to_call-Tuple{Any, Dict{Symbol, Core.Compiler.VarState}}" href="#Mooncake.foreigncall_to_call-Tuple{Any, Dict{Symbol, Core.Compiler.VarState}}"><code>Mooncake.foreigncall_to_call</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">foreigncall_to_call(inst, sp_map::Dict{Symbol, CC.VarState})</code></pre><p>If <code>inst</code> is a <code>:foreigncall</code> expression translate it into an equivalent <code>:call</code> expression. If anything else, just return <code>inst</code>. See <code>Mooncake._foreigncall_</code> for details.</p><p><code>sp_map</code> maps the names of the static parameters to their values. This function is intended to be called in the context of an <code>IRCode</code>, in which case the values of <code>sp_map</code> are given by the <code>sptypes</code> field of said <code>IRCode</code>. The keys should generally be obtained from the <code>Method</code> from which the <code>IRCode</code> is derived. See <code>Mooncake.normalise!</code> for more details.</p><p>The purpose of this transformation is to make it possible to differentiate <code>:foreigncall</code> expressions in the same way as a primitive <code>:call</code> expression, i.e. via an <code>rrule!!</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L130-L143">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.forwards_pass_ir-Tuple{Mooncake.BasicBlockCode.BBCode, Vector{Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.ADStmtInfo}}}, Any, Mooncake.ADInfo, Any}" href="#Mooncake.forwards_pass_ir-Tuple{Mooncake.BasicBlockCode.BBCode, Vector{Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.ADStmtInfo}}}, Any, Mooncake.ADInfo, Any}"><code>Mooncake.forwards_pass_ir</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">forwards_pass_ir(ir::BBCode, ad_stmts_blocks::ADStmts, info::ADInfo, Tshared_data)</code></pre><p>Produce the IR associated to the <code>OpaqueClosure</code> which runs most of the forwards-pass.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1286-L1290">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.fwd_ir-Tuple{Type{&lt;:Tuple}}" href="#Mooncake.fwd_ir-Tuple{Type{&lt;:Tuple}}"><code>Mooncake.fwd_ir</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">fwd_ir(
    sig::Type{&lt;:Tuple};
    interp=get_interpreter(), debug_mode::Bool=false, do_inline::Bool=true
)::IRCode</code></pre><div class="admonition is-warning" id="Warning-6c69d6c3ca4ceb0b"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-6c69d6c3ca4ceb0b" title="Permalink"></a></header><div class="admonition-body"><p>This is not part of the public interface of Mooncake. As such, it may change as part of a non-breaking release of the package.</p></div></div><p>Generate the <code>Core.Compiler.IRCode</code> used to construct the forwards-pass of AD. Take a look at how <code>build_rrule</code> makes use of <code>generate_ir</code> to see exactly how this is used in practice.</p><p>For example, if you wanted to get the IR associated to the forwards pass for the call <code>map(sin, randn(10))</code>, you could do either of the following:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.fwd_ir(Tuple{typeof(map), typeof(sin), Vector{Float64}}) isa Core.Compiler.IRCode
true
julia&gt; Mooncake.fwd_ir(typeof((map, sin, randn(10)))) isa Core.Compiler.IRCode
true</code></pre><p><strong>Arguments</strong></p><ul><li><code>sig::Type{&lt;:Tuple}</code>: the signature of the call to be differentiated.</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>interp</code>: the interpreter to use to obtain the primal IR.</li><li><code>debug_mode::Bool</code>: whether the generated IR should make use of Mooncake&#39;s debug mode.</li><li><code>do_inline::Bool</code>: whether to apply an inlining pass prior to returning the ir generated   by this function. This is <code>true</code> by default, but setting it to <code>false</code> can sometimes be   helpful if you need to understand what function calls are generated in order to perform   AD, before lots of it gets inlined away.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/developer_tools.jl#L24-L56">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.gc_preserve-Tuple" href="#Mooncake.gc_preserve-Tuple"><code>Mooncake.gc_preserve</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">gc_preserve(xs...)</code></pre><p>A no-op function. Its <code>rrule!!</code> ensures that the memory associated to <code>xs</code> is not freed until the pullback that it returns is run.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L342-L347">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.generate_ir-Tuple{Mooncake.MooncakeInterpreter, Any}" href="#Mooncake.generate_ir-Tuple{Mooncake.MooncakeInterpreter, Any}"><code>Mooncake.generate_ir</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">generate_ir(
    interp::MooncakeInterpreter, sig_or_mi; debug_mode=false, do_inline=true
)</code></pre><p>Used by <code>build_rrule</code>, and the various debugging tools: primal<em>ir, fwds</em>ir, adjoint_ir.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1143-L1148">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.get_const_primal_value-Tuple{GlobalRef}" href="#Mooncake.get_const_primal_value-Tuple{GlobalRef}"><code>Mooncake.get_const_primal_value</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_const_primal_value(x::GlobalRef)</code></pre><p>Get the value associated to <code>x</code>. For <code>GlobalRef</code>s, verify that <code>x</code> is indeed a constant.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L611-L615">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.get_interpreter-Tuple{}" href="#Mooncake.get_interpreter-Tuple{}"><code>Mooncake.get_interpreter</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_interpreter()</code></pre><p>Returns a <code>MooncakeInterpreter</code> appropriate for the current world age. Will use a cached interpreter if one already exists for the current world age, otherwise creates a new one.</p><p>This should be prefered over constructing a <code>MooncakeInterpreter</code> directly.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/abstract_interpretation.jl#L205-L212">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.get_primal_type-Tuple{Mooncake.ADInfo, Core.Argument}" href="#Mooncake.get_primal_type-Tuple{Mooncake.ADInfo, Core.Argument}"><code>Mooncake.get_primal_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_primal_type(info::ADInfo, x)</code></pre><p>Returns the static / inferred type associated to <code>x</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L226-L230">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.get_rev_data_id-Tuple{Mooncake.ADInfo, Core.Argument}" href="#Mooncake.get_rev_data_id-Tuple{Mooncake.ADInfo, Core.Argument}"><code>Mooncake.get_rev_data_id</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_rev_data_id(info::ADInfo, x)</code></pre><p>Returns the <code>ID</code> associated to the line in the reverse pass which will contain the reverse data for <code>x</code>. If <code>x</code> is not an <code>Argument</code> or <code>ID</code>, then <code>nothing</code> is returned.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L243-L248">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.get_tangent_field-Tuple{Union{Mooncake.MutableTangent{T}, Mooncake.Tangent{T}} where T, Int64}" href="#Mooncake.get_tangent_field-Tuple{Union{Mooncake.MutableTangent{T}, Mooncake.Tangent{T}} where T, Int64}"><code>Mooncake.get_tangent_field</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_tangent_field(t::Union{MutableTangent, Tangent}, i::Int)</code></pre><p>Gets the <code>i</code>th field of data in <code>t</code>.</p><p>Has the same semantics that <code>getfield!</code> would have if the data in the <code>fields</code> field of <code>t</code> were actually fields of <code>t</code>. This is the moral equivalent of <code>getfield</code> for <code>MutableTangent</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L71-L79">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.inc_args-Tuple{Expr}" href="#Mooncake.inc_args-Tuple{Expr}"><code>Mooncake.inc_args</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">inc_args(stmt)</code></pre><p>Increment by <code>1</code> the <code>n</code> field of any <code>Argument</code>s present in <code>stmt</code>. Used in <code>make_ad_stmts!</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L356-L361">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.increment!!-Union{Tuple{T}, Tuple{T, T}} where T" href="#Mooncake.increment!!-Union{Tuple{T}, Tuple{T, T}} where T"><code>Mooncake.increment!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">increment!!(x::T, y::T) where {T}</code></pre><p>Add <code>x</code> to <code>y</code>. If <code>ismutabletype(T)</code>, then <code>increment!!(x, y) === x</code> must hold. That is, <code>increment!!</code> will mutate <code>x</code>. This must apply recursively if <code>T</code> is a composite type whose fields are mutable.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L655-L661">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.increment_and_get_rdata!-Union{Tuple{T}, Tuple{Mooncake.NoFData, T, T}} where T&lt;:Union{Float16, Float32, Float64}" href="#Mooncake.increment_and_get_rdata!-Union{Tuple{T}, Tuple{Mooncake.NoFData, T, T}} where T&lt;:Union{Float16, Float32, Float64}"><code>Mooncake.increment_and_get_rdata!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">increment_and_get_rdata!(fdata, zero_rdata, cr_tangent)</code></pre><p>Increment <code>fdata</code> by the fdata component of the ChainRules.jl-style tangent, <code>cr_tangent</code>, and return the rdata component of <code>cr_tangent</code> by adding it to <code>zero_rdata</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tools_for_rules.jl#L245-L250">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.increment_field!!-Union{Tuple{i}, Tuple{Tuple, Any, Val{i}}} where i" href="#Mooncake.increment_field!!-Union{Tuple{i}, Tuple{Tuple, Any, Val{i}}} where i"><code>Mooncake.increment_field!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">increment_field!!(x::T, y::V, f) where {T, V}</code></pre><p><code>increment!!</code> the field <code>f</code> of <code>x</code> by <code>y</code>, and return the updated <code>x</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L1035-L1039">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.increment_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent, Mooncake.NoTangent}" href="#Mooncake.increment_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent, Mooncake.NoTangent}"><code>Mooncake.increment_internal!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">increment_internal!!(c::IncCache, x::T, y::T) where {T}</code></pre><p>Implementation of <a href="#Mooncake.increment!!-Union{Tuple{T}, Tuple{T, T}} where T"><code>Mooncake.increment!!</code></a>. Make use the cache <code>c</code> to avoid &quot;double counting&quot;. If <code>c</code> is a <code>NoCache</code>, assume no aliasing or circular referencing.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L666-L671">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.increment_rdata!!-Union{Tuple{T}, Tuple{T, Any}} where T" href="#Mooncake.increment_rdata!!-Union{Tuple{T}, Tuple{T, Any}} where T"><code>Mooncake.increment_rdata!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">increment_rdata!!(t::T, r)::T where {T}</code></pre><p>Increment the rdata component of tangent <code>t</code> by <code>r</code>, and return the updated tangent. Useful for implementation getfield-like rules for mutable structs, pointers, dicts, etc.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L977-L982">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.increment_ref_stmts-Tuple{Mooncake.BasicBlockCode.ID, Any}" href="#Mooncake.increment_ref_stmts-Tuple{Mooncake.BasicBlockCode.ID, Any}"><code>Mooncake.increment_ref_stmts</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">increment_ref_stmts(ref_id::ID, inc_data)::Vector{IDInstPair}</code></pre><p>Equivalent to <code>ref[] = increment!!(ref[], inc_data)</code>, where <code>ref</code> and <code>inc_data</code> are the values associated to <code>ref_id</code> and <code>inc_data</code> respectively.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L850-L855">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.infer_ir!-Tuple{Core.Compiler.IRCode}" href="#Mooncake.infer_ir!-Tuple{Core.Compiler.IRCode}"><code>Mooncake.infer_ir!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">infer_ir!(ir::IRCode) -&gt; IRCode</code></pre><p>Runs type inference on <code>ir</code>, which mutates <code>ir</code>, and returns it.</p><p>Note: the compiler will not infer the types of anything where the corrsponding element of <code>ir.stmts.flag</code> is not set to <code>Core.Compiler.IR_FLAG_REFINED</code>. Nor will it attempt to refine the type of the value returned by a <code>:invoke</code> expressions. Consequently, if you find that the types in your IR are not being refined, you may wish to check that neither of these things are happening.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L61-L71">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.interpolate_boundschecks!-Tuple{Core.Compiler.IRCode}" href="#Mooncake.interpolate_boundschecks!-Tuple{Core.Compiler.IRCode}"><code>Mooncake.interpolate_boundschecks!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">interpolate_boundschecks!(ir::IRCode)</code></pre><p>For every <code>x = Expr(:boundscheck, value)</code> in <code>ir</code>, interpolate <code>value</code> into all uses of <code>x</code>. This is only required in order to ensure that literal versions of memoryrefget, memoryrefset!, getfield, and setfield! work effectively. If they are removed through improvements to the way that we handle constant propagation inside Mooncake, then this functionality can be removed.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L47-L55">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.intrinsic_to_function-Tuple{Any}" href="#Mooncake.intrinsic_to_function-Tuple{Any}"><code>Mooncake.intrinsic_to_function</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">intrinsic_to_function(inst)</code></pre><p>If <code>inst</code> is a <code>:call</code> expression to a <code>Core.IntrinsicFunction</code>, replace it with a call to the corresponding <code>function</code> from <code>Mooncake.IntrinsicsWrappers</code>, else return <code>inst</code>.</p><p><code>cglobal</code> is a special case – it requires that its first argument be static in exactly the same way as <code>:foreigncall</code>. See <code>IntrinsicsWrappers.__cglobal</code> for more info.</p><p>The purpose of this transformation is to make it possible to use dispatch to write rules for intrinsic calls using dispatch in a type-stable way. See <a href="#Mooncake.IntrinsicsWrappers"><code>IntrinsicsWrappers</code></a> for more context.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L231-L243">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.ircode" href="#Mooncake.ircode"><code>Mooncake.ircode</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ircode(
    inst::Vector{Any},
    argtypes::Vector{Any},
    sptypes::Vector{CC.VarState}=CC.VarState[],
) -&gt; IRCode</code></pre><p>Constructs an instance of an <code>IRCode</code>. This is useful for constructing test cases with known properties.</p><p>No optimisations or type inference are performed on the resulting <code>IRCode</code>, so that the <code>IRCode</code> contains exactly what is intended by the caller. Please make use of <code>infer_types!</code> if you require the types to be inferred.</p><p>Edges in <code>PhiNode</code>s, <code>GotoIfNot</code>s, and <code>GotoNode</code>s found in <code>inst</code> must refer to lines (as in <code>CodeInfo</code>). In the <code>IRCode</code> returned by this function, these line references are translated into block references.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L9-L26">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_always_fully_initialised-Tuple{DataType}" href="#Mooncake.is_always_fully_initialised-Tuple{DataType}"><code>Mooncake.is_always_fully_initialised</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_always_fully_initialised(P::DataType)::Bool</code></pre><p>True if all fields in <code>P</code> are always initialised. Put differently, there are no inner constructors which permit partial initialisation.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L227-L232">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_always_initialised-Tuple{DataType, Int64}" href="#Mooncake.is_always_initialised-Tuple{DataType, Int64}"><code>Mooncake.is_always_initialised</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_always_initialised(P::DataType, n::Int)::Bool</code></pre><p>True if the <code>n</code>th field of <code>P</code> is always initialised. If the <code>n</code>th fieldtype of <code>P</code> <code>isbitstype</code>, then this is distinct from asking whether the <code>n</code>th field is always defined. An isbits field is always defined, but is not always explicitly initialised.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L216-L222">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_primitive-Tuple{Type{Mooncake.MinimalCtx}, Type{&lt;:Tuple}}" href="#Mooncake.is_primitive-Tuple{Type{Mooncake.MinimalCtx}, Type{&lt;:Tuple}}"><code>Mooncake.is_primitive</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_primitive(::Type{Ctx}, sig) where {Ctx}</code></pre><p>Returns a <code>Bool</code> specifying whether the methods specified by <code>sig</code> are considered primitives in the context of contexts of type <code>Ctx</code>.</p><pre><code class="language-julia hljs">is_primitive(DefaultCtx, Tuple{typeof(sin), Float64})</code></pre><p>will return if calling <code>sin(5.0)</code> should be treated as primitive when the context is a <code>DefaultCtx</code>.</p><p>Observe that this information means that whether or not something is a primitive in a particular context depends only on static information, not any run-time information that might live in a particular instance of <code>Ctx</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/contexts.jl#L19-L34">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_unreachable_return_node-Tuple{Core.ReturnNode}" href="#Mooncake.is_unreachable_return_node-Tuple{Core.ReturnNode}"><code>Mooncake.is_unreachable_return_node</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_unreachable_return_node(x::ReturnNode)</code></pre><p>Determine whehter <code>x</code> is a <code>ReturnNode</code>, and if it is, if it is also unreachable. This is purely a function of whether or not its <code>val</code> field is defined or not.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L223-L228">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_used-Tuple{Mooncake.ADInfo, Mooncake.BasicBlockCode.ID}" href="#Mooncake.is_used-Tuple{Mooncake.ADInfo, Mooncake.BasicBlockCode.ID}"><code>Mooncake.is_used</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_used(info::ADInfo, id::ID)::Bool</code></pre><p>Returns <code>true</code> if <code>id</code> is used by any of the lines in the ir, false otherwise.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L219-L223">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_vararg_and_sparam_names-Tuple{Any}" href="#Mooncake.is_vararg_and_sparam_names-Tuple{Any}"><code>Mooncake.is_vararg_and_sparam_names</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_vararg_and_sparam_names(sig)::Tuple{Bool, Vector{Symbol}}</code></pre><p>Finds the method associated to <code>sig</code>, and calls <code>is_vararg_and_sparam_names</code> on it.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L164-L168">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_vararg_and_sparam_names-Tuple{Core.MethodInstance}" href="#Mooncake.is_vararg_and_sparam_names-Tuple{Core.MethodInstance}"><code>Mooncake.is_vararg_and_sparam_names</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_vararg_and_sparam_names(mi::Core.MethodInstance)</code></pre><p>Calls <code>is_vararg_and_sparam_names</code> on <code>mi.def::Method</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L179-L183">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_vararg_and_sparam_names-Tuple{Method}" href="#Mooncake.is_vararg_and_sparam_names-Tuple{Method}"><code>Mooncake.is_vararg_and_sparam_names</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_vararg_and_sparam_names(m::Method)</code></pre><p>Returns a 2-tuple. The first element is true if <code>m</code> is a vararg method, and false if not. The second element contains the names of the static parameters associated to <code>m</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L156-L161">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.lgetfield-Union{Tuple{f}, Tuple{Any, Val{f}}} where f" href="#Mooncake.lgetfield-Union{Tuple{f}, Tuple{Any, Val{f}}} where f"><code>Mooncake.lgetfield</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">lgetfield(x, f::Val)</code></pre><p>An implementation of <code>getfield</code> in which the the field <code>f</code> is specified statically via a <code>Val</code>. This enables the implementation to be type-stable even when it is not possible to constant-propagate <code>f</code>. Moreover, it enable the pullback to also be type-stable.</p><p>It will always be the case that</p><pre><code class="language-julia hljs">getfield(x, :f) === lgetfield(x, Val(:f))
getfield(x, 2) === lgetfield(x, Val(2))</code></pre><p>This approach is identical to the one taken by <code>Zygote.jl</code> to circumvent the same problem. <code>Zygote.jl</code> calls the function <code>literal_getfield</code>, while we call it <code>lgetfield</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/rrules/misc.jl#L42-L57">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.lgetfield-Union{Tuple{order}, Tuple{f}, Tuple{Any, Val{f}, Val{order}}} where {f, order}" href="#Mooncake.lgetfield-Union{Tuple{order}, Tuple{f}, Tuple{Any, Val{f}, Val{order}}} where {f, order}"><code>Mooncake.lgetfield</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">lgetfield(x, ::Val{f}, ::Val{order}) where {f, order}</code></pre><p>Like <code>getfield</code>, but with the field and access order encoded as types.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L237-L241">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.lift_gc_preservation-Tuple{Any}" href="#Mooncake.lift_gc_preservation-Tuple{Any}"><code>Mooncake.lift_gc_preservation</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">lift_gc_preserve(inst)</code></pre><p>Expressions of the form</p><pre><code class="language-julia hljs">y = GC.@preserve x1 x2 foo(args...)</code></pre><p>get lowered to</p><pre><code class="language-julia hljs">token = Expr(:gc_preserve_begin, x1, x2)
y = expr
Expr(:gc_preserve_end, token)</code></pre><p>These expressions guarantee that any memory associated <code>x1</code> and <code>x2</code> not be freed until the <code>:gc_preserve_end</code> expression is reached.</p><p>In the context of reverse-mode AD, we must ensure that the memory associated to <code>x1</code>, <code>x2</code> and their fdata is available during the reverse pass code associated to <code>expr</code>. We do this by preventing the memory from being freed until the <code>:gc_preserve_begin</code> is reached on the reverse pass.</p><p>To achieve this, we replace the primal code with</p><pre><code class="language-julia hljs"># store `x` in `pb_gc_preserve` to prevent it from being freed.
_, pb_gc_preserve = rrule!!(zero_fcodual(gc_preserve), x1, x2)

# Differentiate the `:call` expression in the usual way.
y, foo_pb = rrule!!(zero_fcodual(foo), args...)

# Do not permit the GC to free `x` here.
nothing</code></pre><p>The pullback should be something along the lines of</p><pre><code class="language-julia hljs"># no pullback associated to `nothing`.
nothing

# Run the pullback associated to `foo` in the usual manner. `x` must be available.
_, dargs... = foo_pb(dy)

# No-op pullback associated to `gc_preserve`.
pb_gc_preserve(NoRData())</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L358-L401">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.lift_getfield_and_others-Tuple{Any}" href="#Mooncake.lift_getfield_and_others-Tuple{Any}"><code>Mooncake.lift_getfield_and_others</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">lift_getfield_and_others(inst)</code></pre><p>Converts expressions of the form <code>getfield(x, :a)</code> into <code>lgetfield(x, Val(:a))</code>. This has identical semantics, but is performant in the absence of proper constant propagation.</p><p>Does the same for...</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L259-L266">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.lookup_ir-Tuple{Core.Compiler.AbstractInterpreter, Type{&lt;:Tuple}}" href="#Mooncake.lookup_ir-Tuple{Core.Compiler.AbstractInterpreter, Type{&lt;:Tuple}}"><code>Mooncake.lookup_ir</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">lookup_ir(
    interp::AbstractInterpreter,
    sig_or_mi::Union{Type{&lt;:Tuple}, Core.MethodInstance},
)::Tuple{IRCode, T}</code></pre><p>Get the unique IR associated to <code>sig_or_mi</code> under <code>interp</code>. Throws <code>ArgumentError</code>s if there is no code found, or if more than one <code>IRCode</code> instance returned.</p><p>Returns a tuple containing the <code>IRCode</code> and its return type.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L165-L175">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.lsetfield!-Union{Tuple{name}, Tuple{Any, Val{name}, Any}} where name" href="#Mooncake.lsetfield!-Union{Tuple{name}, Tuple{Any, Val{name}, Any}} where name"><code>Mooncake.lsetfield!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">lsetfield!(value, name::Val, x, [order::Val])</code></pre><p>This function is to <code>setfield!</code> what <code>lgetfield</code> is to <code>getfield</code>. It will always hold that</p><pre><code class="language-julia hljs">setfield!(copy(x), :f, v) == lsetfield!(copy(x), Val(:f), v)
setfield!(copy(x), 2, v) == lsetfield(copy(x), Val(2), v)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L244-L252">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.make_ad_stmts!" href="#Mooncake.make_ad_stmts!"><code>Mooncake.make_ad_stmts!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">make_ad_stmts!(inst::NewInstruction, line::ID, info::ADInfo)::ADStmtInfo</code></pre><p>Every line in the primal code is associated to one or more lines in the forwards-pass of AD, and one or more lines in the pullback. This function has method specific to every node type in the Julia SSAIR.</p><p>Translates the instruction <code>inst</code>, associated to <code>line</code> in the primal, into a specification of what should happen for this instruction in the forwards- and reverse-passes of AD, and what data should be shared between the forwards- and reverse-passes. Returns this in the form of an <code>ADStmtInfo</code>.</p><p><code>info</code> is a data structure containing various bits of global information that certain types of nodes need access to.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L381-L395">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.make_switch_stmts-Tuple{Vector{Mooncake.BasicBlockCode.ID}, Vector{Mooncake.BasicBlockCode.ID}, Bool, Mooncake.ADInfo}" href="#Mooncake.make_switch_stmts-Tuple{Vector{Mooncake.BasicBlockCode.ID}, Vector{Mooncake.BasicBlockCode.ID}, Bool, Mooncake.ADInfo}"><code>Mooncake.make_switch_stmts</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">make_switch_stmts(
    pred_ids::Vector{ID}, target_ids::Vector{ID}, pred_is_unique_pred::Bool, info::ADInfo
)</code></pre><p><code>preds_ids</code> comprises the <code>ID</code>s associated to all possible predecessor blocks to the primal block under consideration. Suppose its value is <code>[ID(1), ID(2), ID(3)]</code>, then <code>make_switch_stmts</code> emits code along the lines of</p><pre><code class="language-julia hljs">prev_block = pop!(block_stack)
not_pred_was_1 = !(prev_block == ID(1))
not_pred_was_2 = !(prev_block == ID(2))
switch(
    not_pred_was_1 =&gt; ID(1),
    not_pred_was_2 =&gt; ID(2),
    ID(3)
)</code></pre><p>In words: <code>make_switch_stmts</code> emits code which jumps to whichever block preceded the current block during the forwards-pass.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1640-L1662">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.map_prod-Tuple{Any, Vararg{Any}}" href="#Mooncake.map_prod-Tuple{Any, Vararg{Any}}"><code>Mooncake.map_prod</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">map_prod(f, xs...)</code></pre><p>Equivalent to <code>map(f, flat_product(xs...))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L271-L275">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.misty_closure-Tuple{Type, Core.Compiler.IRCode, Vararg{Any}}" href="#Mooncake.misty_closure-Tuple{Type, Core.Compiler.IRCode, Vararg{Any}}"><code>Mooncake.misty_closure</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">misty_closure(
    ret_type::Type,
    ir::IRCode,
    @nospecialize env...;
    isva::Bool=false,
    do_compile::Bool=true,
)</code></pre><p>Identical to <a href="#Mooncake.opaque_closure-Tuple{Type, Core.Compiler.IRCode, Vararg{Any}}"><code>Mooncake.opaque_closure</code></a>, but returns a <code>MistyClosure</code> closure rather than a <code>Core.OpaqueClosure</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L339-L350">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.new_to_call-Tuple{Any}" href="#Mooncake.new_to_call-Tuple{Any}"><code>Mooncake.new_to_call</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">new_to_call(x)</code></pre><p>If instruction <code>x</code> is a <code>:new</code> expression, replace it with a <code>:call</code> to <code>Mooncake._new_</code>. Otherwise, return <code>x</code>.</p><p>The purpose of this transformation is to make it possible to differentiate <code>:new</code> expressions in the same way as a primitive <code>:call</code> expression, i.e. via an <code>rrule!!</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L209-L217">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.normalise!-Tuple{Core.Compiler.IRCode, Vector{Symbol}}" href="#Mooncake.normalise!-Tuple{Core.Compiler.IRCode, Vector{Symbol}}"><code>Mooncake.normalise!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">normalise!(ir::IRCode, spnames::Vector{Symbol})</code></pre><p>Apply a sequence of standardising transformations to <code>ir</code> which leaves its semantics unchanged, but makes AD more straightforward. In particular, replace</p><ol><li><code>:foreigncall</code> <code>Expr</code>s with <code>:call</code>s to <code>Mooncake._foreigncall_</code>,</li><li><code>:new</code> <code>Expr</code>s with <code>:call</code>s to <code>Mooncake._new_</code>,</li><li><code>:splatnew</code> Expr<code>s with</code>:call<code>s to</code>Mooncake.<em>splat</em>new_`,</li><li><code>Core.IntrinsicFunction</code>s with counterparts from <code>Mooncake.IntrinsicWrappers</code>,</li><li><code>getfield(x, 1)</code> with <code>lgetfield(x, Val(1))</code>, and related transformations,</li><li><code>memoryrefget</code> calls to <code>lmemoryrefget</code> calls, and related transformations,</li><li><code>gc_preserve_begin</code> / <code>gc_preserve_end</code> exprs so that memory release is delayed.</li></ol><p><code>spnames</code> are the names associated to the static parameters of <code>ir</code>. These are needed when handling <code>:foreigncall</code> expressions, in which it is not necessarily the case that all static parameter names have been translated into either types, or <code>:static_parameter</code> expressions.</p><p>Unfortunately, the static parameter names are not retained in <code>IRCode</code>, and the <code>Method</code> from which the <code>IRCode</code> is derived must be consulted. <code>Mooncake.is_vararg_and_sparam_names</code> provides a convenient way to do this.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L1-L22">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.opaque_closure-Tuple{Type, Core.Compiler.IRCode, Vararg{Any}}" href="#Mooncake.opaque_closure-Tuple{Type, Core.Compiler.IRCode, Vararg{Any}}"><code>Mooncake.opaque_closure</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">opaque_closure(
    ret_type::Type,
    ir::IRCode,
    @nospecialize env...;
    isva::Bool=false,
    do_compile::Bool=true,
)::Core.OpaqueClosure{&lt;:Tuple, ret_type}</code></pre><p>Construct a <code>Core.OpaqueClosure</code>. Almost equivalent to <code>Core.OpaqueClosure(ir, env...; isva, do_compile)</code>, but instead of letting <code>Core.compute_oc_rettype</code> figure out the return type from <code>ir</code>, impose <code>ret_type</code> as the return type.</p><p><strong>Warning</strong></p><p>User beware: if the <code>Core.OpaqueClosure</code> produced by this function ever returns anything which is not an instance of a subtype of <code>ret_type</code>, you should expect all kinds of awful things to happen, such as segfaults. You have been warned!</p><p><strong>Extended Help</strong></p><p>This is needed in Mooncake.jl because make extensive use of our ability to know the return type of a couple of specific <code>OpaqueClosure</code>s without actually having constructed them – see <code>LazyDerivedRule</code>. Without the capability to specify the return type, we have to guess what type <code>compute_ir_rettype</code> will return for a given <code>IRCode</code> before we have constructed the <code>IRCode</code> and run type inference on it. This exposes us to details of type inference, which are not part of the public interface of the language, and can therefore vary from Julia version to Julia version (including patch versions). Moreover, even for a fixed Julia version it can be extremely hard to predict exactly what type inference will infer to be the return type of a function.</p><p>Failing to correctly guess the return type can happen for a number of reasons, and the kinds of errors that tend to be generated when this fails tell you very little about the underlying cause of the problem.</p><p>By specifying the return type ourselves, we remove this dependence. The price we pay for this is the potential for segfaults etc if we fail to specify <code>ret_type</code> correctly.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L278-L316">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.optimise_ir!-Tuple{Core.Compiler.IRCode}" href="#Mooncake.optimise_ir!-Tuple{Core.Compiler.IRCode}"><code>Mooncake.optimise_ir!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">optimise_ir!(ir::IRCode, show_ir=false)</code></pre><p>Run a fairly standard optimisation pass on <code>ir</code>. If <code>show_ir</code> is <code>true</code>, displays the IR to <code>stdout</code> at various points in the pipeline – this is sometimes useful for debugging.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L111-L116">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.primal_ir-Tuple{Type{&lt;:Tuple}}" href="#Mooncake.primal_ir-Tuple{Type{&lt;:Tuple}}"><code>Mooncake.primal_ir</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">primal_ir(sig::Type{&lt;:Tuple}; interp=get_interpreter())::IRCode</code></pre><div class="admonition is-warning" id="Warning-aa52cef5042e0271"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-aa52cef5042e0271" title="Permalink"></a></header><div class="admonition-body"><p>This is not part of the public interface of Mooncake. As such, it may change as  part of a non-breaking release of the package.</p></div></div><p>Get the <code>Core.Compiler.IRCode</code> associated to <code>sig</code> from which the a rule can be derived. Roughly equivalent to <code>Base.code_ircode_by_type(sig; interp)</code>.</p><p>For example, if you wanted to get the IR associated to the call <code>map(sin, randn(10))</code>, you could do one of the following calls:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.primal_ir(Tuple{typeof(map), typeof(sin), Vector{Float64}}) isa Core.Compiler.IRCode
true
julia&gt; Mooncake.primal_ir(typeof((map, sin, randn(10)))) isa Core.Compiler.IRCode
true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/developer_tools.jl#L1-L19">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.pullback_ir-Tuple{Mooncake.BasicBlockCode.BBCode, Any, Vector{Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.ADStmtInfo}}}, Any, Mooncake.ADInfo, Any}" href="#Mooncake.pullback_ir-Tuple{Mooncake.BasicBlockCode.BBCode, Any, Vector{Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.ADStmtInfo}}}, Any, Mooncake.ADInfo, Any}"><code>Mooncake.pullback_ir</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">pullback_ir(ir::BBCode, Tret, ad_stmts_blocks::ADStmts, info::ADInfo, Tshared_data)</code></pre><p>Produce the IR associated to the <code>OpaqueClosure</code> which runs most of the pullback.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1372-L1376">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.pullback_type-Tuple{Any, Any}" href="#Mooncake.pullback_type-Tuple{Any, Any}"><code>Mooncake.pullback_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">pullback_type(Trule, arg_types)</code></pre><p>Get a bound on the pullback type, given a rule and associated primal types.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L876-L880">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.randn_tangent-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P" href="#Mooncake.randn_tangent-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P"><code>Mooncake.randn_tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">randn_tangent(rng::AbstractRNG, x::P) where {P}</code></pre><p>Required for testing. Generate a randomly-chosen tangent to <code>x</code>. Very similar to <a href="#Mooncake.zero_tangent-Tuple{Any, Mooncake.NoFData}"><code>Mooncake.zero_tangent</code></a>, except that the elements are randomly chosen, rather than being equal to zero.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L568-L574">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.randn_tangent_internal-Union{Tuple{P}, Tuple{Random.AbstractRNG, P, Union{Mooncake.NoCache, IdDict{Any, Any}}}} where P&lt;:Union{Float16, Float32, Float64}" href="#Mooncake.randn_tangent_internal-Union{Tuple{P}, Tuple{Random.AbstractRNG, P, Union{Mooncake.NoCache, IdDict{Any, Any}}}} where P&lt;:Union{Float16, Float32, Float64}"><code>Mooncake.randn_tangent_internal</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">randn_tangent_internal(rng::AbstractRNG, x, dict::MaybeCache)</code></pre><p>Implementation for <a href="#Mooncake.randn_tangent-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P"><code>Mooncake.randn_tangent</code></a>. Please consult the docstring for <a href="#Mooncake.zero_tangent_internal-Tuple{Union{Int128, Int16, Int32, Int64, Int8}, Union{Mooncake.NoCache, IdDict{Any, Any}}}"><code>zero_tangent_internal</code></a> for more information on how this implementation works, As the same implementation strategy is adopted for both this function and that one.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L579-L585">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rdata-Tuple{T} where T" href="#Mooncake.rdata-Tuple{T} where T"><code>Mooncake.rdata</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rdata(t)::rdata_type(typeof(t))</code></pre><p>Extract the reverse data from tangent <code>t</code>.</p><p><strong>Extended help</strong></p><p>See extended help section of <a href="#Mooncake.fdata_type-Tuple{Any}">fdata_type</a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L506-L514">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rdata_backing_type-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.rdata_backing_type-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.rdata_backing_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rdata_backing_type(::Type{P}) where {P}</code></pre><p>The type of the field of <code>RData</code> for <code>P</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L556-L560">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rdata_field_type-Union{Tuple{P}, Tuple{Type{P}, Int64}} where P" href="#Mooncake.rdata_field_type-Union{Tuple{P}, Tuple{Type{P}, Int64}} where P"><code>Mooncake.rdata_field_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rdata_field_type(::Type{P}, n::Int) where {P}</code></pre><p>Returns the type of to the nth field of the rdata type associated to <code>P</code>. Will be a <code>PossiblyUninitTangent</code> if said field can be undefined.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L495-L500">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rdata_field_types_exprs-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.rdata_field_types_exprs-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.rdata_field_types_exprs</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rdata_field_types_exprs(::Type{P}) where {P}</code></pre><p>Tuple of expressions. The nth computes the rdata backing type of the nth field of <code>P</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L540-L544">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rdata_type-Tuple{Any}" href="#Mooncake.rdata_type-Tuple{Any}"><code>Mooncake.rdata_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rdata_type(T)</code></pre><p>Returns the type of the reverse data of a tangent of type T.</p><p><strong>Extended help</strong></p><p>See extended help in <a href="#Mooncake.fdata_type-Tuple{Any}"><code>fdata_type</code></a> docstring.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L416-L424">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.remove_edge!-Tuple{Core.Compiler.IRCode, Int64, Int64}" href="#Mooncake.remove_edge!-Tuple{Core.Compiler.IRCode, Int64, Int64}"><code>Mooncake.remove_edge!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">remove_edge!(ir::IRCode, from::Int, to::Int)</code></pre><p>Removes an edge in <code>ir</code> from <code>from</code> to <code>to</code>. See implementation for what this entails.</p><p>Note: this is slightly different from <code>Core.Compiler.kill_edge!</code>, in that it also updates <code>PhiNode</code>s in the <code>to</code> block. Moreover, the available methods of <code>remove_edge!</code> differ between 1.10 and 1.11, so we need something which is stable across both.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L433-L441">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.replace_captures-Union{Tuple{Tmc}, Tuple{Tmc, Any}} where Tmc&lt;:MistyClosures.MistyClosure" href="#Mooncake.replace_captures-Union{Tuple{Tmc}, Tuple{Tmc, Any}} where Tmc&lt;:MistyClosures.MistyClosure"><code>Mooncake.replace_captures</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">replace_captures(mc::Tmc, new_captures) where {Tmc&lt;:MistyClosure}</code></pre><p>Same as <code>replace_captures</code> for <code>Core.OpaqueClosure</code>s, but returns a new <code>MistyClosure</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1214-L1218">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.replace_captures-Union{Tuple{Toc}, Tuple{Toc, Any}} where Toc&lt;:Core.OpaqueClosure" href="#Mooncake.replace_captures-Union{Tuple{Toc}, Tuple{Toc, Any}} where Toc&lt;:Core.OpaqueClosure"><code>Mooncake.replace_captures</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">replace_captures(oc::Toc, new_captures) where {Toc&lt;:OpaqueClosure}</code></pre><p>Given an <code>OpaqueClosure</code> <code>oc</code>, create a new <code>OpaqueClosure</code> of the same type, but with new captured variables. This is needed for efficiency reasons – if <code>build_rrule</code> is called repeatedly with the same signature and intepreter, it is important to avoid recompiling the <code>OpaqueClosure</code>s that it produces multiple times, because it can be quite expensive to do so.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1195-L1203">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.replace_uses_with!-Tuple{Any, Union{Core.Argument, Core.SSAValue}, Any}" href="#Mooncake.replace_uses_with!-Tuple{Any, Union{Core.Argument, Core.SSAValue}, Any}"><code>Mooncake.replace_uses_with!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">replace_uses_with!(stmt, def::Union{Argument, SSAValue}, val)</code></pre><p>Replace all uses of <code>def</code> with <code>val</code> in the single statement <code>stmt</code>. Note: this function is highly incomplete, really only working correctly for a specific function in <code>ir_normalisation.jl</code>. You probably do not want to use it.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L249-L255">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.reverse_data_ref_stmts-Tuple{Mooncake.ADInfo}" href="#Mooncake.reverse_data_ref_stmts-Tuple{Mooncake.ADInfo}"><code>Mooncake.reverse_data_ref_stmts</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">reverse_data_ref_stmts(info::ADInfo)</code></pre><p>Create the <code>:new</code> statements which initialise the reverse-data <code>Ref</code>s. Interpolates the initial rdata directly into the statement, which is safe because it is always a bits type.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L253-L258">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rrule!!" href="#Mooncake.rrule!!"><code>Mooncake.rrule!!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rrule!!(f::CoDual, x::CoDual...)</code></pre><p>Performs the forwards-pass of AD. The <code>tangent</code> field of <code>f</code> and each <code>x</code> should contain the forwards tangent data (fdata) associated to each corresponding <code>primal</code> field.</p><p>Returns a 2-tuple. The first element, <code>y</code>, is a <code>CoDual</code> whose <code>primal</code> field is the value associated to running <code>f.primal(map(x -&gt; x.primal, x)...)</code>, and whose <code>tangent</code> field is its associated <code>fdata</code>. The second element contains the pullback, which runs the reverse-pass. It maps from the rdata associated to <code>y</code> to the rdata associated to <code>f</code> and each <code>x</code>.</p><pre><code class="language-julia hljs">using Mooncake: zero_fcodual, CoDual, NoFData, rrule!!
y, pb!! = rrule!!(zero_fcodual(sin), CoDual(5.0, NoFData()))
pb!!(1.0)

# output

(NoRData(), 0.28366218546322625)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/Mooncake.jl#L45-L67">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rrule_wrapper-Union{NTuple{N, Mooncake.CoDual}, Tuple{N}} where N" href="#Mooncake.rrule_wrapper-Union{NTuple{N, Mooncake.CoDual}, Tuple{N}} where N"><code>Mooncake.rrule_wrapper</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rrule_wrapper(f::CoDual, args::CoDual...)</code></pre><p>Used to implement <code>rrule!!</code>s via <code>ChainRulesCore.rrule</code>.</p><p>Given a function <code>foo</code>, argument types <code>arg_types</code>, and a method of <code>ChainRulesCore.rrule</code> which applies to these, you can make use of this function as follows:</p><pre><code class="language-julia hljs">Mooncake.@is_primitive DefaultCtx Tuple{typeof(foo), arg_types...}
function Mooncake.rrule!!(f::CoDual{typeof(foo)}, args::CoDual...)
    return rrule_wrapper(f, args...)
end</code></pre><p>Assumes that methods of <code>to_cr_tangent</code> and <code>to_mooncake_tangent</code> are defined such that you can convert between the different representations of tangents that Mooncake and ChainRulesCore expect.</p><p>Furthermore, it is <em>essential</em> that</p><ol><li><code>f(args)</code> does not mutate <code>f</code> or <code>args</code>, and</li><li>the result of <code>f(args)</code> does not alias any data stored in <code>f</code> or <code>args</code>.</li></ol><p>Subject to some constraints, you can use the <a href="#Mooncake.@from_rrule"><code>@from_rrule</code></a> macro to reduce the amount of boilerplate code that you are required to write even further.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tools_for_rules.jl#L261-L284">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rule_type-Union{Tuple{C}, Tuple{Mooncake.MooncakeInterpreter{C}, Any}} where C" href="#Mooncake.rule_type-Union{Tuple{C}, Tuple{Mooncake.MooncakeInterpreter{C}, Any}} where C"><code>Mooncake.rule_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rule_type(interp::MooncakeInterpreter{C}, sig_or_mi; debug_mode) where {C}</code></pre><p>Compute the concrete type of the rule that will be returned from <code>build_rrule</code>. This is important for performance in dynamic dispatch, and to ensure that recursion works properly.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1830-L1836">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rvs_ir-Tuple{Type{&lt;:Tuple}}" href="#Mooncake.rvs_ir-Tuple{Type{&lt;:Tuple}}"><code>Mooncake.rvs_ir</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rvs_ir(
    sig::Type{&lt;:Tuple};
    interp=get_interpreter(), debug_mode::Bool=false, do_inline::Bool=true
)::IRCode</code></pre><div class="admonition is-warning" id="Warning-6c69d6c3ca4ceb0b"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-6c69d6c3ca4ceb0b" title="Permalink"></a></header><div class="admonition-body"><p>This is not part of the public interface of Mooncake. As such, it may change as part of a non-breaking release of the package.</p></div></div><p>Generate the <code>Core.Compiler.IRCode</code> used to construct the reverse-pass of AD. Take a look at how <code>build_rrule</code> makes use of <code>generate_ir</code> to see exactly how this is used in practice.</p><p>For example, if you wanted to get the IR associated to the reverse pass for the call <code>map(sin, randn(10))</code>, you could do either of the following:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.rvs_ir(Tuple{typeof(map), typeof(sin), Vector{Float64}}) isa Core.Compiler.IRCode
true
julia&gt; Mooncake.rvs_ir(typeof((map, sin, randn(10)))) isa Core.Compiler.IRCode
true</code></pre><p><strong>Arguments</strong></p><ul><li><code>sig::Type{&lt;:Tuple}</code>: the signature of the call to be differentiated.</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>interp</code>: the interpreter to use to obtain the primal IR.</li><li><code>debug_mode::Bool</code>: whether the generated IR should make use of Mooncake&#39;s debug mode.</li><li><code>do_inline::Bool</code>: whether to apply an inlining pass prior to returning the ir generated   by this function. This is <code>true</code> by default, but setting it to <code>false</code> can sometimes be   helpful if you need to understand what function calls are generated in order to perform   AD, before lots of it gets inlined away.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/developer_tools.jl#L66-L98">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rvs_phi_block-Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.BasicBlockCode.ID}, Vector{Any}, Mooncake.ADInfo}" href="#Mooncake.rvs_phi_block-Tuple{Mooncake.BasicBlockCode.ID, Vector{Mooncake.BasicBlockCode.ID}, Vector{Any}, Mooncake.ADInfo}"><code>Mooncake.rvs_phi_block</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rvs_phi_block(pred_id::ID, rdata_ids::Vector{ID}, values::Vector{Any}, info::ADInfo)</code></pre><p>Produces a <code>BBlock</code> which runs the reverse-pass for the edge associated to <code>pred_id</code> in a collection of <code>IDPhiNode</code>s, and then goes to the block associated to <code>pred_id</code>.</p><p>For example, suppose that we encounter the following collection of <code>PhiNode</code>s at the start of some block:</p><pre><code class="language-julia hljs">%6 = φ (#2 =&gt; _1, #3 =&gt; %5)
%7 = φ (#2 =&gt; 5., #3 =&gt; _2)</code></pre><p>Let the rdata refs associated to <code>%6</code>, <code>%7</code>, and <code>_1</code><code>be denoted</code>r%6<code>,</code>r%7<code>, and</code>r<em>1<code>resp., and let</code>pred</em>id<code>be</code>#2<code>, and</code>increment_ref!` be the following function,</p><pre><code class="language-julia hljs">increment_ref!(ref, x) = ref[] = increment!!(ref[], x)</code></pre><p>then this <code>rvs_phi_block</code> will produce a basic block of the form</p><pre><code class="language-julia hljs">increment_ref!(r_1, r%6)
nothing
goto #2</code></pre><p>The call to <code>increment_ref!</code> appears because <code>_1</code> is the value associated to<code>%6</code> when the primal code comes from <code>#2</code>. Similarly, the <code>goto #2</code> statement appears because we came from <code>#2</code> on the forwards-pass. There is no <code>increment_ref!</code> associated to <code>%7</code> because <code>5.</code> is a constant. We emit a <code>nothing</code> statement, which the compiler will happily optimise away later on.</p><p>The same ideas apply if <code>pred_id</code> were <code>#3</code>. The block would end with <code>#3</code>, and there would be two <code>increment_ref!</code> calls because both <code>%5</code> and <code>_2</code> are not constants.</p><p>In practice, code which is equivalent to <code>increment_ref!</code> is created directly, rather than inserting a call to a generic Julia function. This is because we need to be certain that the getfield and setfield! calls applied to any references are visible to the SROA optimisation pass. If we insert a call to a function like <code>increment_ref!</code>, it might not be inlined away, making such references opaque.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L1588-L1625">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.set_tangent_field!-Union{Tuple{Tfields}, Tuple{Mooncake.MutableTangent{Tfields}, Int64, Any}} where Tfields" href="#Mooncake.set_tangent_field!-Union{Tuple{Tfields}, Tuple{Mooncake.MutableTangent{Tfields}, Int64, Any}} where Tfields"><code>Mooncake.set_tangent_field!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">set_tangent_field!(t::MutableTangent{Tfields}, i::Int, x) where {Tfields}</code></pre><p>Sets the value of the <code>i</code>th field of the data in <code>t</code> to value <code>x</code>.</p><p>Has the same semantics that <code>setfield!</code> would have if the data in the <code>fields</code> field of <code>t</code> were actually fields of <code>t</code>. This is the moral equivalent of <code>setfield!</code> for <code>MutableTangent</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L86-L94">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.set_to_zero!!-Tuple{Any}" href="#Mooncake.set_to_zero!!-Tuple{Any}"><code>Mooncake.set_to_zero!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">set_to_zero!!(x)</code></pre><p>Set <code>x</code> to its zero element (<code>x</code> should be a tangent, so the zero must exist).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L701-L705">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.set_to_zero_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent}" href="#Mooncake.set_to_zero_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent}"><code>Mooncake.set_to_zero_internal!!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">set_to_zero_internal!!(c::IncCache, x)</code></pre><p>Implementation for <a href="#Mooncake.set_to_zero!!-Tuple{Any}"><code>Mooncake.set_to_zero!!</code></a>. Use <code>c</code> to ensure that circular references are correctly handled. If <code>c</code> is a <code>NoCache</code>, assume no circular references.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L708-L713">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.shared_data_stmts-Tuple{Mooncake.SharedDataPairs}" href="#Mooncake.shared_data_stmts-Tuple{Mooncake.SharedDataPairs}"><code>Mooncake.shared_data_stmts</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">shared_data_stmts(p::SharedDataPairs)::Vector{IDInstPair}</code></pre><p>Produce a sequence of id-statment pairs which will extract the data from <code>shared_data_tuple(p)</code> such that the correct value is associated to the correct <code>ID</code>.</p><p>For example, if <code>p.pairs</code> is</p><pre><code class="language-julia hljs">[(ID(5), 5.0), (ID(3), &quot;hello&quot;)]</code></pre><p>then the output of this function is</p><pre><code class="language-julia hljs">IDInstPair[
    (ID(5), new_inst(:(getfield(_1, 1)))),
    (ID(3), new_inst(:(getfield(_1, 2)))),
]</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L48-L65">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.shared_data_tuple-Tuple{Mooncake.SharedDataPairs}" href="#Mooncake.shared_data_tuple-Tuple{Mooncake.SharedDataPairs}"><code>Mooncake.shared_data_tuple</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">shared_data_tuple(p::SharedDataPairs)::Tuple</code></pre><p>Create the tuple that will constitute the captured variables in the forwards- and reverse- pass <code>OpaqueClosure</code>s.</p><p>For example, if <code>p.pairs</code> is</p><pre><code class="language-julia hljs">[(ID(5), 5.0), (ID(3), &quot;hello&quot;)]</code></pre><p>then the output of this function is</p><pre><code class="language-julia hljs">(5.0, &quot;hello&quot;)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/s2s_reverse_mode_ad.jl#L31-L45">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.sparam_names-Tuple{Method}" href="#Mooncake.sparam_names-Tuple{Method}"><code>Mooncake.sparam_names</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">sparam_names(m::Core.Method)::Vector{Symbol}</code></pre><p>Returns the names of all of the static parameters in <code>m</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L188-L192">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.splatnew_to_call-Tuple{Any}" href="#Mooncake.splatnew_to_call-Tuple{Any}"><code>Mooncake.splatnew_to_call</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">splatnew_to_call(x)</code></pre><p>If instruction <code>x</code> is a <code>:splatnew</code> expression, replace it with a <code>:call</code> to <code>Mooncake._splat_new_</code>. Otherwise return <code>x</code>.</p><p>The purpose of this transformation is to make it possible to differentiate <code>:splatnew</code> expressions in the same way as a primitive <code>:call</code> expression, i.e. via an <code>rrule!!</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L220-L228">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.stable_all-Union{Tuple{NTuple{N, Bool}}, Tuple{N}} where N" href="#Mooncake.stable_all-Union{Tuple{NTuple{N, Bool}}, Tuple{N}} where N"><code>Mooncake.stable_all</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">stable_all(x::NTuple{N, Bool}) where {N}</code></pre><p><code>all(x::NTuple{N, Bool})</code> does not constant-fold nicely on 1.10 if the values of <code>x</code> are known statically. This implementation constant-folds nicely on both 1.10 and 1.11, so can be used in its place in situations where this is important.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L88-L94">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.stmt-Tuple{Core.Compiler.InstructionStream}" href="#Mooncake.stmt-Tuple{Core.Compiler.InstructionStream}"><code>Mooncake.stmt</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">stmt(ir::CC.InstructionStream)</code></pre><p>Get the field containing the instructions in <code>ir</code>. This changed name in 1.11 from <code>inst</code> to <code>stmt</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L1-L6">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.tangent-Tuple{Mooncake.NoFData, Mooncake.NoRData}" href="#Mooncake.tangent-Tuple{Mooncake.NoFData, Mooncake.NoRData}"><code>Mooncake.tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">tangent(f, r)</code></pre><p>Reconstruct the tangent <code>t</code> for which <code>fdata(t) == f</code> and <code>rdata(t) == r</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L920-L924">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.tangent_test_cases-Tuple{}" href="#Mooncake.tangent_test_cases-Tuple{}"><code>Mooncake.tangent_test_cases</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">tangent_test_cases()</code></pre><p>Constructs a <code>Vector</code> of <code>Tuple</code>s containing test cases for the tangent infrastructure.</p><p>If the returned tuple has 2 elements, the elements should be interpreted as follows: 1 - interface_only 2 - primal value</p><p>interface_only is a Bool which will be used to determine which subset of tests to run.</p><p>If the returned tuple has 5 elements, then the elements are interpreted as follows: 1 - interface_only 2 - primal value 3, 4, 5 - tangents, where &lt;5&gt; == increment!!(&lt;3&gt;, &lt;4&gt;).</p><p>Test cases in the first format make use of <code>zero_tangent</code> / <code>randn_tangent</code> etc to generate tangents, but they&#39;re unable to check that <code>increment!!</code> is correct in an absolute sense.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L1089-L1107">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.tangent_type-Tuple{Any}" href="#Mooncake.tangent_type-Tuple{Any}"><code>Mooncake.tangent_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">tangent_type(P)</code></pre><p>There must be a single type used to represents tangents of primals of type <code>P</code>, and it must be given by <code>tangent_type(P)</code>.</p><p>Warning: this function assumes the effects <code>:removable</code> and <code>:consistent</code>. This is necessary to ensure good performance, but imposes precise constraints on your implementation. If adding new methods to <code>tangent_type</code>, you should consult the extended help of <code>Base.@assume_effects</code> to see what this imposes upon your implementation.</p><p><strong>Extended help</strong></p><p>The tangent types which Mooncake.jl uses are quite similar in spirit to ChainRules.jl. For example, tangent &quot;vectors&quot; for</p><ol><li><code>Float64</code>s are <code>Float64</code>s,</li><li><code>Vector{Float64}</code>s are <code>Vector{Float64}</code>s, and</li><li><code>struct</code>s are other another (special) <code>struct</code> with field types specified recursively.</li></ol><p>There are, however, some major differences. Firstly, while it is certainly true that the above tangent types are permissible in ChainRules.jl, they are not the uniquely permissible types. For example, <code>ZeroTangent</code> is also a permissible type of tangent for any of them, and <code>Float32</code> is permissible for <code>Float64</code>. This is a general theme in ChainRules.jl – it intentionally declines to place restrictions on what type can be used to represent the tangent of a given type.</p><p>Mooncake.jl differs from this. <strong>It insists that each primal type is associated to a <em>single</em> tangent type.</strong> Furthermore, this type is <em>always</em> given by the function <code>Mooncake.tangent_type(primal_type)</code>.</p><p>Consider some more worked examples.</p><p><strong>Int</strong></p><p><code>Int</code> is not a differentiable type, so its tangent type is <code>NoTangent</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; tangent_type(Int)
NoTangent</code></pre><p><strong>Tuples</strong></p><p>The tangent type of a <code>Tuple</code> is defined recursively based on its field types. For example</p><pre><code class="language-julia-repl hljs">julia&gt; tangent_type(Tuple{Float64, Vector{Float64}, Int})
Tuple{Float64, Vector{Float64}, NoTangent}</code></pre><p>There is one edge case to be aware of: if all of the field of a <code>Tuple</code> are non-differentiable, then the tangent type is <code>NoTangent</code>. For example,</p><pre><code class="language-julia-repl hljs">julia&gt; tangent_type(Tuple{Int, Int})
NoTangent</code></pre><p><strong>Structs</strong></p><p>As with <code>Tuple</code>s, the tangent type of a struct is, by default, given recursively. In particular, the tangent type of a <code>struct</code> type is <code>Tangent</code>. This type contains a <code>NamedTuple</code> containing the tangent to each field in the primal <code>struct</code>.</p><p>As with <code>Tuple</code>s, if all field types are non-differentiable, the tangent type of the entire struct is <code>NoTangent</code>.</p><p>There are a couple of additional subtleties to consider over <code>Tuple</code>s though. Firstly, not all fields of a <code>struct</code> have to be defined. Fortunately, Julia makes it easy to determine how many of the fields might possibly not be defined. The tangent associated to any field which might possibly not be defined is wrapped in a <code>PossiblyUninitTangent</code>.</p><p>Furthermore, <code>struct</code>s can have fields whose static type is abstract. For example</p><pre><code class="language-julia-repl hljs">julia&gt; struct Foo
           x
       end</code></pre><p>If you ask for the tangent type of <code>Foo</code>, you will see that it is</p><pre><code class="language-julia-repl hljs">julia&gt; tangent_type(Foo)
Tangent{@NamedTuple{x}}</code></pre><p>Observe that the field type associated to <code>x</code> is <code>Any</code>. The way to understand this result is to observe that</p><ol><li><code>x</code> could have literally any type at runtime, so we know nothing about what its tangent  type must be until runtime, and</li><li>we require that the tangent type of <code>Foo</code> be unique.</li></ol><p>The consequence of these two considerations is that the tangent type of <code>Foo</code> must be able to contain any type of tangent in its <code>x</code> field. It follows that the fieldtype of the <code>x</code> field of <code>Foo</code>s tangent must be <code>Any</code>.</p><p><strong>Mutable Structs</strong></p><p>The tangent type for <code>mutable struct</code>s have the same set of considerations as <code>struct</code>s. The only difference is that they must themselves be mutable. Consequently, we use a type called <code>MutableTangent</code> to represent their tangents. It is a <code>mutable struct</code> with the same structure as <code>Tangent</code>.</p><p>For example, if you ask for the <code>tangent_type</code> of</p><pre><code class="language-julia-repl hljs">julia&gt; mutable struct Bar
           x::Float64
       end</code></pre><p>you will find that it is</p><pre><code class="language-julia-repl hljs">julia&gt; tangent_type(Bar)
MutableTangent{@NamedTuple{x::Float64}}</code></pre><p><strong>Primitive Types</strong></p><p>We&#39;ve already seen a couple of primitive types (<code>Float64</code> and <code>Int</code>). The basic story here is that all primitive types require an explicit specification of what their tangent type must be.</p><p>One interesting case are <code>Ptr</code> types. The tangent type of a <code>Ptr{P}</code> is <code>Ptr{T}</code>, where <code>T = tangent_type(P)</code>. For example</p><pre><code class="language-julia hljs">julia&gt; tangent_type(Ptr{Float64})
Ptr{Float64}</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L149-L273">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.tangent_type-Tuple{Type{Mooncake.NoFData}, Type{Mooncake.NoRData}}" href="#Mooncake.tangent_type-Tuple{Type{Mooncake.NoFData}, Type{Mooncake.NoRData}}"><code>Mooncake.tangent_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">tangent_type(F::Type, R::Type)::Type</code></pre><p>Given the type of the fdata and rdata, <code>F</code> and <code>R</code> resp., for some primal type, compute its tangent type. This method must be equivalent to <code>tangent_type(_typeof(primal))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L853-L858">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.to_cr_tangent-Tuple{Union{Float16, Float32, Float64}}" href="#Mooncake.to_cr_tangent-Tuple{Union{Float16, Float32, Float64}}"><code>Mooncake.to_cr_tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">to_cr_tangent(t)</code></pre><p>Convert a Mooncake tangent into a type that ChainRules.jl <code>rrule</code>s expect to see.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tools_for_rules.jl#L232-L236">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.tuple_map-Union{Tuple{F}, Tuple{F, Tuple}} where F" href="#Mooncake.tuple_map-Union{Tuple{F}, Tuple{F, Tuple}} where F"><code>Mooncake.tuple_map</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">tuple_map(f::F, x::Tuple) where {F}</code></pre><p>This function is largely equivalent to <code>map(f, x)</code>, but always specialises on all of the element types of <code>x</code>, regardless the length of <code>x</code>. This contrasts with <code>map</code>, in which the number of element types specialised upon is a fixed constant in the compiler.</p><p>As a consequence, if <code>x</code> is very long, this function may have very large compile times.</p><pre><code class="nohighlight hljs">tuple_map(f::F, x::Tuple, y::Tuple) where {F}</code></pre><p>Binary extension of <code>tuple_map</code>. Nearly equivalent to <code>map(f, x, y)</code>, but guaranteed to specialise on all element types of <code>x</code> and <code>y</code>. Furthermore, errors if <code>x</code> and <code>y</code> aren&#39;t the same length, while <code>map</code> will just produce a new tuple whose length is equal to the shorter of <code>x</code> and <code>y</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/utils.jl#L10-L25">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.unhandled_feature-Tuple{String}" href="#Mooncake.unhandled_feature-Tuple{String}"><code>Mooncake.unhandled_feature</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">unhandled_feature(msg::String)</code></pre><p>Throw an <code>UnhandledLanguageFeatureException</code> with message <code>msg</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_utils.jl#L242-L246">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.uninit_codual-Tuple{Any}" href="#Mooncake.uninit_codual-Tuple{Any}"><code>Mooncake.uninit_codual</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">uninit_codual(x)</code></pre><p>Equivalent to <code>CoDual(x, uninit_tangent(x))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/codual.jl#L27-L31">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.uninit_fcodual-Tuple{P} where P" href="#Mooncake.uninit_fcodual-Tuple{P} where P"><code>Mooncake.uninit_fcodual</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">uninit_fcodual(x)</code></pre><p>Like <code>zero_fcodual</code>, but doesn&#39;t guarantee that the value of the fdata is initialised. See implementation for details, as this function is subject to change.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/codual.jl#L83-L88">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.uninit_fdata-Tuple{Any}" href="#Mooncake.uninit_fdata-Tuple{Any}"><code>Mooncake.uninit_fdata</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">uninit_fdata(p)</code></pre><p>Equivalent to <code>fdata(uninit_tangent(p))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L270-L274">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.uninit_tangent-Tuple{Any}" href="#Mooncake.uninit_tangent-Tuple{Any}"><code>Mooncake.uninit_tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">uninit_tangent(x)</code></pre><p>Related to <code>zero_tangent</code>, but a bit different. Check current implementation for details – this docstring is intentionally non-specific in order to avoid becoming outdated.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L559-L564">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.verify_fdata_type-Tuple{Type, Type}" href="#Mooncake.verify_fdata_type-Tuple{Type, Type}"><code>Mooncake.verify_fdata_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">verify_fdata_type(P::Type, F::Type)::Nothing</code></pre><p>Check that <code>F</code> is a valid type for fdata associated to a primal of type <code>P</code>. Returns <code>nothing</code> if valid, throws an <code>InvalidFDataException</code> if a problem is found.</p><p>This applies to both concrete and non-concrete <code>P</code>. For example, if <code>P</code> is the type inferred for a primal <code>q::Q</code>, such that <code>Q &lt;: P</code>, then this method is still applicable.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L286-L294">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.verify_fdata_value-Tuple{Any, Any}" href="#Mooncake.verify_fdata_value-Tuple{Any, Any}"><code>Mooncake.verify_fdata_value</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">verify_fdata_value(p, f)::Nothing</code></pre><p>Check that <code>f</code> cannot be proven to be invalid fdata for <code>p</code>.</p><p>This method attempts to provide some confidence that <code>f</code> is valid fdata for <code>p</code> by checking a collection of necessary conditions. We do not guarantee that these amount to a sufficient condition, just that they rule out a variety of common problems.</p><p>Put differently, we cannot prove that <code>f</code> is valid fdata, only that it is not obviously invalid.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L301-L312">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.verify_no_constant_gotoifnots-Tuple{Core.Compiler.IRCode}" href="#Mooncake.verify_no_constant_gotoifnots-Tuple{Core.Compiler.IRCode}"><code>Mooncake.verify_no_constant_gotoifnots</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">verify_no_constant_gotoifnots(ir::IRCode)</code></pre><p>Verify that we have successfully removed all instances of <code>goto %n if not true</code> and <code>goto %n if not false</code>, as these can be reduced to simpler nodes (namely, <code>GotoNode</code>s or &quot;fallthrough&quot;s). Moreover, removing them tends to yield performance improvements by reducing the amount of information Mooncake must keep in its block stacks.</p><p>This is essentially just testing functionality for <code>const_prop_constant_gotoifnots</code>. This is usually run each time a rule is compiled, as it is cheap, and because it is hard to construct a convincing set of test cases which, if passed at test-time, would indicate we were done.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/ir_normalisation.jl#L469-L481">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.verify_rdata_type-Tuple{Type, Type}" href="#Mooncake.verify_rdata_type-Tuple{Type, Type}"><code>Mooncake.verify_rdata_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">verify_rdata_type(P::Type, R::Type)::Nothing</code></pre><p>Check that <code>R</code> is a valid type for rdata associated to a primal of type <code>P</code>. Returns <code>nothing</code> if valid, throws an <code>InvalidRDataException</code> if a problem is found.</p><p>This applies to both concrete and non-concrete <code>P</code>. For example, if <code>P</code> is the type inferred for a primal <code>q::Q</code>, such that <code>Q &lt;: P</code>, then this method is still applicable.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L742-L750">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.verify_rdata_value-Tuple{Any, Any}" href="#Mooncake.verify_rdata_value-Tuple{Any, Any}"><code>Mooncake.verify_rdata_value</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">verify_rdata_value(p, r)::Nothing</code></pre><p>Check that <code>r</code> cannot be proven to be invalid rdata for <code>p</code>.</p><p>This method attempts to provide some confidence that <code>r</code> is valid rdata for <code>p</code> by checking a collection of necessary conditions. We do not guarantee that these amount to a sufficient condition, just that they rule out a variety of common problems.</p><p>Put differently, we cannot prove that <code>r</code> is valid rdata, only that it is not obviously invalid.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L757-L768">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_adjoint-Union{Tuple{N}, Tuple{Mooncake.CoDual, Vararg{Mooncake.CoDual, N}}} where N" href="#Mooncake.zero_adjoint-Union{Tuple{N}, Tuple{Mooncake.CoDual, Vararg{Mooncake.CoDual, N}}} where N"><code>Mooncake.zero_adjoint</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_adjoint(f::CoDual, x::Vararg{CoDual, N}) where {N}</code></pre><p>Utility functionality for constructing <code>rrule!!</code>s for functions which produce adjoints which always return zero.</p><p>NOTE: you should only make use of this function if you cannot make use of the <a href="#Mooncake.@zero_adjoint-Tuple{Any, Any}"><code>@zero_adjoint</code></a> macro.</p><p>You make use of this functionality by writing a method of <code>Mooncake.rrule!!</code>, and passing all of its arguments (including the function itself) to this function. For example:</p><pre><code class="language-julia-repl hljs">julia&gt; import Mooncake: zero_adjoint, DefaultCtx, zero_fcodual, rrule!!, is_primitive, CoDual

julia&gt; foo(x::Vararg{Int}) = 5
foo (generic function with 1 method)

julia&gt; is_primitive(::Type{DefaultCtx}, ::Type{&lt;:Tuple{typeof(foo), Vararg{Int}}}) = true;

julia&gt; rrule!!(f::CoDual{typeof(foo)}, x::Vararg{CoDual{Int}}) = zero_adjoint(f, x...);

julia&gt; rrule!!(zero_fcodual(foo), zero_fcodual(3), zero_fcodual(2))[2](NoRData())
(NoRData(), NoRData(), NoRData())</code></pre><p>WARNING: this is only correct if the output of <code>primal(f)(map(primal, x)...)</code> does not alias anything in <code>f</code> or <code>x</code>. This is always the case if the result is a bits type, but more care may be required if it is not. ```</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tools_for_rules.jl#L111-L140">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_codual-Tuple{Any}" href="#Mooncake.zero_codual-Tuple{Any}"><code>Mooncake.zero_codual</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_codual(x)</code></pre><p>Equivalent to <code>CoDual(x, zero_tangent(x))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/codual.jl#L20-L24">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_like_rdata_from_type-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.zero_like_rdata_from_type-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.zero_like_rdata_from_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_like_rdata_from_type(::Type{P}) where {P}</code></pre><p>This is an internal implementation detail – you should generally not use this function.</p><p>Returns <em>either</em> the zero element of type <code>rdata_type(tangent_type(P))</code>, or a <code>ZeroRData</code>. It is always valid to return a <code>ZeroRData</code>, </p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/zero_like_rdata.jl#L29-L36">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_like_rdata_type-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.zero_like_rdata_type-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.zero_like_rdata_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_like_rdata_type(::Type{P}) where {P}</code></pre><p>Indicates the type which will be returned by <code>zero_like_rdata_from_type</code>. Will be the rdata type for <code>P</code> if we can produce the zero rdata element given only <code>P</code>, and will be the union of <code>R</code> and <code>ZeroRData</code> if an instance of <code>P</code> is needed.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/zero_like_rdata.jl#L17-L23">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_rdata-Tuple{Any}" href="#Mooncake.zero_rdata-Tuple{Any}"><code>Mooncake.zero_rdata</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_rdata(p)</code></pre><p>Given value <code>p</code>, return the zero element associated to its reverse data type.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L570-L574">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_rdata_from_type-Union{Tuple{Type{P}}, Tuple{P}} where P" href="#Mooncake.zero_rdata_from_type-Union{Tuple{Type{P}}, Tuple{P}} where P"><code>Mooncake.zero_rdata_from_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_rdata_from_type(::Type{P}) where {P}</code></pre><p>Returns the zero element of <code>rdata_type(tangent_type(P))</code> if this is possible given only <code>P</code>. If not possible, returns an instance of <code>CannotProduceZeroRDataFromType</code>.</p><p>For example, the zero rdata associated to any primal of type <code>Float64</code> is <code>0.0</code>, so for <code>Float64</code>s this function is simple. Similarly, if the rdata type for <code>P</code> is <code>NoRData</code>, that can simply be returned.</p><p>However, it is not possible to return the zero rdata element for abstract types e.g. <code>Real</code> as the type does not uniquely determine the zero element – the rdata type for <code>Real</code> is <code>Any</code>.</p><p>These considerations apply recursively to tuples / namedtuples / structs, etc.</p><p>If you encounter a type which this function returns <code>CannotProduceZeroRDataFromType</code>, but you believe this is done in error, please open an issue. This kind of problem does not constitute a correctness problem, but can be detrimental to performance, so should be dealt with.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L658-L678">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_tangent-Tuple{Any, Mooncake.NoFData}" href="#Mooncake.zero_tangent-Tuple{Any, Mooncake.NoFData}"><code>Mooncake.zero_tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_tangent(primal, fdata)</code></pre><p>Equivalent to <code>tangent(fdata, rdata(zero_tangent(primal)))</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/fwds_rvs_data.jl#L987-L991">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_tangent-Tuple{Any}" href="#Mooncake.zero_tangent-Tuple{Any}"><code>Mooncake.zero_tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_tangent(x)</code></pre><p>Returns the unique zero element of the tangent space of <code>x</code>. It is an error for the zero element of the tangent space of <code>x</code> to be represented by anything other than that which this function returns.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L459-L465">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_tangent_internal-Tuple{Union{Int128, Int16, Int32, Int64, Int8}, Union{Mooncake.NoCache, IdDict{Any, Any}}}" href="#Mooncake.zero_tangent_internal-Tuple{Union{Int128, Int16, Int32, Int64, Int8}, Union{Mooncake.NoCache, IdDict{Any, Any}}}"><code>Mooncake.zero_tangent_internal</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_tangent_internal(x, d::MaybeCache)</code></pre><p>Implementation of <a href="#Mooncake.zero_tangent-Tuple{Any, Mooncake.NoFData}"><code>zero_tangent</code></a>. Makes use of <code>d</code> in the same way that <code>Base.deepcopy_internal</code> makes use of an <code>IdDict</code> (see the docstring for <code>Base.deepcopy</code> for information).</p><p>In particular, it should be used to ensure that aliasing relationships are respected, meaning that if in the tuple <code>x = (a, b)</code>, <code>a === b</code>, then in <code>(da, db) = zero_tangent((a, b))</code> it must hold that should have that <code>da === db</code>. You may want to consult the method of <code>zero_tangent_internal</code> for <code>struct</code> and <code>mutable struct</code> types for inspiration if implementing this for your own type.</p><p>Similarly, if <code>x</code> contains a one or more circular, its tangent will probably need to contain similar circular references (unless it is something trivial like <code>NoTangent</code>). Again, consult existing implementations for inspiration.</p><p>If <code>d</code> is a <code>NoCache</code> assume that <code>x</code> contains neither aliasing nor circular references.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L471-L489">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@foldable-Tuple{Any}" href="#Mooncake.@foldable-Tuple{Any}"><code>Mooncake.@foldable</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">macro foldable def</code></pre><p>Shorthand for <code>Base.@assume_effects :foldable function f(x)...</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tangents.jl#L140-L144">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@from_rrule" href="#Mooncake.@from_rrule"><code>Mooncake.@from_rrule</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@from_rrule ctx sig [has_kwargs=false]</code></pre><p>Convenience functionality to assist in using <code>ChainRulesCore.rrule</code>s to write <code>rrule!!</code>s.</p><p><strong>Arguments</strong></p><ul><li><code>ctx</code>: A Mooncake context type</li><li><code>sig</code>: the signature which you wish to assert should be a primitive in <code>Mooncake.jl</code>, and   use an existing <code>ChainRulesCore.rrule</code> to implement this functionality.</li><li><code>has_kwargs</code>: a <code>Bool</code> state whether or not the function has keyword arguments. This   feature has the same limitations as <code>ChainRulesCore.rrule</code> – the derivative w.r.t. all   kwargs must be zero.</li></ul><p><strong>Example Usage</strong></p><p><strong>A Basic Example</strong></p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @from_rrule, DefaultCtx, rrule!!, zero_fcodual, TestUtils

julia&gt; import ChainRulesCore

julia&gt; foo(x::Real) = 5x;

julia&gt; function ChainRulesCore.rrule(::typeof(foo), x::Real)
           foo_pb(Ω::Real) = ChainRulesCore.NoTangent(), 5Ω
           return foo(x), foo_pb
       end;

julia&gt; @from_rrule DefaultCtx Tuple{typeof(foo), Base.IEEEFloat}

julia&gt; rrule!!(zero_fcodual(foo), zero_fcodual(5.0))[2](1.0)
(NoRData(), 5.0)

julia&gt; # Check that the rule works as intended.
       TestUtils.test_rule(Xoshiro(123), foo, 5.0; is_primitive=true)
Test Passed</code></pre><p><strong>An Example with Keyword Arguments</strong></p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @from_rrule, DefaultCtx, rrule!!, zero_fcodual, TestUtils

julia&gt; import ChainRulesCore

julia&gt; foo(x::Real; cond::Bool) = cond ? 5x : 4x;

julia&gt; function ChainRulesCore.rrule(::typeof(foo), x::Real; cond::Bool)
           foo_pb(Ω::Real) = ChainRulesCore.NoTangent(), cond ? 5Ω : 4Ω
           return foo(x; cond), foo_pb
       end;

julia&gt; @from_rrule DefaultCtx Tuple{typeof(foo), Base.IEEEFloat} true

julia&gt; _, pb = rrule!!(
           zero_fcodual(Core.kwcall),
           zero_fcodual((cond=false, )),
           zero_fcodual(foo),
           zero_fcodual(5.0),
       );

julia&gt; pb(3.0)
(NoRData(), NoRData(), NoRData(), 12.0)

julia&gt; # Check that the rule works as intended.
       TestUtils.test_rule(
           Xoshiro(123), Core.kwcall, (cond=false, ), foo, 5.0; is_primitive=true
       )
Test Passed</code></pre><p>Notice that, in order to access the kwarg method we must call the method of <code>Core.kwcall</code>, as Mooncake&#39;s <code>rrule!!</code> does not itself permit the use of kwargs.</p><p><strong>Limitations</strong></p><p>It is your responsibility to ensure that</p><ol><li>calls with signature <code>sig</code> do not mutate their arguments,</li><li>the output of calls with signature <code>sig</code> does not alias any of the inputs.</li></ol><p>As with all hand-written rules, you should definitely make use of <a href="#Mooncake.TestUtils.test_rule-Tuple{Random.AbstractRNG, Vararg{Any}}"><code>TestUtils.test_rule</code></a> to verify correctness on some test cases.</p><p><strong>Argument Type Constraints</strong></p><p>Many methods of <code>ChainRuleCore.rrule</code> are implemented with very loose type constraints. For example, it would not be surprising to see a method of rrule with the signature</p><pre><code class="language-julia hljs">Tuple{typeof(rrule), typeof(foo), Real, AbstractVector{&lt;:Real}}</code></pre><p>There are a variety of reasons for this way of doing things, and whether it is a good idea to write rules for such generic objects has been debated at length.</p><p>Suffice it to say, you should not write rules for <em>this</em> package which are so generically typed. Rather, you should create rules for the subset of types for which you believe that the <code>ChainRulesCore.rrule</code> will work correctly, and leave this package to derive rules for the rest. For example, it is quite common to be confident that a given rule will work correctly for any <code>Base.IEEEFloat</code> argument, i.e. <code>Union{Float16, Float32, Float64}</code>, but it is usually not possible to know that the rule is correct for all possible subtypes of <code>Real</code> that someone might define.</p><p><strong>Conversions Between Different Tangent Type Systems</strong></p><p>Under the hood, this functionality relies on two functions: <code>Mooncake.to_cr_tangent</code>, and <code>Mooncake.increment_and_get_rdata!</code>. These two functions handle conversion to / from <code>Mooncake</code> tangent types and <code>ChainRulesCore</code> tangent types. This functionality is known to work well for simple types, but has not been tested to a great extent on complicated composite types. If <code>@from_rrule</code> does not work in your case because the required method of either of these functions does not exist, please open an issue.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tools_for_rules.jl#L340-L452">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@is_primitive-Tuple{Any, Any}" href="#Mooncake.@is_primitive-Tuple{Any, Any}"><code>Mooncake.@is_primitive</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@is_primitive context_type signature</code></pre><p>Creates a method of <code>is_primitive</code> which always returns <code>true</code> for the context_type and <code>signature</code> provided. For example</p><pre><code class="language-julia hljs">@is_primitive MinimalCtx Tuple{typeof(foo), Float64}</code></pre><p>is equivalent to</p><pre><code class="language-julia hljs">is_primitive(::Type{MinimalCtx}, ::Type{&lt;:Tuple{typeof(foo), Float64}}) = true</code></pre><p>You should implemented more complicated method of <code>is_primitive</code> in the usual way.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/interpreter/contexts.jl#L38-L52">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@mooncake_overlay-Tuple{Any}" href="#Mooncake.@mooncake_overlay-Tuple{Any}"><code>Mooncake.@mooncake_overlay</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@mooncake_overlay method_expr</code></pre><p>Define a method of a function which only Mooncake can see. This can be used to write versions of methods which can be successfully differentiated by Mooncake if the original cannot be.</p><p>For example, suppose that you have a function</p><pre><code class="language-julia-repl hljs">julia&gt; foo(x::Float64) = bar(x)
foo (generic function with 1 method)</code></pre><p>where Mooncake.jl fails to differentiate <code>bar</code> for some reason. If you have access to another function <code>baz</code>, which does the same thing as <code>bar</code>, but does     so in a way which Mooncake.jl can differentiate, you can simply write:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.@mooncake_overlay foo(x::Float64) = baz(x)
</code></pre><p>When looking up the code for <code>foo(::Float64)</code>, Mooncake.jl will see this method, rather than the original, and differentiate it instead.</p><p><strong>A Worked Example</strong></p><p>To demonstrate how to use <code>@mooncake_overlay</code>s in practice, we here demonstrate how the answer that Mooncake.jl gives changes if you change the definition of a function using a <code>@mooncake_overlay</code>. Do not do this in practice – this is just a simple way to demonostrate how to use overlays!</p><p>First, consider a simple example:</p><pre><code class="language-julia-repl hljs">julia&gt; scale(x) = 2x
scale (generic function with 1 method)

julia&gt; rule = Mooncake.build_rrule(Tuple{typeof(scale), Float64});

julia&gt; Mooncake.value_and_gradient!!(rule, scale, 5.0)
(10.0, (NoTangent(), 2.0))</code></pre><p>We can use <code>@mooncake_overlay</code> to change the definition which Mooncake.jl sees:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.@mooncake_overlay scale(x) = 3x

julia&gt; rule = Mooncake.build_rrule(Tuple{typeof(scale), Float64});

julia&gt; Mooncake.value_and_gradient!!(rule, scale, 5.0)
(15.0, (NoTangent(), 3.0))</code></pre><p>As can be seen from the output, the result of differentiating using Mooncake.jl has changed to reflect the overlay-ed definition of the method.</p><p>Additionally, it is possible to use the usual multi-line syntax to declare an overlay:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.@mooncake_overlay function scale(x)
           return 4x
       end

julia&gt; rule = Mooncake.build_rrule(Tuple{typeof(scale), Float64});

julia&gt; Mooncake.value_and_gradient!!(rule, scale, 5.0)
(20.0, (NoTangent(), 4.0))</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tools_for_rules.jl#L33-L96">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@zero_adjoint-Tuple{Any, Any}" href="#Mooncake.@zero_adjoint-Tuple{Any, Any}"><code>Mooncake.@zero_adjoint</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@zero_adjoint ctx sig</code></pre><p>Defines <code>is_primitive(context_type, sig) = true</code>, and defines a method of <code>Mooncake.rrule!!</code> which returns zero for all inputs. Users of ChainRules.jl should be familiar with this functionality – it is morally the same as <code>ChainRulesCore.@non_differentiable</code>.</p><p>For example:</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @zero_adjoint, DefaultCtx, zero_fcodual, rrule!!, is_primitive

julia&gt; foo(x) = 5
foo (generic function with 1 method)

julia&gt; @zero_adjoint DefaultCtx Tuple{typeof(foo), Any}

julia&gt; is_primitive(DefaultCtx, Tuple{typeof(foo), Any})
true

julia&gt; rrule!!(zero_fcodual(foo), zero_fcodual(3.0))[2](NoRData())
(NoRData(), 0.0)</code></pre><p>Limited support for <code>Vararg</code>s is also available. For example</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @zero_adjoint, DefaultCtx, zero_fcodual, rrule!!, is_primitive

julia&gt; foo_varargs(x...) = 5
foo_varargs (generic function with 1 method)

julia&gt; @zero_adjoint DefaultCtx Tuple{typeof(foo_varargs), Vararg}

julia&gt; is_primitive(DefaultCtx, Tuple{typeof(foo_varargs), Any, Float64, Int})
true

julia&gt; rrule!!(zero_fcodual(foo_varargs), zero_fcodual(3.0), zero_fcodual(5))[2](NoRData())
(NoRData(), 0.0, NoRData())</code></pre><p>Be aware that it is not currently possible to specify any of the type parameters of the <code>Vararg</code>. For example, the signature <code>Tuple{typeof(foo), Vararg{Float64, 5}}</code> will not work with this macro.</p><p>WARNING: this is only correct if the output of the function does not alias any fields of the function, or any of its arguments. For example, applying this macro to the function <code>x -&gt; x</code> will yield incorrect results.</p><p>As always, you should use <a href="#Mooncake.TestUtils.test_rule-Tuple{Random.AbstractRNG, Vararg{Any}}"><code>TestUtils.test_rule</code></a> to ensure that you&#39;ve not made a mistake.</p><p><strong>Signatures Unsupported By This Macro</strong></p><p>If the signature you wish to apply <code>@zero_adjoint</code> to is not supported, for example because it uses a <code>Vararg</code> with a type parameter, you can still make use of <a href="#Mooncake.zero_adjoint-Union{Tuple{N}, Tuple{Mooncake.CoDual, Vararg{Mooncake.CoDual, N}}} where N"><code>zero_adjoint</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/tools_for_rules.jl#L145-L200">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.address_maps_are_consistent-Tuple{Dict{Ptr{Nothing}, Ptr{Nothing}}, Dict{Ptr{Nothing}, Ptr{Nothing}}}" href="#Mooncake.TestUtils.address_maps_are_consistent-Tuple{Dict{Ptr{Nothing}, Ptr{Nothing}}, Dict{Ptr{Nothing}, Ptr{Nothing}}}"><code>Mooncake.TestUtils.address_maps_are_consistent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">address_maps_are_consistent(x::AddressMap, y::AddressMap)</code></pre><p><code>true</code> if all keys in both <code>x</code> and <code>y</code> map to the same values. i.e. if any key appears in both <code>x</code> and <code>y</code>, and the corresponding value is not the same in both <code>x</code> and <code>y</code>, return <code>false</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L396-L402">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.has_equal_data-Tuple{Any, Any}" href="#Mooncake.TestUtils.has_equal_data-Tuple{Any, Any}"><code>Mooncake.TestUtils.has_equal_data</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">has_equal_data(x, y; equal_undefs=true)</code></pre><p>Determine if two objects <code>x</code> and <code>y</code> have equivalent data. If <code>equal_undefs</code>  is <code>true</code>, undefined elements in arrays or unassigned fields in structs are  considered equal.</p><p>The main logic is implemented in <code>has_equal_data_internal</code>, which is a recursive function that takes an additional <code>visited</code> dictionary to track visited objects and avoid infinite recursion in cases of circular references.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L172-L182">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.is_foldable-Tuple{Any, Any}" href="#Mooncake.TestUtils.is_foldable-Tuple{Any, Any}"><code>Mooncake.TestUtils.is_foldable</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_foldable(f, types)::Bool</code></pre><p><code>true</code> if the effects inferred for the application of <code>f</code> to arguments of type <code>types</code> indicate that the compiler believes such a call can be constant-folded.</p><p>See the docstrings for <code>Base.@infer_effects</code> and <code>Base.infer_effects</code> for more information on the effects system in Julia.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L770-L778">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.populate_address_map-Tuple{Any, Any}" href="#Mooncake.TestUtils.populate_address_map-Tuple{Any, Any}"><code>Mooncake.TestUtils.populate_address_map</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">populate_address_map(primal, tangent)</code></pre><p>Constructs an empty <code>AddressMap</code> and calls <code>populate_address_map_internal</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L307-L311">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.populate_address_map_internal-Union{Tuple{T}, Tuple{P}, Tuple{Dict{Ptr{Nothing}, Ptr{Nothing}}, P, T}} where {P, T}" href="#Mooncake.TestUtils.populate_address_map_internal-Union{Tuple{T}, Tuple{P}, Tuple{Dict{Ptr{Nothing}, Ptr{Nothing}}, P, T}} where {P, T}"><code>Mooncake.TestUtils.populate_address_map_internal</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">populate_address_map_internal(m::AddressMap, primal, tangent)</code></pre><p>Fills <code>m</code> with pairs mapping from memory addresses in <code>primal</code> to corresponding memory addresses in <code>tangent</code>. If the same memory address appears multiple times in <code>primal</code>, throws an <code>AssertionError</code> if the same address is not mapped to in <code>tangent</code> each time.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L316-L322">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_data-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P" href="#Mooncake.TestUtils.test_data-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P"><code>Mooncake.TestUtils.test_data</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_data(rng::AbstractRNG, p::P)</code></pre><p>Verify that all tangent / fdata / rdata functionality work properly for <code>p</code>. Furthermore, verify that all primitives listed in <code>TestUtils.test_rule_and_type_interactions</code> work correctly on <code>p</code>. This functionality is particularly useful if you are writing your own custom tangent / fdata / rdata types and want to be confident that you have implemented the functionality that you need in order to make these custom types work with all the rules written in Mooncake itself.</p><p>You should consult the docstrings for <a href="../tangents/#Mooncake.TestUtils.test_tangent_interface"><code>test_tangent_interface</code></a>, <a href="../tangents/#Mooncake.TestUtils.test_tangent_splitting"><code>test_tangent_splitting</code></a>, and <a href="../tangents/#Mooncake.TestUtils.test_rule_and_type_interactions"><code>test_rule_and_type_interactions</code></a>, in order to see what is required to satisfy the full tangent interface for <code>p</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L1354-L1367">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_rule-Tuple{Random.AbstractRNG, Vararg{Any}}" href="#Mooncake.TestUtils.test_rule-Tuple{Random.AbstractRNG, Vararg{Any}}"><code>Mooncake.TestUtils.test_rule</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_rule(
    rng, x...;
    interface_only=false,
    is_primitive::Bool=true,
    perf_flag::Symbol=:none,
    interp::Mooncake.MooncakeInterpreter=Mooncake.get_interpreter(),
    debug_mode::Bool=false,
    unsafe_perturb::Bool=false,
)</code></pre><p>Run standardised tests on the <code>rule</code> for <code>x</code>. The first element of <code>x</code> should be the primal function to test, and each other element a positional argument. In most cases, elements of <code>x</code> can just be the primal values, and <code>randn_tangent</code> can be relied upon to generate an appropriate tangent to test. Some notable exceptions exist though, in partcular <code>Ptr</code>s. In this case, the argument for which <code>randn_tangent</code> cannot be readily defined should be a <code>CoDual</code> containing the primal, and a <em>manually</em> constructed tangent field.</p><p>This function uses <a href="#Mooncake.build_rrule-Tuple"><code>Mooncake.build_rrule</code></a> to construct a rule. This will use an <code>rrule!!</code> if one exists, and derive a rule otherwise.</p><p><strong>Arguments</strong></p><ul><li><code>rng::AbstractRNG</code>: a random number generator</li><li><code>x...</code>: the function (first element) and its arguments (the remainder)</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>interface_only::Bool=false</code>: test only that the interface is satisfied, without testing   correctness. This should generally be set to <code>false</code> (the default value), and only   enabled if the testing infrastructure is unable to test correctness for some reason   e.g. the returned value of the function is a <code>Ptr</code>, and appropriate tangents cannot,   therefore, be generated for it automatically.</li><li><code>is_primitive::Bool=true</code>: check whether the thing that you are testing has a hand-written   <code>rrule!!</code>. This option is helpful if you are testing a new <code>rrule!!</code>, as it enables you   to verify that your method of <code>is_primitive</code> has returned the correct value, and that   you are actually testing a method of the <code>rrule!!</code> function – a common mistake when   authoring a new <code>rrule!!</code> is to implement <code>is_primitive</code> incorrectly and to accidentally   wind up testing a rule which Mooncake has derived, as opposed to the one that you have   written. If you are testing something for which you have not   hand-written an <code>rrule!!</code>, or which you do not care whether it has a hand-written   <code>rrule!!</code> or not, you should set it to <code>false</code>.</li><li><code>perf_flag::Symbol=:none</code>: the value of this symbol determines what kind of performance   tests should be performed. By default, none are performed. If you believe that a rule   should be allocation-free (iff the primal is allocation free), set this to <code>:allocs</code>. If   you hand-write an <code>rrule!!</code> and believe that your test case should be type stable, set   this to <code>:stability</code> (at present we cannot verify whether a derived rule is type stable   for technical reasons). If you believe that a hand-written rule should be <em>both</em>   allocation-free and type-stable, set this to <code>:stability_and_allocs</code>.</li><li><code>interp::Mooncake.MooncakeInterpreter=Mooncake.get_interpreter()</code>: the abstract   interpreter to be used when testing this rule. The default should generally be used.</li><li><code>debug_mode::Bool=false</code>: whether or not the rule should be tested in debug mode.   Typically this should be left at its default <code>false</code> value, but if you are finding that   the tests are failing for a given rule, you may wish to temporarily set it to <code>true</code> in   order to get access to additional information and automated testing.</li><li><code>unsafe_perturb::Bool=false</code>: value passed as the third argument to <code>_add_to_primal</code>.   Should usually be left <code>false</code> – consult the docstring for <code>_add_to_primal</code> for more   info on when you might wish to set it to <code>true</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L625-L683">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_rule_and_type_interactions-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P" href="#Mooncake.TestUtils.test_rule_and_type_interactions-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P"><code>Mooncake.TestUtils.test_rule_and_type_interactions</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_rule_and_type_interactions(rng::AbstractRNG, p)</code></pre><p>Check that a collection of standard functions for which we <em>ought</em> to have a working rrule for <code>p</code> work, and produce the correct answer. For example, the <code>rrule!!</code> for <code>typeof</code> should work correctly on any type, we should have a working rule for <code>getfield</code> for any struct-type, and we should have a rule for <code>setfield!</code> for any mutable struct type. See extended help for more info.</p><p><strong>Extended Help</strong></p><p>The purpose of this test is to ensure that, for any given <code>p</code>, the full range of primitive functions that <em>ought</em> to work on it, do indeed work on it.</p><p>This is one part of the interface where some care <em>might</em> be required. If, for some reason, it should <em>never</em> be the case that e.g. for a particular <code>p</code>, <code>getfield</code> should be called, then it may make no sense at all to run these tests. In such cases, the author of the type is responsible for knowing what they are doing. Please open an issue to discuss for your type if you are at all unsure what to do.</p><p>When defining a custom tangent type for <code>P</code>, the functions that you will need to pay attention to writing rules for are</p><ul><li><a href="#Mooncake._new_-Union{Tuple{N}, Tuple{T}, Tuple{Type{T}, Vararg{Any, N}}} where {T, N}"><code>Mooncake._new_</code></a></li><li><a href="#Mooncake.lgetfield-Union{Tuple{f}, Tuple{Any, Val{f}}} where f"><code>Mooncake.lgetfield</code></a></li><li><a href="#Mooncake.lsetfield!-Union{Tuple{name}, Tuple{Any, Val{name}, Any}} where name"><code>Mooncake.lsetfield!</code></a></li></ul><p>In all cases, you may wish to consult the current implementations of <code>rrule!!</code> for these functions for inspiration regarding how you might implement them for your type.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L1220-L1248">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent-Tuple{Random.AbstractRNG, Any, Any}" href="#Mooncake.TestUtils.test_tangent-Tuple{Random.AbstractRNG, Any, Any}"><code>Mooncake.TestUtils.test_tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent(rng::AbstractRNG, p, T; interface_only=false, perf=true)</code></pre><p>Like <code>test_tangent(rng, p)</code>, but also checks that <code>tangent_type(typeof(p)) == T</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L748-L752">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent-Tuple{Random.AbstractRNG, Any}" href="#Mooncake.TestUtils.test_tangent-Tuple{Random.AbstractRNG, Any}"><code>Mooncake.TestUtils.test_tangent</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent(rng::AbstractRNG, p; interface_only=false, perf=true)</code></pre><p>Test that standard tangent-related functionality works for <code>p</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L759-L763">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent_interface-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P" href="#Mooncake.TestUtils.test_tangent_interface-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P"><code>Mooncake.TestUtils.test_tangent_interface</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent_interface(rng::AbstractRNG, p; interface_only=false)</code></pre><p>Verify that standard functionality for tangents runs, and is consistent. This function is the defacto formal definition of the &quot;tangent interface&quot; – if this function runs without error for a given value of <code>p</code>, then that <code>p</code> satisfies the tangent interface.</p><p><strong>Extended Help</strong></p><p>Verifies that the following functions are implemented correctly (as far as possible) for <code>p</code> / its type, and its tangents / their type:</p><ul><li><a href="#Mooncake.tangent_type-Tuple{Any}"><code>Mooncake.tangent_type</code></a></li><li><a href="#Mooncake.zero_tangent_internal-Tuple{Union{Int128, Int16, Int32, Int64, Int8}, Union{Mooncake.NoCache, IdDict{Any, Any}}}"><code>Mooncake.zero_tangent_internal</code></a></li><li><a href="#Mooncake.randn_tangent_internal-Union{Tuple{P}, Tuple{Random.AbstractRNG, P, Union{Mooncake.NoCache, IdDict{Any, Any}}}} where P&lt;:Union{Float16, Float32, Float64}"><code>Mooncake.randn_tangent_internal</code></a></li><li><a href="#Mooncake.TestUtils.has_equal_data-Tuple{Any, Any}"><code>Mooncake.TestUtils.has_equal_data</code></a></li><li><a href="#Mooncake.increment_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent, Mooncake.NoTangent}"><code>Mooncake.increment_internal!!</code></a></li><li><a href="#Mooncake.set_to_zero_internal!!-Tuple{Union{Mooncake.NoCache, IdDict{Any, Bool}}, Mooncake.NoTangent}"><code>Mooncake.set_to_zero_internal!!</code></a></li><li><a href="#Mooncake._add_to_primal_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Any, Mooncake.NoTangent, Bool}"><code>Mooncake._add_to_primal_internal</code></a></li><li><a href="#Mooncake._diff_internal-Union{Tuple{P}, Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, P, P}} where P"><code>Mooncake._diff_internal</code></a></li><li><a href="#Mooncake._dot_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Mooncake.NoTangent, Mooncake.NoTangent}"><code>Mooncake._dot_internal</code></a></li><li><a href="#Mooncake._scale_internal-Tuple{Union{Mooncake.NoCache, IdDict{Any, Any}}, Float64, Mooncake.NoTangent}"><code>Mooncake._scale_internal</code></a></li><li><a href="#Mooncake.TestUtils.populate_address_map_internal-Union{Tuple{T}, Tuple{P}, Tuple{Dict{Ptr{Nothing}, Ptr{Nothing}}, P, T}} where {P, T}"><code>Mooncake.TestUtils.populate_address_map_internal</code></a></li></ul><p>In conjunction with the functions tested by <a href="../tangents/#Mooncake.TestUtils.test_tangent_splitting"><code>test_tangent_splitting</code></a>, these functions constitute a complete set of functions which must be applicable to <code>p</code> in order to ensure that it operates correctly in the context of reverse-mode AD. This list should be up to date at any given point in time, but the best way to verify that you&#39;ve implemented everything is simply to run this function, and see whether it errors / produces a failing test.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L803-L831">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent_performance-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P" href="#Mooncake.TestUtils.test_tangent_performance-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P"><code>Mooncake.TestUtils.test_tangent_performance</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent_performance(rng::AbstractRNG, p::P) where {P}</code></pre><p>Runs a variety of performance-related tests on tangents. These tests constitute a set of necessary conditions for good overall performance.</p><p>The performance model in a few cases is a little bit complicated, because it depends on various properties of the type in question (is it mutable, are its fields mutable, are all of its fields necessarily defined, etc), so the source code should be consulted for precise details.</p><p><em>Note:</em> this function assumes that the tangent interface is implemented correctly for <code>p</code>. To verify that this is the case, ensure that all tests in <code>test_tangent_interface</code> pass.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L974-L987">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent_splitting-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P" href="#Mooncake.TestUtils.test_tangent_splitting-Union{Tuple{P}, Tuple{Random.AbstractRNG, P}} where P"><code>Mooncake.TestUtils.test_tangent_splitting</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent_splitting(rng::AbstractRNG, p::P; test_opt_flag=true) where {P}</code></pre><p>Verify that tangent splitting functionality associated to primal <code>p</code> works correctly. Ensure that <a href="../tangents/#Mooncake.TestUtils.test_tangent_interface"><code>test_tangent_interface</code></a> runs for <code>p</code> before running these tests. <code>test_opt_flag</code> controls whether to run JET-based checks. </p><p><strong>Extended Help</strong></p><p>Verifies that the following functionality work correctly for <code>p</code> / its type / tangents:</p><ul><li><a href="#Mooncake.fdata_type-Tuple{Any}"><code>Mooncake.fdata_type</code></a></li><li><a href="#Mooncake.rdata_type-Tuple{Any}"><code>Mooncake.rdata_type</code></a></li><li><a href="#Mooncake.fdata-Tuple{T} where T"><code>Mooncake.fdata</code></a></li><li><a href="#Mooncake.rdata-Tuple{T} where T"><code>Mooncake.rdata</code></a></li><li><a href="#Mooncake.uninit_fdata-Tuple{Any}"><code>Mooncake.uninit_fdata</code></a></li><li><a href="#Mooncake.tangent_type-Tuple{Any}"><code>Mooncake.tangent_type</code></a> (binary method)</li><li><a href="#Mooncake.tangent-Tuple{Mooncake.NoFData, Mooncake.NoRData}"><code>Mooncake.tangent</code></a> (binary method)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L1124-L1141">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_tangent_type-Tuple{Type, Type}" href="#Mooncake.TestUtils.test_tangent_type-Tuple{Type, Type}"><code>Mooncake.TestUtils.test_tangent_type</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_tangent_type(primal_type, expected_tangent_type)</code></pre><p>Checks that <code>tangent_type(primal_type)</code> yields <code>expected_tangent_type</code>, and that everything infers / optimises away, and that the effects are as expected.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/test_utils.jl#L788-L793">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.IntrinsicsWrappers" href="#Mooncake.IntrinsicsWrappers"><code>Mooncake.IntrinsicsWrappers</code></a> — <span class="docstring-category">Module</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">module IntrinsicsWrappers</code></pre><p>The purpose of this <code>module</code> is to associate to each function in <code>Core.Intrinsics</code> a regular Julia function.</p><p>To understand the rationale for this observe that, unlike regular Julia functions, each <code>Core.IntrinsicFunction</code> in <code>Core.Intrinsics</code> does <em>not</em> have its own type. Rather, they are instances of <code>Core.IntrinsicFunction</code>. To see this, observe that</p><pre><code class="language-julia-repl hljs">julia&gt; typeof(Core.Intrinsics.add_float)
Core.IntrinsicFunction

julia&gt; typeof(Core.Intrinsics.sub_float)
Core.IntrinsicFunction</code></pre><p>While we could simply write a rule for <code>Core.IntrinsicFunction</code>, this would (naively) lead to a large list of conditionals of the form</p><pre><code class="language-julia hljs">if f === Core.Intrinsics.add_float
    # return add_float and its pullback
elseif f === Core.Intrinsics.sub_float
    # return add_float and its pullback
elseif
    ...
end</code></pre><p>which has the potential to cause quite substantial type instabilities. (This might not be true anymore – see extended help for more context).</p><p>Instead, we map each <code>Core.IntrinsicFunction</code> to one of the regular Julia functions in <code>Mooncake.IntrinsicsWrappers</code>, to which we can dispatch in the usual way.</p><p><strong>Extended Help</strong></p><p>It is possible that owing to improvements in constant propagation in the Julia compiler in version 1.10, we actually <em>could</em> get away with just writing a single method of <code>rrule!!</code> to handle all intrinsics, so this dispatch-based mechanism might be unnecessary. Someone should investigate this. Discussed at https://github.com/chalk-lab/Mooncake.jl/issues/387 .</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/e3f17a92cbae636a346d683a9fef326759c15193/src/rrules/builtins.jl#L44-L84">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../misc_internals_notes/">« Misc. Internals Notes</a><a class="docs-footer-nextpage" href="../../known_limitations/">Known Limitations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.13.0 on <span class="colophon-date" title="Wednesday 25 June 2025 16:35">Wednesday 25 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
