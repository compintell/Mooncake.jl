<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Defining Rules · Mooncake.jl</title><meta name="title" content="Defining Rules · Mooncake.jl"/><meta property="og:title" content="Defining Rules · Mooncake.jl"/><meta property="twitter:title" content="Defining Rules · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li class="is-active"><a class="tocitem" href>Defining Rules</a><ul class="internal"><li><a class="tocitem" href="#Simplfiying-Code-via-Overlays"><span>Simplfiying Code via Overlays</span></a></li><li><a class="tocitem" href="#Functions-with-Zero-Adjoint"><span>Functions with Zero Adjoint</span></a></li><li><a class="tocitem" href="#Using-ChainRules.jl"><span>Using ChainRules.jl</span></a></li><li><a class="tocitem" href="#Adding-Methods-To-rrule!!-And-build_primitive_rrule"><span>Adding Methods To <code>rrule!!</code> And <code>build_primitive_rrule</code></span></a></li></ul></li><li><a class="tocitem" href="../debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../../developer_documentation/running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../../developer_documentation/developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../../developer_documentation/ir_representation/">IR Representation</a></li><li><a class="tocitem" href="../../developer_documentation/forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../../developer_documentation/reverse_mode_design/">Reverse-Mode Design</a></li><li><a class="tocitem" href="../../developer_documentation/misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="../../developer_documentation/internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Utilities</a></li><li class="is-active"><a href>Defining Rules</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Defining Rules</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl/blob/main/docs/src/utilities/defining_rules.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Defining-Rules"><a class="docs-heading-anchor" href="#Defining-Rules">Defining Rules</a><a id="Defining-Rules-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-Rules" title="Permalink"></a></h1><p>Most of the time, Mooncake.jl can just differentiate your code, but you will need to intervene if you make use of a language feature which is unsupported. However, this does not always necessitate writing your own <code>rrule!!</code> from scratch. In this section, we detail some useful strategies which can help you avoid having to write <code>rrule!!</code>s in many situations, which we discuss before discussing the more involved process of actually writing rules.</p><h2 id="Simplfiying-Code-via-Overlays"><a class="docs-heading-anchor" href="#Simplfiying-Code-via-Overlays">Simplfiying Code via Overlays</a><a id="Simplfiying-Code-via-Overlays-1"></a><a class="docs-heading-anchor-permalink" href="#Simplfiying-Code-via-Overlays" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@mooncake_overlay-utilities-defining_rules" href="#Mooncake.@mooncake_overlay-utilities-defining_rules"><code>Mooncake.@mooncake_overlay</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@mooncake_overlay method_expr</code></pre><p>Define a method of a function which only Mooncake can see. This can be used to write versions of methods which can be successfully differentiated by Mooncake if the original cannot be.</p><p>For example, suppose that you have a function</p><pre><code class="language-julia-repl hljs">julia&gt; foo(x::Float64) = bar(x)
foo (generic function with 1 method)</code></pre><p>where Mooncake.jl fails to differentiate <code>bar</code> for some reason. If you have access to another function <code>baz</code>, which does the same thing as <code>bar</code>, but does     so in a way which Mooncake.jl can differentiate, you can simply write:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.@mooncake_overlay foo(x::Float64) = baz(x)
</code></pre><p>When looking up the code for <code>foo(::Float64)</code>, Mooncake.jl will see this method, rather than the original, and differentiate it instead.</p><p><strong>A Worked Example</strong></p><p>To demonstrate how to use <code>@mooncake_overlay</code>s in practice, we here demonstrate how the answer that Mooncake.jl gives changes if you change the definition of a function using a <code>@mooncake_overlay</code>. Do not do this in practice – this is just a simple way to demonostrate how to use overlays!</p><p>First, consider a simple example:</p><pre><code class="language-julia-repl hljs">julia&gt; scale(x) = 2x
scale (generic function with 1 method)

julia&gt; rule = Mooncake.build_rrule(Tuple{typeof(scale), Float64});

julia&gt; Mooncake.value_and_gradient!!(rule, scale, 5.0)
(10.0, (NoTangent(), 2.0))</code></pre><p>We can use <code>@mooncake_overlay</code> to change the definition which Mooncake.jl sees:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.@mooncake_overlay scale(x) = 3x

julia&gt; rule = Mooncake.build_rrule(Tuple{typeof(scale), Float64});

julia&gt; Mooncake.value_and_gradient!!(rule, scale, 5.0)
(15.0, (NoTangent(), 3.0))</code></pre><p>As can be seen from the output, the result of differentiating using Mooncake.jl has changed to reflect the overlay-ed definition of the method.</p><p>Additionally, it is possible to use the usual multi-line syntax to declare an overlay:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.@mooncake_overlay function scale(x)
           return 4x
       end

julia&gt; rule = Mooncake.build_rrule(Tuple{typeof(scale), Float64});

julia&gt; Mooncake.value_and_gradient!!(rule, scale, 5.0)
(20.0, (NoTangent(), 4.0))</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/847f357d8b235bbd71416da48827db0e8a98e477/src/tools_for_rules.jl#L33-L96">source</a></section></article><h2 id="Functions-with-Zero-Adjoint"><a class="docs-heading-anchor" href="#Functions-with-Zero-Adjoint">Functions with Zero Adjoint</a><a id="Functions-with-Zero-Adjoint-1"></a><a class="docs-heading-anchor-permalink" href="#Functions-with-Zero-Adjoint" title="Permalink"></a></h2><p>If the above strategy does not work, but you find yourself in the surprisingly common situation that the adjoint of the derivative of your function is always zero, you can very straightforwardly write a rule by making use of the following:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@zero_adjoint-utilities-defining_rules" href="#Mooncake.@zero_adjoint-utilities-defining_rules"><code>Mooncake.@zero_adjoint</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@zero_adjoint ctx sig</code></pre><p>Defines <code>is_primitive(context_type, sig) = true</code>, and defines a method of <code>Mooncake.rrule!!</code> which returns zero for all inputs. Users of ChainRules.jl should be familiar with this functionality – it is morally the same as <code>ChainRulesCore.@non_differentiable</code>.</p><p>For example:</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @zero_adjoint, DefaultCtx, zero_fcodual, rrule!!, is_primitive

julia&gt; foo(x) = 5
foo (generic function with 1 method)

julia&gt; @zero_adjoint DefaultCtx Tuple{typeof(foo), Any}

julia&gt; is_primitive(DefaultCtx, Tuple{typeof(foo), Any})
true

julia&gt; rrule!!(zero_fcodual(foo), zero_fcodual(3.0))[2](NoRData())
(NoRData(), 0.0)</code></pre><p>Limited support for <code>Vararg</code>s is also available. For example</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @zero_adjoint, DefaultCtx, zero_fcodual, rrule!!, is_primitive

julia&gt; foo_varargs(x...) = 5
foo_varargs (generic function with 1 method)

julia&gt; @zero_adjoint DefaultCtx Tuple{typeof(foo_varargs), Vararg}

julia&gt; is_primitive(DefaultCtx, Tuple{typeof(foo_varargs), Any, Float64, Int})
true

julia&gt; rrule!!(zero_fcodual(foo_varargs), zero_fcodual(3.0), zero_fcodual(5))[2](NoRData())
(NoRData(), 0.0, NoRData())</code></pre><p>Be aware that it is not currently possible to specify any of the type parameters of the <code>Vararg</code>. For example, the signature <code>Tuple{typeof(foo), Vararg{Float64, 5}}</code> will not work with this macro.</p><p>WARNING: this is only correct if the output of the function does not alias any fields of the function, or any of its arguments. For example, applying this macro to the function <code>x -&gt; x</code> will yield incorrect results.</p><p>As always, you should use <a href="../debugging_and_mwes/#Mooncake.TestUtils.test_rule-utilities-debugging_and_mwes"><code>TestUtils.test_rule</code></a> to ensure that you&#39;ve not made a mistake.</p><p><strong>Signatures Unsupported By This Macro</strong></p><p>If the signature you wish to apply <code>@zero_adjoint</code> to is not supported, for example because it uses a <code>Vararg</code> with a type parameter, you can still make use of <a href="../../developer_documentation/internal_docstrings/#Mooncake.zero_adjoint-Union{Tuple{N}, Tuple{Mooncake.CoDual, Vararg{Mooncake.CoDual, N}}} where N"><code>zero_adjoint</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/847f357d8b235bbd71416da48827db0e8a98e477/src/tools_for_rules.jl#L145-L200">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.zero_adjoint-utilities-defining_rules" href="#Mooncake.zero_adjoint-utilities-defining_rules"><code>Mooncake.zero_adjoint</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">zero_adjoint(f::CoDual, x::Vararg{CoDual, N}) where {N}</code></pre><p>Utility functionality for constructing <code>rrule!!</code>s for functions which produce adjoints which always return zero.</p><p>NOTE: you should only make use of this function if you cannot make use of the <a href="../../developer_documentation/internal_docstrings/#Mooncake.@zero_adjoint-Tuple{Any, Any}"><code>@zero_adjoint</code></a> macro.</p><p>You make use of this functionality by writing a method of <code>Mooncake.rrule!!</code>, and passing all of its arguments (including the function itself) to this function. For example:</p><pre><code class="language-julia-repl hljs">julia&gt; import Mooncake: zero_adjoint, DefaultCtx, zero_fcodual, rrule!!, is_primitive, CoDual

julia&gt; foo(x::Vararg{Int}) = 5
foo (generic function with 1 method)

julia&gt; is_primitive(::Type{DefaultCtx}, ::Type{&lt;:Tuple{typeof(foo), Vararg{Int}}}) = true;

julia&gt; rrule!!(f::CoDual{typeof(foo)}, x::Vararg{CoDual{Int}}) = zero_adjoint(f, x...);

julia&gt; rrule!!(zero_fcodual(foo), zero_fcodual(3), zero_fcodual(2))[2](NoRData())
(NoRData(), NoRData(), NoRData())</code></pre><p>WARNING: this is only correct if the output of <code>primal(f)(map(primal, x)...)</code> does not alias anything in <code>f</code> or <code>x</code>. This is always the case if the result is a bits type, but more care may be required if it is not. ```</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/847f357d8b235bbd71416da48827db0e8a98e477/src/tools_for_rules.jl#L111-L140">source</a></section></article><h2 id="Using-ChainRules.jl"><a class="docs-heading-anchor" href="#Using-ChainRules.jl">Using ChainRules.jl</a><a id="Using-ChainRules.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Using-ChainRules.jl" title="Permalink"></a></h2><p><a href="https://github.com/JuliaDiff/ChainRules.jl">ChainRules.jl</a> provides a large number of rules for differentiating functions in reverse-mode. These rules are methods of the <code>ChainRulesCore.rrule</code> function. There are some instances where it is most convenient to implement a <code>Mooncake.rrule!!</code> by wrapping an existing <code>ChainRulesCore.rrule</code>.</p><p>There is enough similarity between these two systems that most of the boilerplate code can be avoided.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.@from_rrule-utilities-defining_rules" href="#Mooncake.@from_rrule-utilities-defining_rules"><code>Mooncake.@from_rrule</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@from_rrule ctx sig [has_kwargs=false]</code></pre><p>Convenience functionality to assist in using <code>ChainRulesCore.rrule</code>s to write <code>rrule!!</code>s.</p><p><strong>Arguments</strong></p><ul><li><code>ctx</code>: A Mooncake context type</li><li><code>sig</code>: the signature which you wish to assert should be a primitive in <code>Mooncake.jl</code>, and   use an existing <code>ChainRulesCore.rrule</code> to implement this functionality.</li><li><code>has_kwargs</code>: a <code>Bool</code> state whether or not the function has keyword arguments. This   feature has the same limitations as <code>ChainRulesCore.rrule</code> – the derivative w.r.t. all   kwargs must be zero.</li></ul><p><strong>Example Usage</strong></p><p><strong>A Basic Example</strong></p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @from_rrule, DefaultCtx, rrule!!, zero_fcodual, TestUtils

julia&gt; import ChainRulesCore

julia&gt; foo(x::Real) = 5x;

julia&gt; function ChainRulesCore.rrule(::typeof(foo), x::Real)
           foo_pb(Ω::Real) = ChainRulesCore.NoTangent(), 5Ω
           return foo(x), foo_pb
       end;

julia&gt; @from_rrule DefaultCtx Tuple{typeof(foo), Base.IEEEFloat}

julia&gt; rrule!!(zero_fcodual(foo), zero_fcodual(5.0))[2](1.0)
(NoRData(), 5.0)

julia&gt; # Check that the rule works as intended.
       TestUtils.test_rule(Xoshiro(123), foo, 5.0; is_primitive=true)
Test Passed</code></pre><p><strong>An Example with Keyword Arguments</strong></p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: @from_rrule, DefaultCtx, rrule!!, zero_fcodual, TestUtils

julia&gt; import ChainRulesCore

julia&gt; foo(x::Real; cond::Bool) = cond ? 5x : 4x;

julia&gt; function ChainRulesCore.rrule(::typeof(foo), x::Real; cond::Bool)
           foo_pb(Ω::Real) = ChainRulesCore.NoTangent(), cond ? 5Ω : 4Ω
           return foo(x; cond), foo_pb
       end;

julia&gt; @from_rrule DefaultCtx Tuple{typeof(foo), Base.IEEEFloat} true

julia&gt; _, pb = rrule!!(
           zero_fcodual(Core.kwcall),
           zero_fcodual((cond=false, )),
           zero_fcodual(foo),
           zero_fcodual(5.0),
       );

julia&gt; pb(3.0)
(NoRData(), NoRData(), NoRData(), 12.0)

julia&gt; # Check that the rule works as intended.
       TestUtils.test_rule(
           Xoshiro(123), Core.kwcall, (cond=false, ), foo, 5.0; is_primitive=true
       )
Test Passed</code></pre><p>Notice that, in order to access the kwarg method we must call the method of <code>Core.kwcall</code>, as Mooncake&#39;s <code>rrule!!</code> does not itself permit the use of kwargs.</p><p><strong>Limitations</strong></p><p>It is your responsibility to ensure that</p><ol><li>calls with signature <code>sig</code> do not mutate their arguments,</li><li>the output of calls with signature <code>sig</code> does not alias any of the inputs.</li></ol><p>As with all hand-written rules, you should definitely make use of <a href="../debugging_and_mwes/#Mooncake.TestUtils.test_rule-utilities-debugging_and_mwes"><code>TestUtils.test_rule</code></a> to verify correctness on some test cases.</p><p><strong>Argument Type Constraints</strong></p><p>Many methods of <code>ChainRuleCore.rrule</code> are implemented with very loose type constraints. For example, it would not be surprising to see a method of rrule with the signature</p><pre><code class="language-julia hljs">Tuple{typeof(rrule), typeof(foo), Real, AbstractVector{&lt;:Real}}</code></pre><p>There are a variety of reasons for this way of doing things, and whether it is a good idea to write rules for such generic objects has been debated at length.</p><p>Suffice it to say, you should not write rules for <em>this</em> package which are so generically typed. Rather, you should create rules for the subset of types for which you believe that the <code>ChainRulesCore.rrule</code> will work correctly, and leave this package to derive rules for the rest. For example, it is quite common to be confident that a given rule will work correctly for any <code>Base.IEEEFloat</code> argument, i.e. <code>Union{Float16, Float32, Float64}</code>, but it is usually not possible to know that the rule is correct for all possible subtypes of <code>Real</code> that someone might define.</p><p><strong>Conversions Between Different Tangent Type Systems</strong></p><p>Under the hood, this functionality relies on two functions: <code>Mooncake.to_cr_tangent</code>, and <code>Mooncake.increment_and_get_rdata!</code>. These two functions handle conversion to / from <code>Mooncake</code> tangent types and <code>ChainRulesCore</code> tangent types. This functionality is known to work well for simple types, but has not been tested to a great extent on complicated composite types. If <code>@from_rrule</code> does not work in your case because the required method of either of these functions does not exist, please open an issue.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/847f357d8b235bbd71416da48827db0e8a98e477/src/tools_for_rules.jl#L340-L452">source</a></section></article><h2 id="Adding-Methods-To-rrule!!-And-build_primitive_rrule"><a class="docs-heading-anchor" href="#Adding-Methods-To-rrule!!-And-build_primitive_rrule">Adding Methods To <code>rrule!!</code> And <code>build_primitive_rrule</code></a><a id="Adding-Methods-To-rrule!!-And-build_primitive_rrule-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-Methods-To-rrule!!-And-build_primitive_rrule" title="Permalink"></a></h2><p>If the above strategies do not work for you, you should first implement a method of <a href="../../developer_documentation/internal_docstrings/#Mooncake.is_primitive-Tuple{Type{Mooncake.MinimalCtx}, Type{&lt;:Tuple}}"><code>Mooncake.is_primitive</code></a> for the signature of interest:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.is_primitive-utilities-defining_rules" href="#Mooncake.is_primitive-utilities-defining_rules"><code>Mooncake.is_primitive</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_primitive(::Type{Ctx}, sig) where {Ctx}</code></pre><p>Returns a <code>Bool</code> specifying whether the methods specified by <code>sig</code> are considered primitives in the context of contexts of type <code>Ctx</code>.</p><pre><code class="language-julia hljs">is_primitive(DefaultCtx, Tuple{typeof(sin), Float64})</code></pre><p>will return if calling <code>sin(5.0)</code> should be treated as primitive when the context is a <code>DefaultCtx</code>.</p><p>Observe that this information means that whether or not something is a primitive in a particular context depends only on static information, not any run-time information that might live in a particular instance of <code>Ctx</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/847f357d8b235bbd71416da48827db0e8a98e477/src/interpreter/contexts.jl#L19-L34">source</a></section></article><p>Then implement a method of one of the following:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.rrule!!-utilities-defining_rules" href="#Mooncake.rrule!!-utilities-defining_rules"><code>Mooncake.rrule!!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">rrule!!(f::CoDual, x::CoDual...)</code></pre><p>Performs the forwards-pass of AD. The <code>tangent</code> field of <code>f</code> and each <code>x</code> should contain the forwards tangent data (fdata) associated to each corresponding <code>primal</code> field.</p><p>Returns a 2-tuple. The first element, <code>y</code>, is a <code>CoDual</code> whose <code>primal</code> field is the value associated to running <code>f.primal(map(x -&gt; x.primal, x)...)</code>, and whose <code>tangent</code> field is its associated <code>fdata</code>. The second element contains the pullback, which runs the reverse-pass. It maps from the rdata associated to <code>y</code> to the rdata associated to <code>f</code> and each <code>x</code>.</p><pre><code class="language-julia hljs">using Mooncake: zero_fcodual, CoDual, NoFData, rrule!!
y, pb!! = rrule!!(zero_fcodual(sin), CoDual(5.0, NoFData()))
pb!!(1.0)

# output

(NoRData(), 0.28366218546322625)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/847f357d8b235bbd71416da48827db0e8a98e477/src/Mooncake.jl#L45-L67">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.build_primitive_rrule-utilities-defining_rules" href="#Mooncake.build_primitive_rrule-utilities-defining_rules"><code>Mooncake.build_primitive_rrule</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">build_primitive_rrule(sig::Type{&lt;:Tuple})</code></pre><p>Construct an rrule for signature <code>sig</code>. For this function to be called in <code>build_rrule</code>, you must also ensure that <code>is_primitive(context_type, sig)</code> is <code>true</code>. The callable returned by this must obey the rrule interface, but there are no restrictions on the type of callable itself. For example, you might return a callable <code>struct</code>. By default, this function returns <code>rrule!!</code> so, most of the time, you should just implement a method of <code>rrule!!</code>.</p><p><strong>Extended Help</strong></p><p>The purpose of this function is to permit computation at rule construction time, which can be re-used at runtime. For example, you might wish to derive some information from <code>sig</code> which you use at runtime (e.g. the fdata type of one of the arguments). While constant propagation will often optimise this kind of computation away, it will sometimes fail to do so in hard-to-predict circumstances. Consequently, if you need certain computations not to happen at runtime in order to guarantee good performance, you might wish to e.g. emit a callable <code>struct</code> with type parameters which are the result of this computation. In this context, the motivation for using this function is the same as that of using staged programming (e.g. via <code>@generated</code> functions) more generally.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/847f357d8b235bbd71416da48827db0e8a98e477/src/Mooncake.jl#L70-L90">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../understanding_mooncake/rule_system/">« Mooncake.jl&#39;s Rule System</a><a class="docs-footer-nextpage" href="../debug_mode/">Debug Mode »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.0 on <span class="colophon-date" title="Friday 9 May 2025 16:48">Friday 9 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
