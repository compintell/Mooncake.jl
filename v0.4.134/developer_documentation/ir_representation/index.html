<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>IR Representation · Mooncake.jl</title><meta name="title" content="IR Representation · Mooncake.jl"/><meta property="og:title" content="IR Representation · Mooncake.jl"/><meta property="twitter:title" content="IR Representation · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body>
<!-- NAVBAR START -->
<style>
    html {
        scroll-padding-top: calc(55px + 1rem);
    }

    /* Documenter css tweaks */
    .docs-sidebar {
        margin-top: 3.75rem;
    }

    #documenter {
        margin-top: 3.75rem;
    }

    .docs-version-selector {
        margin-bottom: 60px !important;
    }

    @media screen and (max-width: 1056px) {
        .docs-version-selector {
            margin-bottom: 60px !important;
        }

        .docs-sidebar {
            margin-top: 0 !important;
        }
    }
    /* Documenter css tweaks ends here */

    :root {
        --heading-color: white;
        --item-color: rgb(165, 165, 165);
        --primary-bg: #073c44;
        --hover-color: #8faad2;
        --deprecated-bg: #ff4d4d;
        --deprecated-text: white;
    }

    .ext-navigation {
        position: fixed;
        height: 3.75rem;
        top: 0;
        width: 100%;
        background-color: var(--primary-bg);
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        padding: 0 1.0625rem;
        transition: transform 0.3s;
    }

    .ext-navbar-logo {
        margin-left: 0.625rem;
    }

    .ext-nav-links {
        display: flex;
        align-items: center;
        list-style-type: none;
        margin: 0;
        padding: 0;
        flex-grow: 1;
    }

    .ext-nav-links li {
        margin-left: 1rem !important;
    }

    .ext-nav-link {
        color: white !important;
        text-decoration: none;
        font-size: 1.0625rem !important;
        transition: color 0.2s ease;
        cursor: pointer;
    }

    .ext-nav-link:hover,
    .ext-navbar-item-single a:hover {
        color: var(--hover-color) !important;
    }

    .ext-navbar-item-single a {
        color: #fff !important;
    }

    .ext-menu-toggle {
        display: none;
        font-size: 1.5rem;
        color: white;
        cursor: pointer;
    }

    .ext-dropdown {
        display: none;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        grid-template-rows: auto auto auto;
        padding: 1.875rem;
        position: absolute;
        width: 100%;
        left: 0;
        background-color: #083c44;
        line-height: 1.875rem;
        opacity: 0;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transform: translateY(-0.625rem);
    }

    #library-handler::after {
        content: "▼";
        font-size: 0.6875rem;
        margin-left: 0.3125rem;
        transition: transform 0.3s ease-in-out;
    }

    #library-handler.open::after {
        content: "▲";
    }

    .ext-dropdown.show {
        display: grid;
        opacity: 1;
        transform: translateY(0);
    }

    .ext-dropdown ul {
        height: auto;
        width: 12.5rem;
        margin-bottom: 1.25rem;
    }

    .ext-dropdown ul li {
        text-align: left;
        display: flex;
        align-items: center;
    }

    .navbar-sub-item {
        list-style: none;
    }

    .ext-dropdown ul a li {
        color: var(--item-color);
        width: 15.625rem;
        border-radius: 3px;
        padding: 0.125rem 0.625rem;
        transition: background-color 0.2s ease;
    }

    .ext-dropdown ul a li:hover {
        background-color: rgba(107, 107, 107, 0.5);
    }

    .ext-dropdown-item-heading {
        color: var(--heading-color);
        text-align: center;
    }

    .deprecated-badge {
        background-color: var(--deprecated-bg);
        color: var(--deprecated-text);
        font-size: 0.75rem;
        padding: 0.125rem 0.375rem;
        border-radius: 3px;
        margin-left: 0.5rem;
        line-height: 1;
    }

    /* Responsive styling */
    @media (max-width: 966px) {
        .ext-dropdown {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .ext-nav-links {
            display: none;
            flex-direction: column;
            width: 100%;
            background-color: var(--primary-bg);
            position: absolute;
            top: 3.75rem;
            left: 0;
            padding: 0.625rem 0;
            height: auto;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgb(141, 141, 141) grey;
        }

        .ext-nav-links.show {
            display: flex;
        }

        .ext-nav-links li {
            margin: 0.625rem 0;
            text-align: center;
        }

        .ext-menu-toggle {
            display: block;
            margin-left: auto;
        }

        .ext-navigation.hide {
            transform: translateY(-3.75rem);
        }

        .ext-dropdown {
            place-content: center;
            text-align: center;
            grid-template-columns: 1fr;
            line-height: 1.25rem;
            padding: 0.625rem;
        }

        .ext-dropdown ul {
            width: 100%;
            text-align: center;
            margin-bottom: 0.3125rem;
        }

        .ext-dropdown ul li {
            text-align: center;
            /* justify-content: center; */
        }

        .ext-dropdown ul a li {
            width: 100%;
        }

        .ext-dropdown ul a li:hover {
            background-color: var(--primary-bg);
            color: #fff;
        }

        /* Modified scroll bar */
        .ext-nav-links::-webkit-scrollbar {
            width: 5px;
        }

        .ext-nav-links::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px grey;
        }

        .ext-nav-links::-webkit-scrollbar-thumb {
            background: rgb(141, 141, 141);
            border-radius: 3px;
        }

        .ext-nav-links::-webkit-scrollbar-thumb:hover {
            background: #9b9b9b;
        }
    }
</style>
<nav class="ext-navigation">
    <a href="https://turinglang.org/">
        <img src="https://turinglang.org/assets/images/turing-logo.svg" alt="Turing Logo" class="ext-navbar-logo" height="24px" width="40px">
    </a>
    <a style="color: white !important; font-size: 21.25px !important; margin-left: 10px;" href="https://turinglang.org/">Turing.jl</a>
    <ul class="ext-nav-links">
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/docs-00-getting-started/">Get Started</a>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/docs/tutorials/00-introduction/">Tutorials</a>
        </li>
        <li>
            <p class="ext-nav-link" id="library-handler">Libraries</p>
            <div class="ext-dropdown" id="ext-dropdown-items">
                <ul>
                    <li class="ext-dropdown-item-heading">Modelling Languages</li>
                    <a href="https://turinglang.org/DynamicPPL.jl/">
                        <li>DynamicPPL</li>
                    </a>
                    <a href="https://turinglang.org/JuliaBUGS.jl/">
                        <li>JuliaBUGS</li>
                    </a>
                    <a href="https://turinglang.org/TuringGLM.jl/">
                        <li>TuringGLM</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">MCMC</li>
                    <a href="https://turinglang.org/AdvancedHMC.jl/">
                        <li>AdvancedHMC</li>
                    </a>
                    <a href="https://turinglang.org/AbstractMCMC.jl/">
                        <li>AbstractMCMC</li>
                    </a>
                    <a href="https://github.com/theogf/ThermodynamicIntegration.jl">
                        <li>ThermodynamicIntegration</li>
                    </a>
                    <a href="https://turinglang.org/AdvancedPS.jl/">
                        <li>AdvancedPS</li>
                    </a>
                    <a href="https://turinglang.org/SliceSampling.jl/">
                        <li>SliceSampling</li>
                    </a>
                    <a href="https://turinglang.org/EllipticalSliceSampling.jl/">
                        <li>EllipticalSliceSampling</li>
                    </a>
                    <a href="https://turinglang.org/NestedSamplers.jl/">
                        <li>NestedSamplers</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Diagnostics</li>
                    <a href="https://turinglang.org/MCMCChains.jl/">
                        <li>MCMCChains</li>
                    </a>
                    <a href="https://turinglang.org/MCMCDiagnosticTools.jl/">
                        <li>MCMCDiagnosticTools</li>
                    </a>
                    <a href="https://turinglang.org/ParetoSmooth.jl/">
                        <li>ParetoSmooth</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading">Gaussian Processes</li>
                    <a href="https://juliagaussianprocesses.github.io/AbstractGPs.jl/">
                        <li>AbstractGPs</li>
                    </a>
                    <a href="https://juliagaussianprocesses.github.io/KernelFunctions.jl/">
                        <li>KernelFunctions</li>
                    </a>
                    <a href="https://juliagaussianprocesses.github.io/ApproximateGPs.jl/">
                        <li>ApproximateGPs</li>
                    </a>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/Bijectors.jl/">Bijectors</a>
                    </li>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/TuringCallbacks.jl/">TuringCallbacks</a>
                    </li>
                </ul>
                <ul>
                    <li class="ext-dropdown-item-heading ext-navbar-item-single">
                        <a href="https://turinglang.org/Deprecated/TuringBenchmarking/">TuringBenchmarking</a>
                        <span class="deprecated-badge">Deprecated</span>
                    </li>
                </ul>
            </div>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/news/">News</a>
        </li>
        <li>
            <a class="ext-nav-link" href="https://turinglang.org/team/">Team</a>
        </li>
    </ul>
    <a href="https://x.com/TuringLang" style="margin-left: 15px; padding-top: 2px">
        <svg fill="#ffffff" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="32px" viewBox="-209.92 -209.92 931.84 931.84" xml:space="preserve" stroke="#ffffff">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <g id="7935ec95c421cee6d86eb22ecd12f847">
                    <path style="display: inline"
                        d="M459.186,151.787c0.203,4.501,0.305,9.023,0.305,13.565 c0,138.542-105.461,298.285-298.274,298.285c-59.209,0-114.322-17.357-160.716-47.104c8.212,0.973,16.546,1.47,25.012,1.47 c49.121,0,94.318-16.759,130.209-44.884c-45.887-0.841-84.596-31.154-97.938-72.804c6.408,1.227,12.968,1.886,19.73,1.886 c9.55,0,18.816-1.287,27.617-3.68c-47.955-9.633-84.1-52.001-84.1-102.795c0-0.446,0-0.882,0.011-1.318 c14.133,7.847,30.294,12.562,47.488,13.109c-28.134-18.796-46.637-50.885-46.637-87.262c0-19.212,5.16-37.218,14.193-52.7 c51.707,63.426,128.941,105.156,216.072,109.536c-1.784-7.675-2.718-15.674-2.718-23.896c0-57.891,46.941-104.832,104.832-104.832 c30.173,0,57.404,12.734,76.525,33.102c23.887-4.694,46.313-13.423,66.569-25.438c-7.827,24.485-24.434,45.025-46.089,58.002 c21.209-2.535,41.426-8.171,60.222-16.505C497.448,118.542,479.666,137.004,459.186,151.787z">
                    </path>
                </g>
            </g>
        </svg>
    </a>
    <a href="https://github.com/TuringLang/Turing.jl">
        <svg width="32px" height="32px" viewBox="-8.2 -8.2 36.40 36.40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
                <title>github [#142]</title>
                <desc>Created with Sketch.</desc>
                <defs></defs>
                <g id="Page-1" stroke-width="0.0002" fill="none" fill-rule="evenodd">
                    <g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#ffffff">
                        <g id="icons" transform="translate(56.000000, 160.000000)">
                            <path
                                d="M94,7399 C99.523,7399 104,7403.59 104,7409.253 C104,7413.782 101.138,7417.624 97.167,7418.981 C96.66,7419.082 96.48,7418.762 96.48,7418.489 C96.48,7418.151 96.492,7417.047 96.492,7415.675 C96.492,7414.719 96.172,7414.095 95.813,7413.777 C98.04,7413.523 100.38,7412.656 100.38,7408.718 C100.38,7407.598 99.992,7406.684 99.35,7405.966 C99.454,7405.707 99.797,7404.664 99.252,7403.252 C99.252,7403.252 98.414,7402.977 96.505,7404.303 C95.706,7404.076 94.85,7403.962 94,7403.958 C93.15,7403.962 92.295,7404.076 91.497,7404.303 C89.586,7402.977 88.746,7403.252 88.746,7403.252 C88.203,7404.664 88.546,7405.707 88.649,7405.966 C88.01,7406.684 87.619,7407.598 87.619,7408.718 C87.619,7412.646 89.954,7413.526 92.175,7413.785 C91.889,7414.041 91.63,7414.493 91.54,7415.156 C90.97,7415.418 89.522,7415.871 88.63,7414.304 C88.63,7414.304 88.101,7413.319 87.097,7413.247 C87.097,7413.247 86.122,7413.234 87.029,7413.87 C87.029,7413.87 87.684,7414.185 88.139,7415.37 C88.139,7415.37 88.726,7417.2 91.508,7416.58 C91.513,7417.437 91.522,7418.245 91.522,7418.489 C91.522,7418.76 91.338,7419.077 90.839,7418.982 C86.865,7417.627 84,7413.783 84,7409.253 C84,7403.59 88.478,7399 94,7399"
                                id="github-[#142]">
                            </path>
                        </g>
                    </g>
                </g>
            </g>
        </svg>
    </a>
    <span class="ext-menu-toggle">&#9776;</span>
</nav>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const menuToggle = document.querySelector(".ext-menu-toggle");
        const navLinks = document.querySelector(".ext-nav-links");
        const nav = document.querySelector(".ext-navigation");
        const navigationHandler = document.getElementById("library-handler");
        const navigationItemsContainer =
            document.getElementById("ext-dropdown-items");
        let lastScrollY = window.scrollY;

        function setAppropriateHeight() {
            if (window.innerWidth <= 768) {
                const viewportHeight = window.innerHeight;
                const navHeight = nav.offsetHeight;
                navLinks.style.maxHeight = `${viewportHeight - navHeight}px`;
                navLinks.style.overflowY = "auto";
            } else {
                navLinks.style.maxHeight = "";
                navLinks.style.overflowY = "";
            }
        }

        // Toggle main menu for mobile
        menuToggle.addEventListener("click", () => {
            navLinks.classList.toggle("show");
            if (navLinks.classList.contains("show")) {
                setAppropriateHeight();
                // Ensure the dropdown is hidden when menu is first opened
                navigationItemsContainer.style.display = "none";
                navigationItemsContainer.classList.remove("show");
            }
        });

        // Close menus if clicked outside
        document.addEventListener("click", (event) => {
            if (
                !navLinks.contains(event.target) &&
                !menuToggle.contains(event.target)
            ) {
                navLinks.classList.remove("show");
                navigationItemsContainer.classList.remove("show");
                navigationHandler.classList.remove("open");
            }
        });

        // Hide navigation bar on scroll down in mobile view
        window.addEventListener("scroll", () => {
            if (window.innerWidth <= 768) {
                nav.classList.toggle("hide", window.scrollY > lastScrollY);
                lastScrollY = window.scrollY;
            }
        });

        // Library API script
        navigationHandler.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default action of the link
            if (navigationItemsContainer.classList.contains("show")) {
                navigationItemsContainer.classList.remove("show");
                navigationHandler.classList.remove("open");
                setTimeout(() => {
                    navigationItemsContainer.style.display = "none";
                }, 500); // Match the timeout to the CSS transition duration
            } else {
                navigationItemsContainer.style.display = "grid";
                navigationHandler.classList.add("open");
                setTimeout(() => {
                    navigationItemsContainer.classList.add("show");
                }, 10); // Delay to ensure the display change takes effect before adding class
            }
            setAppropriateHeight(); // Recalculate height when dropdown changes
        });

        // Handle window resize
        window.addEventListener("resize", setAppropriateHeight);

        // Initial setup
        setAppropriateHeight();
    });
</script>
<!-- NAVBAR END -->

<div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Mooncake.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../../utilities/defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../../utilities/debug_mode/">Debug Mode</a></li><li><a class="tocitem" href="../../utilities/debugging_and_mwes/">Debugging and MWEs</a></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../tangents/">Tangents</a></li><li><a class="tocitem" href="../custom_tangent_type/">Writing Custom Tangent Types</a></li><li class="is-active"><a class="tocitem" href>IR Representation</a><ul class="internal"><li><a class="tocitem" href="#Julia&#39;s-SSA-form-IR"><span>Julia&#39;s SSA-form IR</span></a></li><li><a class="tocitem" href="#Julia-Compiler&#39;s-IR-Datastructure"><span>Julia Compiler&#39;s IR Datastructure</span></a></li><li><a class="tocitem" href="#An-Alternative-IR-Datastructure"><span>An Alternative IR Datastructure</span></a></li><li><a class="tocitem" href="#Code-Transformations"><span>Code Transformations</span></a></li><li><a class="tocitem" href="#Summary-2"><span>Summary</span></a></li><li><a class="tocitem" href="#Docstrings"><span>Docstrings</span></a></li></ul></li><li><a class="tocitem" href="../forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../reverse_mode_design/">Reverse-Mode Design</a></li><li><a class="tocitem" href="../misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="../internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Documentation</a></li><li class="is-active"><a href>IR Representation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>IR Representation</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl/blob/main/docs/src/developer_documentation/ir_representation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="IR-Representation"><a class="docs-heading-anchor" href="#IR-Representation">IR Representation</a><a id="IR-Representation-1"></a><a class="docs-heading-anchor-permalink" href="#IR-Representation" title="Permalink"></a></h1><p>Mooncake.jl works by transforming Julia&#39;s SSA-form (static single assignment) Intermediate Representation (IR), so a good understanding of Julia&#39;s IR is needed to understand Mooncake. Furthermore, Mooncake holds Julia&#39;s IR in a different data structure than the one usually used when producing code for reverse-mode AD. We discuss both data structures below, and provide examples of the kinds of transformations which must be applied to Julia&#39;s IR in order to implement AD, contrasting the two different data structures.</p><p>Please note that Julia&#39;s SSA-form IR typically changes representation slightly between minor versions of Julia, as it&#39;s not part of the public interface of the language. The information below is accurate on version 1.11.4, but you might well find that things are slightly different on different versions.</p><h2 id="Julia&#39;s-SSA-form-IR"><a class="docs-heading-anchor" href="#Julia&#39;s-SSA-form-IR">Julia&#39;s SSA-form IR</a><a id="Julia&#39;s-SSA-form-IR-1"></a><a class="docs-heading-anchor-permalink" href="#Julia&#39;s-SSA-form-IR" title="Permalink"></a></h2><h3 id="Straight-Line-Code"><a class="docs-heading-anchor" href="#Straight-Line-Code">Straight-Line Code</a><a id="Straight-Line-Code-1"></a><a class="docs-heading-anchor-permalink" href="#Straight-Line-Code" title="Permalink"></a></h3><p>You can find the IR associated to a given signature using <code>Base.code_ircode_by_type</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; function foo(x)
           y = sin(x)
           z = cos(y)
           return z
       end
foo (generic function with 1 method)

julia&gt; signature = Tuple{typeof(foo), Float64}
Tuple{typeof(foo), Float64}

julia&gt; Base.code_ircode_by_type(signature)[1][1]
2 1 ─ %1 = invoke sin(_2::Float64)::Float64
3 │   %2 = invoke cos(%1::Float64)::Float64
4 └──      return %2</code></pre><p>What you can see here is that the calls to <code>sin</code> and <code>cos</code> in the original function are associated to a number, denoted <code>%1</code> and <code>%2</code>. We refers to these as the &quot;ssa&quot;s associated to each statement. Each statement is associated to a single ssa, and this association is determined by where it appears in the list of statements – the first statement is associated to <code>%1</code>, the second to <code>%2</code>, and so on. You will also notice that the argument <code>x</code> has been replaced with a <code>_2</code> in the first statement – in general, all uses of the <code>n</code>th argument are indicated by <code>_n</code> (the first argument is the function itself). The final statement requires no explanation.</p><p>Note that this IR is obtained after both type inference and various Julia-level optimisation passes. This means that the type information is available for each statement. For example, the <code>::Float64</code> at the end of the first and second statements indicates that the type of <code>%1</code> and <code>%2</code> is always <code>Float64</code>. The types are also displayed at uses – the call to <code>sin</code> involves <code>_2::Float64</code>, not just <code>_2</code>.</p><p>Additionally notice that the statements are <code>invoke</code> statements, rather than just call statements. In Julia&#39;s IR, an <code>invoke</code> statement represents static dispatch to a particular <code>MethodInstance</code> – i.e. running type inference + optimisation passes has determined enough about the argument types to make it possible to know exactly which <code>MethodInstance</code> of <code>sin</code> and <code>cos</code> to call. This is a very common occurrence in type-stable code.</p><h3 id="Control-Flow"><a class="docs-heading-anchor" href="#Control-Flow">Control Flow</a><a id="Control-Flow-1"></a><a class="docs-heading-anchor-permalink" href="#Control-Flow" title="Permalink"></a></h3><p>The above is straight-line code – it does not involve any control flow. Julia has several statements which are involved in handling control flow. For example</p><pre><code class="language-julia-repl hljs">julia&gt; function bar(x)
           if x &gt; 0
               return x
           else
               return 5x
           end
       end
bar (generic function with 1 method)

julia&gt; Base.code_ircode_by_type(Tuple{typeof(bar),Float64})[1][1]
2 1 ─ %1 = Base.lt_float(0.0, _2)::Bool
  │   %2 = Base.or_int(%1, false)::Bool
  └──      goto #3 if not %2
3 2 ─      return _2
5 3 ─ %5 = Base.mul_float(5.0, _2)::Float64
  └──      return %5</code></pre><p>In this example we see the statement <code>goto #3 if not %2</code>. This should be read as &quot;jump to basic block 3 if %2 is <code>false</code>&quot;. The second half of that statement should be clear, but to understand the first half requires knowing what a basic block is:</p><pre><code class="language-julia hljs">  1 ─
  │  
  └──
  2 ─
  3 ─
  └──</code></pre><p>Here, everything is removed from the above example except for information about the basic block structure. To first approximation, each basic block is a sequence of statements which <em>must</em> always execute one after the other. Once all statements in a basic block have run, we typically either jump to another basic block, or hit a <code>return</code> statement. In this example, we have three basic blocks – you can see this from the numbers <code>1</code>, <code>2</code>, and <code>3</code>. The first basic block comprises three statements, the second only one statement, and the third two statements. Another way to investigate this structure is to look at the control-flow graph associated to the IR:</p><pre><code class="language-julia-repl hljs">julia&gt; Base.code_ircode_by_type(Tuple{typeof(bar),Float64})[1][1].cfg
CFG with 3 blocks:
  bb 1 (stmts 1:3) → bb 3, 2
  bb 2 (stmt 4)
  bb 3 (stmts 5:6)</code></pre><p>For example, the above states that &quot;bb&quot; (basic block) 1 comprises statements 1 to 3, and has successor blocks 2 and 3 (ie. once the statements in basic block 1 have executed, we know for certain that either those in block 2 or block 3 will run next). Blocks 2 and 3 have no successors, because they both end in a <code>return</code> statement. The predecessors of each basic block (the blocks which could possibly have run immediately prior to a given block) are also stored in the blocks of the <code>CFG</code>, even though this is not printed – you should have a play around with this data structure to see what is in there.</p><p>Additionally, note that <code>Base.lt_float</code> (used to check if one floating point number is less than another) and <code>Base.or_int</code> do not appear as <code>invoke</code> statements – this is because they are not generic Julia functions. Rather, they are Julia intrinsics:</p><pre><code class="language-julia-repl hljs">julia&gt; Base.lt_float
lt_float (intrinsic function #31)</code></pre><p>These intrinsics have special handling in the compiler. Either way, the overall point is to be aware that these kinds of low-level intrinsics exist, and appear regularly in Julia IR.</p><h3 id="Simple-Loops-and-Phi-Nodes"><a class="docs-heading-anchor" href="#Simple-Loops-and-Phi-Nodes">Simple Loops and Phi-Nodes</a><a id="Simple-Loops-and-Phi-Nodes-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-Loops-and-Phi-Nodes" title="Permalink"></a></h3><p>Finally, we shall consider a simple loop:</p><pre><code class="language-julia-repl hljs">julia&gt; function my_factorial(x::Int)
           n = 0
           s = 1
           while n &lt; x
               n += 1
               s *= n
           end
           return s
       end
my_factorial (generic function with 1 method)

julia&gt; ir = Base.code_ircode_by_type(Tuple{typeof(my_factorial), Int})[1][1]
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %7)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %6)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #4 if not %4
5 3 ─ %6 = Base.add_int(%3, 1)::Int64
6 │   %7 = Base.mul_int(%2, %6)::Int64
7 └──      goto #2
8 4 ─      return %2</code></pre><p>There are a few new intrinsics that we have not seen previously (<code>Base.slt_int</code> (used to check whether one int is strictly less than another), <code>Base.add_int</code>, and <code>Base.mul_int</code>). Additionally, there is the node <code>goto #2</code>, which simply states that control flow should jump to basic block 2 whenever it is hit.</p><p>The most interesting additional nodes, however, are the two <code>φ</code> (phi) nodes. These are a defining feature of SSA-form IR. Consider the first <code>φ</code> node:</p><pre><code class="language-julia hljs">%2 = φ (#1 =&gt; 1, #3 =&gt; %7)</code></pre><p>means ssa <code>%2</code> takes value <code>1</code> if the previous basic block was <code>#1</code>, and whatever value is currently associated to ssa <code>%7</code> if the previous basic block was <code>#3</code>. It is helpful to step through this code in your head: upon calling <code>my_factorial</code> we enter basic block <code>#1</code>, and proceed directly to basic block <code>#2</code>. Therefore, on the first iteration, <code>%2</code> takes value <code>1</code>. We never return to basic block <code>#1</code>, so all subsequent visits to this <code>φ</code> node will result in <code>%2</code> taking the value associated to <code>%7</code>. You should convince yourself that <code>%2</code> corresponds to the value of <code>s</code> at each iteration, and <code>%3</code> corresponds to the value of <code>n</code> at each iteration.</p><h3 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h3><p>Julia&#39;s SSA-form IR comprises a sequence of statements, which can be broken down into a collection of basic blocks. Each basic block begins with a (potentially empty) collection of phi nodes, followed by a sequence of statements, and potentially finished by a <em>terminator</em> (goto, goto-if-not, return). Control flow is dictated by the terminators at the end of basic blocks – if there is no terminator then we &quot;fall through&quot; to the next basic block.</p><h2 id="Julia-Compiler&#39;s-IR-Datastructure"><a class="docs-heading-anchor" href="#Julia-Compiler&#39;s-IR-Datastructure">Julia Compiler&#39;s IR Datastructure</a><a id="Julia-Compiler&#39;s-IR-Datastructure-1"></a><a class="docs-heading-anchor-permalink" href="#Julia-Compiler&#39;s-IR-Datastructure" title="Permalink"></a></h2><p>The Julia compiler represents the IR associated to a signature via a <code>struct</code> called <code>Core.Compiler.IRCode</code>. The statements are given by the <code>stmts</code> field, which is a <code>Core.Compiler.InstructionStream</code>. An <code>InstructionStream</code> is a collection of 5 <code>Vector</code>s, each of which have the same length. The properties of the <code>n</code>th statement in the <code>IR</code> are given by the <code>n</code>th element of each of these vectors. For example, the <code>stmt</code> field contains the statement itself, the <code>type</code> field contains the inferred type associated to the statement. We&#39;ll skip the rest for now. For example, the statements associated to the <code>my_factorial</code> function above can be retrieved as follows:</p><pre><code class="language-julia-repl hljs">julia&gt; ir.stmts.stmt
9-element Vector{Any}:
 nothing
 :(φ (%1 =&gt; 1, %3 =&gt; %7))
 :(φ (%1 =&gt; 0, %3 =&gt; %6))
 :(Base.slt_int(%3, _2))
 :(goto %4 if not %4)
 :(Base.add_int(%3, 1))
 :(Base.mul_int(%2, %6))
 :(goto %2)
 :(return %2)</code></pre><p>The types can be accessed in a similar way:</p><pre><code class="language-julia-repl hljs">julia&gt; ir.stmts.type
9-element Vector{Any}:
 Nothing
 Int64
 Int64
 Bool
 Any
 Int64
 Int64
 Any
 Any</code></pre><p>As seen in <a href="#Control-Flow">Control Flow</a>, the control flow graph (CFG) is represented as a separate data structure, stored in the <code>cfg</code> field of the <code>IRCode</code>. The argument types associated to the signature are stored in the <code>argtypes</code> field of the <code>IRCode</code>.</p><h2 id="An-Alternative-IR-Datastructure"><a class="docs-heading-anchor" href="#An-Alternative-IR-Datastructure">An Alternative IR Datastructure</a><a id="An-Alternative-IR-Datastructure-1"></a><a class="docs-heading-anchor-permalink" href="#An-Alternative-IR-Datastructure" title="Permalink"></a></h2><p><code>IRCode</code> is a perfectly good way to represent Julia&#39;s IR the vast majority of the time. For example, it suffices for the code transformations required for forwards-mode AD. However, IR transformations involving multiple changes to the control flow structure of a programme are needed in reverse-mode, and are prohibitively awkward to undertake using <code>IRCode</code>. Mooncake&#39;s implementation of reverse-mode AD instead makes use of a custom representation of Julia&#39;s IR, called <code>BBCode</code>. We emphasise that <code>BBCode</code> represents the <em>same</em> thing under the hood, it is just represented in memory in a slightly different way, such that certain kinds of transformations are straightforward to implement.</p><p>You can construct a <code>BBCode</code> from an <code>IRCode</code>, and vice versa:</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake: BBCode

julia&gt; bb_ir = BBCode(ir);

julia&gt; bb_ir isa BBCode
true

julia&gt; Core.Compiler.IRCode(bb_ir)
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %7)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %6)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #4 if not %4
5 3 ─ %6 = Base.add_int(%3, 1)::Int64
6 │   %7 = Base.mul_int(%2, %6)::Int64
7 └──      goto #2
8 4 ─      return %2</code></pre><p>At present, <code>BBCode</code> does not display itself nicely, so to look at it we must either inspect its fields, or convert it back to an <code>IRCode</code> (which <em>does</em> print nicely).</p><p>Instead of storing all of the statements in a single vector (and the types in their own vector, etc), <code>BBCode</code> stores all statements associated to a particular basic block in a <code>Mooncake.BBlock</code>, and stores these in a <code>Vector{Mooncake.BBlock}</code>.</p><pre><code class="language-julia-repl hljs">julia&gt; typeof(bb_ir.blocks)
Vector{BBlock} (alias for Array{Mooncake.BasicBlockCode.BBlock, 1})</code></pre><p>Each <code>BBlock</code> has a field <code>insts</code>, containing the statements associated to that basic block. This is stored as a <code>Vector{Core.Compiler.NewInstruction}</code>, because <code>Core.Compiler.NewInstruction</code> contains the 5 fields that define an instruction in <code>IRCode</code> (you should compare the fields of a <code>Core.Compiler.NewInstruction</code> with those of <code>Core.Compiler.InstructionStream</code> to see the correspondence). For example, consider</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake.BasicBlockCode: ID # to improve printing

julia&gt; bb_ir.blocks[3].insts[1]
Core.Compiler.NewInstruction(:(Base.add_int(ID(97), 1)), Int64, Core.Compiler.NoCallInfo(), 9, 0x000012e0)</code></pre><p>This is the first instruction of the third basic block. The first field is a call to <code>Base.add_int</code>, the second field is <code>Int64</code> (we promise that the other fields are just copies of the corresponding data from the <code>Core.Compiler.InstructionStream</code> in the original <code>IRCode</code> representation of this IR).</p><p>The other structural difference is that <code>BBCode</code> has no field containing the control-flow graph. Instead, the control-flow graph is represented implicitly as part of the <code>blocks</code> field. The upside of this is that any transformations of <code>blocks</code> which modify the CFG are automatically reflected in the <code>blocks</code> – there is no need to perform any book-keeping to ensure that the CFG is kept in sync with the instructions. This saves both time and memory when inserting new basic blocks – when basic block structure changes, a scan of the entire <code>IRCode</code> is required to modify any statements which refer to a given block, and yields code simplifications. The downside is that the CFG must be computed whenever we need to know about it. As a resut, neither <code>IRCode</code> nor <code>BBCode</code>&#39;s representation of the CFG is strictly better than the other. To extract CFG-related information from a <code>BBCode</code>, see <a href="#Mooncake.BasicBlockCode.compute_all_successors-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.compute_all_successors</code></a>, <a href="#Mooncake.BasicBlockCode.compute_all_predecessors-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.compute_all_predecessors</code></a>, and <a href="#Mooncake.BasicBlockCode.control_flow_graph-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.control_flow_graph</code></a>.</p><p>The final major difference between <code>IRCode</code> and <code>BBCode</code> is that all ssa values in an <code>IRCode</code> (<code>%1</code>, <code>%2</code>, <code>%n</code>, etc) are replaced with unique <code>ID</code>s. The <code>ID</code> associated to a statement is stored separately from the statement in the <code>inst_ids</code> field of a <code>BBlock</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; bb_ir.blocks[3].inst_ids
3-element Vector{ID}:
 ID(100)
 ID(101)
 ID(102)</code></pre><p>There is exactly one <code>ID</code> per instruction, and it is an error to have the same <code>ID</code> associated to multiple instructions. Similarly, while the number associated to a basic block in <code>IRCode</code> is a function of the number of basic blocks which preceed it, the <code>ID</code> of a basic block in <code>BBCode</code> is stored in its <code>id</code> field:</p><pre><code class="language-julia-repl hljs">julia&gt; bb_ir.blocks[3].id
ID(106)</code></pre><p>As a result of this, all references to ssa values and basic block numbers in <code>IRCode</code> are replaced with <code>ID</code>s in <code>BBCode</code>. The purpose of this is to guarantee that the &quot;name&quot; of a basic block and an instruction does not change when you insert new basic blocks and new instructions. We shall see how this is useful in the examples below.</p><h2 id="Code-Transformations"><a class="docs-heading-anchor" href="#Code-Transformations">Code Transformations</a><a id="Code-Transformations-1"></a><a class="docs-heading-anchor-permalink" href="#Code-Transformations" title="Permalink"></a></h2><p>In what follows, we look at a few transformations of Julia&#39;s IR, and see how these can be undertaken using both <code>IRCode</code> and <code>BBCode</code>. The purpose is two-fold:</p><ol><li>to enable readers to understand the code used to implement Mooncake, and</li><li>to highlight the relative merits of <code>IRCode</code> vs <code>BBCode</code>.</li></ol><h3 id="Replacing-Instructions"><a class="docs-heading-anchor" href="#Replacing-Instructions">Replacing Instructions</a><a id="Replacing-Instructions-1"></a><a class="docs-heading-anchor-permalink" href="#Replacing-Instructions" title="Permalink"></a></h3><p>This is a very simple code transformation. It is used in both forwards-mode and reverse-mode in Mooncake to replace calls of the form</p><pre><code class="language-julia hljs">f(x, y, z)</code></pre><p>with calls of the form</p><pre><code class="language-julia hljs">frule!!(f, x, y, z)</code></pre><p>This kind of transformation is performed in basically the same way for both <code>IRCode</code> and <code>BBCode</code>. For example, the <code>mul_int</code> statement associated to ssa <code>%7</code> can be replaced with an <code>add_int</code> statement as follows:</p><pre><code class="language-julia-repl hljs">julia&gt; using Core: SSAValue

julia&gt; const CC = Core.Compiler;

julia&gt; new_ir = Core.Compiler.copy(ir);

julia&gt; old_stmt = new_ir.stmts.stmt[7]
:(Base.mul_int(%2, %6))

julia&gt; new_stmt = Expr(:call, Base.add_int, old_stmt.args[2:end]...)
:((Core.Intrinsics.add_int)(%2, %6))

julia&gt; # new_ir[SSAValue(7)][:stmt] = new_stmt
       CC.setindex!(CC.getindex(new_ir, SSAValue(7)), new_stmt, :stmt);

julia&gt; new_ir
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %7)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %6)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #4 if not %4
5 3 ─ %6 = Base.add_int(%3, 1)::Int64
6 │   %7 = (Core.Intrinsics.add_int)(%2, %6)::Int64
7 └──      goto #2
8 4 ─      return %2</code></pre><p>Observe that ssa <code>7</code> has been replaced with the new <code>:call</code> to <code>add_int</code>. Unfortunately, in order to avoid committing type-piracy against <code>Core.Compiler</code>, we cannot currently write <code>new_ir[SSAValue(7)][:stmt]</code>. (<code>CC.getindex</code> is a different function from <code>Base.getindex</code> – the same is true for <code>CC.setindex!</code> vs <code>Base.setindex!</code>). In general, I would recommend defining helper functions to improve the DRYness of your code.</p><p>The same transformation can be performed on <code>BBCode</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; bb_ir_copy = copy(bb_ir);

julia&gt; old_inst = bb_ir_copy.blocks[3].insts[2]
Core.Compiler.NewInstruction(:(Base.mul_int(ID(96), ID(100))), Int64, Core.Compiler.NoCallInfo(), 10, 0x000012e0)

julia&gt; new_stmt = Expr(:call, Base.add_int, old_inst.stmt.args[2:end]...)
:((Core.Intrinsics.add_int)(ID(96), ID(100)))

julia&gt; bb_ir_copy.blocks[3].insts[2] = CC.NewInstruction(old_inst; stmt=new_stmt);

julia&gt; CC.IRCode(bb_ir_copy)
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %7)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %6)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #4 if not %4
5 3 ─ %6 = Base.add_int(%3, 1)::Int64
6 │   %7 = (Core.Intrinsics.add_int)(%2, %6)::Int64
7 └──      goto #2
8 4 ─      return %2</code></pre><p>As you can see, in both cases we wind up with the same <code>IRCode</code> at the end.</p><h3 id="Inserting-New-Instructions"><a class="docs-heading-anchor" href="#Inserting-New-Instructions">Inserting New Instructions</a><a id="Inserting-New-Instructions-1"></a><a class="docs-heading-anchor-permalink" href="#Inserting-New-Instructions" title="Permalink"></a></h3><p>Inserting entirely new instructions into the IR requires a little more thought, but is ultimately very straightforward using either <code>IRCode</code> or <code>BBCode</code>.</p><p>First, <code>IRCode</code>. Suppose that we wish to insert another instruction immediately before the first <code>add_int</code> instruction which multiplies <code>%3</code> by 2 before adding <code>1</code> to it in <code>#3</code>. In <code>IRCode</code>, this kind of modification requires some care, because naively inserting an instruction between the 5th and 6th line changes the name of all instructions from the 6th onwards. Consequently, we need to replace all existing uses of e.g. <code>%6</code> with uses of <code>%7</code>, etc. Happily, <code>IRCode</code> has a mechanism to achieve just this.</p><pre><code class="language-julia-repl hljs">julia&gt; ni = CC.NewInstruction(Expr(:call, Base.mul_int, SSAValue(3), 2), Int)
Core.Compiler.NewInstruction(:((Core.Intrinsics.mul_int)(%3, 2)), Int64, Core.Compiler.NoCallInfo(), nothing, nothing)

julia&gt; new_ssa = CC.insert_node!(new_ir, SSAValue(6), ni)
:(%10)

julia&gt; new_ir
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %7)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %6)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #4 if not %4
5 3 ─      (Core.Intrinsics.mul_int)(%3, 2)::Int64
  │   %6 = Base.add_int(%3, 1)::Int64
6 │   %7 = (Core.Intrinsics.add_int)(%2, %6)::Int64
7 └──      goto #2
8 4 ─      return %2</code></pre><p><code>CC.insert_node!(ir, ssa, new_inst)</code> inserts <code>new_inst</code> into <code>ir</code> immediately before <code>ssa</code>, and attaches it to the same basic block as <code>ssa</code> resides. It returns an <code>SSAValue</code>, which is the &quot;name&quot; associated to the inserted instruction in the IR. Here, we see it has inserted the instruction to multiply <code>%3</code> by <code>2</code> immediately before <code>%6</code>. However, observe that the <code>IRCode</code> has not changed the name associated to the subsequent <code>add_int</code> instruction – it still assigns to <code>%6</code>, despite not being the 6th statement in the IR anymore. This is achieved via <code>IRCode</code>&#39;s <code>new_nodes</code> field – upon calling <code>CC.insert_node!</code>, rather than inserting the instruction directly into the <code>InstructionStream</code>, this list is appended to. We can do this as many times as we like, and then call <code>CC.compact!</code> at the end to handle all of the book-keeping involved in inserting all of the statements, updating all ssa uses where required, and updating the <code>cfg</code> field of the IR.</p><p>Also observe that the inserted statement is printed without a <code>%10 =</code> at the start of it – this is because there are not (yet) any uses of <code>%10</code>, so <code>IRCode</code> does not print it out (presumably in order to reduce visual noise).</p><p>To conclude this transformation, we replace the first argument of the <code>add_int</code> instruction with the new ssa returned by <code>insert_node!</code>, and then call <code>CC.compact!</code> to process all of the nodes currently in the <code>new_nodes</code> list, and produce a valid <code>IRCode</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; stmt = CC.getindex(CC.getindex(new_ir, SSAValue(6)), :stmt)
:(Base.add_int(%3, 1))

julia&gt; stmt.args[2] = new_ssa;

julia&gt; new_ir
  1 ─       nothing::Nothing
4 2 ┄ %2  = φ (#1 =&gt; 1, #3 =&gt; %7)::Int64
  │   %3  = φ (#1 =&gt; 0, #3 =&gt; %6)::Int64
  │   %4  = Base.slt_int(%3, _2)::Bool
  └──       goto #4 if not %4
5 3 ─ %10 = (Core.Intrinsics.mul_int)(%3, 2)::Int64
  │   %6  = Base.add_int(%10, 1)::Int64
6 │   %7  = (Core.Intrinsics.add_int)(%2, %6)::Int64
7 └──       goto #2
8 4 ─       return %2

julia&gt; new_ir = CC.compact!(new_ir)
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %8)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %7)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #4 if not %4
5 3 ─ %6 = (Core.Intrinsics.mul_int)(%3, 2)::Int64
  │   %7 = Base.add_int(%6, 1)::Int64
6 │   %8 = (Core.Intrinsics.add_int)(%2, %7)::Int64
7 └──      goto #2
8 4 ─      return %2</code></pre><p>Observe that, before <code>compact!</code>-ing, the first instruction in basic block <code>#3</code> is still labelled as being <code>%10</code>. After <code>compact!</code>-ing, we have standard sequentially-labelled IR again. Note that the above is exactly the kind of thing that we do in our implementation of forwards-mode AD – all insertions of nodes are performed in a single pass over the <code>IRCode</code>, and <code>CC.compact!</code> is called once at the end.</p><p>Performing this transformation using <code>BBCode</code> is similarly straightforward. Since the name associated to instructions does not change when you insert another instruction, you really just need to insert an instruction + its <code>ID</code>, update the next instruction (as before), and you&#39;re done:</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake.BasicBlockCode: ID, new_inst

julia&gt; new_id = ID() # this produces a new unique `ID`.
ID(108)

julia&gt; target_id = bb_ir_copy.blocks[3].insts[1].stmt.args[2] # find `ID` of argument to add_int.
ID(97)

julia&gt; ni = new_inst(Expr(:call, Base.mul_int, target_id, 2), Int);

julia&gt; insert!(bb_ir_copy.blocks[3], 1, new_id, ni)

julia&gt; bb_ir_copy.blocks[3].insts[2].stmt.args[2] = new_id
ID(108)

julia&gt; CC.IRCode(bb_ir_copy)
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %8)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %7)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #4 if not %4
2 3 ─ %6 = (Core.Intrinsics.mul_int)(%3, 2)::Int64
5 │   %7 = Base.add_int(%6, 1)::Int64
6 │   %8 = (Core.Intrinsics.add_int)(%2, %7)::Int64
7 └──      goto #2
8 4 ─      return %2</code></pre><p>We see here that <code>IRCode</code> and <code>BBCode</code> involve similar levels of complexity to insert an instruction.</p><h3 id="Inserting-New-Basic-Blocks"><a class="docs-heading-anchor" href="#Inserting-New-Basic-Blocks">Inserting New Basic Blocks</a><a id="Inserting-New-Basic-Blocks-1"></a><a class="docs-heading-anchor-permalink" href="#Inserting-New-Basic-Blocks" title="Permalink"></a></h3><p>This is the situation in which the design of <code>BBCode</code> shines vs <code>IRCode</code>. <code>IRCode</code> does not, at present, really have much to say about transformations which change control flow. It is, however, straightforward using <code>BBCode</code>. Suppose that we wish to modify the above to display the value of <code>%2</code> if it is even on any given iteration. Since this involves control flow, it necessarily requires at least one additional basic block.</p><p>We do this in two steps. We first insert an additional basic block between blocks <code>#3</code> and <code>#4</code> which always prints out the value of <code>%2</code>, and then goes to block <code>#2</code>:</p><pre><code class="language-julia-repl hljs">julia&gt; using Mooncake.BasicBlockCode: BBlock, new_inst, IDGotoNode, IDGotoIfNot

julia&gt; block_2_id = bb_ir_copy.blocks[2].id;

julia&gt; new_bb_id = ID();

julia&gt; new_bb = BBlock(
           new_bb_id,
           ID[ID(), ID()],
           CC.NewInstruction[
               new_inst(Expr(:call, println, CC.SSAValue(2))),
               new_inst(IDGotoNode(block_2_id)),
           ],
       );

julia&gt; insert!(bb_ir_copy.blocks, 4, new_bb);

julia&gt; CC.IRCode(bb_ir_copy)
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %8)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %7)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #5 if not %4
2 3 ─ %6 = (Core.Intrinsics.mul_int)(%3, 2)::Int64
5 │   %7 = Base.add_int(%6, 1)::Int64
6 │   %8 = (Core.Intrinsics.add_int)(%2, %7)::Int64
7 └──      goto #2
2 4 ─      (println)(%2)::Any
  └──      goto #2
8 5 ─      return %2</code></pre><p>Observe that, in this case, rather than creating <code>new_bb</code> and then inserting instructions into it, we simply create the block <em>with</em> the instructions. This programming style is often more convenient. Additionally note that we create an <code>ID</code> for each statement in the new basic block. These <code>ID</code>s are never actually used anywhere, but <code>BBCode</code> requires that each instruction be associated to an <code>ID</code>, so we must create them.</p><p>Additionally, note the usage of an <a href="#Mooncake.BasicBlockCode.IDGotoNode"><code>Mooncake.BasicBlockCode.IDGotoNode</code></a>. This is exactly the same thing as a <code>Core.Compiler.GotoNode</code>, except it contains an <code>ID</code> stating which basic block to jump to, rather than an <code>Int</code>. Similarly, the <a href="#Mooncake.BasicBlockCode.IDGotoIfNot"><code>Mooncake.BasicBlockCode.IDGotoIfNot</code></a> is a direct translation of <code>Core.Compiler.GotoIfNot</code>, with the <code>dest</code> field being an <code>ID</code> rather than an <code>Int</code>.</p><p>Furthermore, note that the <code>goto if not</code> instruction at the end of basic block <code>#2</code> now (correctly) jumps to basic block <code>#5</code>, whereas before it jumped to block <code>#4</code>. That is, by virtue of the fact that the <code>ID</code> associated to each basic block remains unchanged in <code>BBCode</code>, all pre-existing control flow relationships have remained the same. Moreover, we did not have to write any book-keeping code to ensure that this update happened correctly.</p><p>Now that we&#39;ve created the new basic block, we modify block <code>#3</code> to fall-through to the new block if <code>%2</code> is even, and to jump straight back to block <code>#2</code> if not:</p><pre><code class="language-julia-repl hljs">julia&gt; bb = bb_ir_copy.blocks[3];

julia&gt; cond_id = ID();

julia&gt; target_id = bb_ir_copy.blocks[2].inst_ids[1];

julia&gt; insert!(bb, 4, cond_id, new_inst(Expr(:call, iseven, target_id)));

julia&gt; bb.insts[end] = new_inst(IDGotoIfNot(cond_id, block_2_id));

julia&gt; new_ir = CC.IRCode(bb_ir_copy)
  1 ─      nothing::Nothing
4 2 ┄ %2 = φ (#1 =&gt; 1, #3 =&gt; %8)::Int64
  │   %3 = φ (#1 =&gt; 0, #3 =&gt; %7)::Int64
  │   %4 = Base.slt_int(%3, _2)::Bool
  └──      goto #5 if not %4
2 3 ─ %6 = (Core.Intrinsics.mul_int)(%3, 2)::Int64
5 │   %7 = Base.add_int(%6, 1)::Int64
6 │   %8 = (Core.Intrinsics.add_int)(%2, %7)::Int64
2 │   %9 = (iseven)(%2)::Any
  └──      goto #2 if not %9
  4 ─      (println)(%2)::Any
  └──      goto #2
8 5 ─      return %2</code></pre><p>Observe that in order to tie the conditional to the goto-if-not, we simply ensure that the <code>ID</code> associated to the instruction which computes the conditional appears in the <code>IDGotoIfNot</code> instruction.</p><h3 id="Run-the-new-code"><a class="docs-heading-anchor" href="#Run-the-new-code">Run the new code</a><a id="Run-the-new-code-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-new-code" title="Permalink"></a></h3><p>As ever, we can construct a <code>Core.OpaqueClosure</code> using <code>IRCode</code> in order to produce something runnable:</p><pre><code class="language-julia-repl hljs">julia&gt; oc = Core.OpaqueClosure(new_ir; do_compile=true)
(::Int64)::Int64-&gt;◌

julia&gt; oc(1000)
2
12
58
248
1014
2037</code></pre><p>Exactly what <code>oc</code> is computing is neither here nor there. The point is that we&#39;ve successfully inserted a new basic block into Julia&#39;s IR, and produced a callable from it.</p><h2 id="Summary-2"><a class="docs-heading-anchor" href="#Summary-2">Summary</a><a class="docs-heading-anchor-permalink" href="#Summary-2" title="Permalink"></a></h2><p>We have reviewed the two representations of Julia IR used in Mooncake. Where possible, we always use <code>IRCode</code> – as discussed, forwards-mode AD exclusively uses <code>IRCode</code>. <code>BBCode</code> is basically only needed when undertaking transformations which involve changes to basic block structure – the insertion of new basic blocks, and the modification of terminators in a way which changes the predecessors / successors of a given block being the primary sources of these kinds of changes. Reverse-mode AD makes extensive use of such transformations, so <code>BBCode</code> is currently important there.</p><p>There are efforts such as <a href="https://github.com/JuliaLang/julia/pull/45305">this PR</a> to augment <code>IRCode</code> with the capability to manipulate the CFG structure in a convenient manner. Ideally these efforts will succeed, then we can do away with <code>BBCode</code>.</p><h2 id="Docstrings"><a class="docs-heading-anchor" href="#Docstrings">Docstrings</a><a id="Docstrings-1"></a><a class="docs-heading-anchor-permalink" href="#Docstrings" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode" href="#Mooncake.BasicBlockCode"><code>Mooncake.BasicBlockCode</code></a> — <span class="docstring-category">Module</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">module BasicBlockCode</code></pre><p>See the docstring for the <code>BBCode</code> <code>struct</code> for info on this file.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L1-L5">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.Terminator" href="#Mooncake.BasicBlockCode.Terminator"><code>Mooncake.BasicBlockCode.Terminator</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Terminator = Union{Switch, IDGotoIfNot, IDGotoNode, ReturnNode}</code></pre><p>A Union of the possible types of a terminator node.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L170-L174">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Core.Compiler.IRCode-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Core.Compiler.IRCode-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Core.Compiler.IRCode</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IRCode(bb_code::BBCode)</code></pre><p>Produce an <code>IRCode</code> instance which is equivalent to <code>bb_code</code>. The resulting <code>IRCode</code> shares no memory with <code>bb_code</code>, so can be safely mutated without modifying <code>bb_code</code>.</p><p>All <code>IDPhiNode</code>s, <code>IDGotoIfNot</code>s, and <code>IDGotoNode</code>s are converted into <code>PhiNode</code>s, <code>GotoIfNot</code>s, and <code>GotoNode</code>s respectively.</p><p>In the resulting <code>bb_code</code>, any <code>Switch</code> nodes are lowered into a semantically-equivalent collection of <code>GotoIfNot</code> nodes.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L619-L630">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.BBCode" href="#Mooncake.BasicBlockCode.BBCode"><code>Mooncake.BasicBlockCode.BBCode</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">BBCode(
    blocks::Vector{BBlock}
    argtypes::Vector{Any}
    sptypes::Vector{CC.VarState}
    linetable::Vector{Core.LineInfoNode}
    meta::Vector{Expr}
)</code></pre><p>A <code>BBCode</code> is a data structure which is similar to <code>IRCode</code>, but adds additional structure.</p><p>In particular, a <code>BBCode</code> comprises a sequence of basic blocks (<code>BBlock</code>s), each of which comprise a sequence of statements. Moreover, each <code>BBlock</code> has its own unique <code>ID</code>, as does each statment.</p><p>The consequence of this is that new basic blocks can be inserted into a <code>BBCode</code>. This is distinct from <code>IRCode</code>, in which to create a new basic block, one must insert additional statments which you know will create a new basic block – this is generally quite an unreliable process, while inserting a new <code>BBlock</code> into <code>BBCode</code> is entirely predictable. Furthermore, inserting a new <code>BBlock</code> does not change the <code>ID</code> associated to the other blocks, meaning that you can safely assume that references from existing basic block terminators / phi nodes to other blocks will not be modified by inserting a new basic block.</p><p>Additionally, since each statment in each basic block has its own unique <code>ID</code>, new statments can be inserted without changing references between other blocks. <code>IRCode</code> also has some support for this via its <code>new_nodes</code> field, but eventually all statements will be renamed upon <code>compact!</code>ing the <code>IRCode</code>, meaning that the name of any given statement will eventually change.</p><p>Finally, note that the basic blocks in a <code>BBCode</code> support the custom <code>Switch</code> statement. This statement is not valid in <code>IRCode</code>, and is therefore lowered into a collection of <code>GotoIfNot</code>s and <code>GotoNode</code>s when a <code>BBCode</code> is converted back into an <code>IRCode</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L275-L307">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.BBCode-Tuple{Core.Compiler.IRCode}" href="#Mooncake.BasicBlockCode.BBCode-Tuple{Core.Compiler.IRCode}"><code>Mooncake.BasicBlockCode.BBCode</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">BBCode(ir::IRCode)</code></pre><p>Convert an <code>ir</code> into a <code>BBCode</code>. Creates a completely independent data structure, so mutating the <code>BBCode</code> returned will not mutate <code>ir</code>.</p><p>All <code>PhiNode</code>s, <code>GotoIfNot</code>s, and <code>GotoNode</code>s will be replaced with the <code>IDPhiNode</code>s, <code>IDGotoIfNot</code>s, and <code>IDGotoNode</code>s respectively.</p><p>See <code>IRCode</code> for conversion back to <code>IRCode</code>.</p><p>Note that <code>IRCode(BBCode(ir))</code> should be equal to the identity function.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L509-L521">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.BBCode-Tuple{Union{Mooncake.BasicBlockCode.BBCode, Core.Compiler.IRCode}, Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode.BBCode-Tuple{Union{Mooncake.BasicBlockCode.BBCode, Core.Compiler.IRCode}, Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode.BBCode</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">BBCode(ir::Union{IRCode, BBCode}, new_blocks::Vector{Block})</code></pre><p>Make a new <code>BBCode</code> whose <code>blocks</code> is given by <code>new_blocks</code>, and fresh copies are made of all other fields from <code>ir</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L316-L321">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.BBlock" href="#Mooncake.BasicBlockCode.BBlock"><code>Mooncake.BasicBlockCode.BBlock</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">BBlock(id::ID, stmt_ids::Vector{ID}, stmts::InstVector)</code></pre><p>A basic block data structure (not called <code>BasicBlock</code> to avoid accidental confusion with <code>CC.BasicBlock</code>). Forms a single basic block.</p><p>Each <code>BBlock</code> has an <code>ID</code> (a unique name). This makes it possible to refer to blocks in a way that does not change when additional <code>BBlocks</code> are inserted into a <code>BBCode</code>. This differs from the positional block numbering found in <code>IRCode</code>, in which the number associated to a basic block changes when new blocks are inserted.</p><p>The <code>n</code>th line of code in a <code>BBlock</code> is associated to <code>ID</code> <code>stmt_ids[n]</code>, and the <code>n</code>th instruction from <code>stmts</code>.</p><p>Note that <code>PhiNode</code>s, <code>GotoIfNot</code>s, and <code>GotoNode</code>s should not appear in a <code>BBlock</code> – instead an <code>IDPhiNode</code>, <code>IDGotoIfNot</code>, or <code>IDGotoNode</code> should be used.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L177-L193">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.BBlock-Tuple{Mooncake.BasicBlockCode.ID, Vector{Tuple{Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}}}" href="#Mooncake.BasicBlockCode.BBlock-Tuple{Mooncake.BasicBlockCode.ID, Vector{Tuple{Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}}}"><code>Mooncake.BasicBlockCode.BBlock</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">BBlock(id::ID, inst_pairs::Vector{IDInstPair})</code></pre><p>Convenience constructor – splits <code>inst_pairs</code> into a <code>Vector{ID}</code> and <code>InstVector</code> in order to build a <code>BBlock</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L209-L214">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.ID" href="#Mooncake.BasicBlockCode.ID"><code>Mooncake.BasicBlockCode.ID</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">ID()</code></pre><p>An <code>ID</code> (read: unique name) is just a wrapper around an <code>Int32</code>. Uniqueness is ensured via a global counter, which is incremented each time that an <code>ID</code> is created.</p><p>This counter can be reset using <code>seed_id!</code> if you need to ensure deterministic <code>ID</code>s are produced, in the same way that seed for random number generators can be set.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L70-L78">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.IDGotoIfNot" href="#Mooncake.BasicBlockCode.IDGotoIfNot"><code>Mooncake.BasicBlockCode.IDGotoIfNot</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IDGotoIfNot(cond::Any, dest::ID)</code></pre><p>Like a <code>GotoIfNot</code>, but <code>dest</code> is an <code>ID</code> rather than an <code>Int64</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L128-L132">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.IDGotoNode" href="#Mooncake.BasicBlockCode.IDGotoNode"><code>Mooncake.BasicBlockCode.IDGotoNode</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IDGotoNode(label::ID)</code></pre><p>Like a <code>GotoNode</code>, but <code>label</code> is an <code>ID</code> rather than an <code>Int64</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L117-L121">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.IDInstPair" href="#Mooncake.BasicBlockCode.IDInstPair"><code>Mooncake.BasicBlockCode.IDInstPair</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">const IDInstPair = Tuple{ID, NewInstruction}</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L204-L206">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.IDPhiNode" href="#Mooncake.BasicBlockCode.IDPhiNode"><code>Mooncake.BasicBlockCode.IDPhiNode</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IDPhiNode(edges::Vector{ID}, values::Vector{Any})</code></pre><p>Like a <code>PhiNode</code>, but <code>edges</code> are <code>ID</code>s rather than <code>Int32</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L103-L107">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.InstVector" href="#Mooncake.BasicBlockCode.InstVector"><code>Mooncake.BasicBlockCode.InstVector</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">const InstVector = Vector{NewInstruction}</code></pre><p>Note: the <code>CC.NewInstruction</code> type is used to represent instructions because it has the correct fields. While it is only used to represent new instrucdtions in <code>Core.Compiler</code>, it is used to represent all instructions in <code>BBCode</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L61-L67">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.Switch" href="#Mooncake.BasicBlockCode.Switch"><code>Mooncake.BasicBlockCode.Switch</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Switch(conds::Vector{Any}, dests::Vector{ID}, fallthrough_dest::ID)</code></pre><p>A switch-statement node. These can be inserted in the <code>BBCode</code> representation of Julia IR. <code>Switch</code> has the following semantics:</p><pre><code class="language-julia hljs">goto dests[1] if not conds[1]
goto dests[2] if not conds[2]
...
goto dests[N] if not conds[N]
goto fallthrough_dest</code></pre><p>where the value associated to each element of <code>conds</code> is a <code>Bool</code>, and <code>dests</code> indicate which block to jump to. If none of the conditions are met, then we go to whichever block is specified by <code>fallthrough_dest</code>.</p><p><code>Switch</code> statements are lowered into the above sequence of <code>GotoIfNot</code>s and <code>GotoNode</code>s when converting <code>BBCode</code> back into <code>IRCode</code>, because <code>Switch</code> statements are not valid nodes in regular Julia IR.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L140-L159">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Base.insert!-Tuple{Mooncake.BasicBlockCode.BBlock, Int64, Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}" href="#Base.insert!-Tuple{Mooncake.BasicBlockCode.BBlock, Int64, Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}"><code>Base.insert!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Base.insert!(bb::BBlock, n::Int, id::ID, stmt::CC.NewInstruction)::Nothing</code></pre><p>Inserts <code>stmt</code> and <code>id</code> into <code>bb</code> immediately before the <code>n</code>th instruction.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L237-L241">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.__line_numbers_to_block_numbers!-Tuple{Vector{Any}, Core.Compiler.CFG}" href="#Mooncake.BasicBlockCode.__line_numbers_to_block_numbers!-Tuple{Vector{Any}, Core.Compiler.CFG}"><code>Mooncake.BasicBlockCode.__line_numbers_to_block_numbers!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">__line_numbers_to_block_numbers!(insts::Vector{Any}, cfg::CC.CFG)</code></pre><p>Converts any edges in <code>GotoNode</code>s, <code>GotoIfNot</code>s, <code>PhiNode</code>s, and <code>:enter</code> expressions which refer to line numbers into references to block numbers. The <code>cfg</code> provides the information required to perform this conversion.</p><p>For context, <code>CodeInfo</code> objects have references to line numbers, while <code>IRCode</code> uses block numbers.</p><p>This code is copied over directly from the body of <code>Core.Compiler.inflate_ir!</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L474-L485">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._block_nums_to_ids-Tuple{Vector{Core.Compiler.NewInstruction}, Core.Compiler.CFG}" href="#Mooncake.BasicBlockCode._block_nums_to_ids-Tuple{Vector{Core.Compiler.NewInstruction}, Core.Compiler.CFG}"><code>Mooncake.BasicBlockCode._block_nums_to_ids</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_block_nums_to_ids(insts::InstVector, cfg::CC.CFG)::Tuple{Vector{ID}, InstVector}</code></pre><p>Assign to each basic block in <code>cfg</code> an <code>ID</code>. Replace all integers referencing block numbers in <code>insts</code> with the corresponding <code>ID</code>. Return the <code>ID</code>s and the updated instructions.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L593-L598">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._build_graph_of_cfg-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode._build_graph_of_cfg-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode._build_graph_of_cfg</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_build_graph_of_cfg(blks::Vector{BBlock})::Tuple{SimpleDiGraph, Dict{ID, Int}}</code></pre><p>Builds a <code>SimpleDiGraph</code>, <code>g</code>, representing of the CFG associated to <code>blks</code>, where <code>blks</code> comprises the collection of basic blocks associated to a <code>BBCode</code>. This is a type from Graphs.jl, so constructing <code>g</code> makes it straightforward to analyse the control flow structure of <code>ir</code> using algorithms from Graphs.jl.</p><p>Returns a 2-tuple, whose first element is <code>g</code>, and whose second element is a map from the <code>ID</code> associated to each basic block in <code>ir</code>, to the <code>Int</code> corresponding to its node index in <code>g</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L750-L761">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._compute_all_predecessors-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode._compute_all_predecessors-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode._compute_all_predecessors</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_compute_all_predecessors(blks::Vector{BBlock})::Dict{ID, Vector{ID}}</code></pre><p>Internal method implementing <a href="#Mooncake.BasicBlockCode.compute_all_predecessors-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>compute_all_predecessors</code></a>. This method is easier to construct test cases for because it only requires the collection of <code>BBlocks</code>, not all of the other stuff that goes into a <code>BBCode</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L379-L385">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._compute_all_successors-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode._compute_all_successors-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode._compute_all_successors</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_compute_all_successors(blks::Vector{BBlock})::Dict{ID, Vector{ID}}</code></pre><p>Internal method implementing <a href="#Mooncake.BasicBlockCode.compute_all_successors-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>compute_all_successors</code></a>. This method is easier to construct test cases for because it only requires the collection of <code>BBlocks</code>, not all of the other stuff that goes into a <code>BBCode</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L342-L348">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._control_flow_graph-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode._control_flow_graph-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode._control_flow_graph</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_control_flow_graph(blks::Vector{BBlock})::Core.Compiler.CFG</code></pre><p>Internal function, used to implement <a href="#Mooncake.BasicBlockCode.control_flow_graph-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>control_flow_graph</code></a>. Easier to write test cases for because there is no need to construct an ensure BBCode object, just the <code>BBlock</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L436-L441">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._distance_to_entry-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode._distance_to_entry-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode._distance_to_entry</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_distance_to_entry(blks::Vector{BBlock})::Vector{Int}</code></pre><p>For each basic block in <code>blks</code>, compute the distance from it to the entry point (the first block. The distance is <code>typemax(Int)</code> if no path from the entry point to a given node.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L773-L778">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._find_id_uses!-Tuple{Dict{Mooncake.BasicBlockCode.ID, Bool}, Expr}" href="#Mooncake.BasicBlockCode._find_id_uses!-Tuple{Dict{Mooncake.BasicBlockCode.ID, Bool}, Expr}"><code>Mooncake.BasicBlockCode._find_id_uses!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_find_id_uses!(d::Dict{ID, Bool}, x)</code></pre><p>Helper function used in <a href="#Mooncake.BasicBlockCode.characterise_used_ids-Tuple{Vector{Tuple{Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}}}"><code>characterise_used_ids</code></a>. For all uses of <code>ID</code>s in <code>x</code>, set the corresponding value of <code>d</code> to <code>true</code>.</p><p>For example, if <code>x = ReturnNode(ID(5))</code>, then this function sets <code>d[ID(5)] = true</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L908-L915">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._ids_to_line_numbers-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode._ids_to_line_numbers-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode._ids_to_line_numbers</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_ids_to_line_numbers(bb_code::BBCode)::InstVector</code></pre><p>For each statement in <code>bb_code</code>, returns a <code>NewInstruction</code> in which every <code>ID</code> is replaced by either an <code>SSAValue</code>, or an <code>Int64</code> / <code>Int32</code> which refers to an <code>SSAValue</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L685-L690">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._is_reachable-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode._is_reachable-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode._is_reachable</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_is_reachable(blks::Vector{BBlock})::Vector{Bool}</code></pre><p>Computes a <code>Vector</code> whose length is <code>length(blks)</code>. The <code>n</code>th element is <code>true</code> iff it is possible for control flow to reach the <code>n</code>th block.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L940-L945">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._lines_to_blocks-Tuple{Vector{Core.Compiler.NewInstruction}, Core.Compiler.CFG}" href="#Mooncake.BasicBlockCode._lines_to_blocks-Tuple{Vector{Core.Compiler.NewInstruction}, Core.Compiler.CFG}"><code>Mooncake.BasicBlockCode._lines_to_blocks</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_instructions_to_blocks(insts::InstVector, cfg::CC.CFG)::InstVector</code></pre><p>Pulls out the instructions from <code>insts</code>, and calls <code>__line_numbers_to_block_numbers!</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L464-L468">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._lower_switch_statements-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode._lower_switch_statements-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode._lower_switch_statements</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_lower_switch_statements(bb_code::BBCode)</code></pre><p>Converts all <code>Switch</code>s into a semantically-equivalent collection of <code>GotoIfNot</code>s. See the <code>Switch</code> docstring for an explanation of what is going on here.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L653-L658">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._remove_double_edges-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode._remove_double_edges-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode._remove_double_edges</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_remove_double_edges(ir::BBCode)::BBCode</code></pre><p>If the <code>dest</code> field of an <code>IDGotoIfNot</code> node in block <code>n</code> of <code>ir</code> points towards the <code>n+1</code>th block then we have two edges from block <code>n</code> to block <code>n+1</code>. This transformation replaces all such <code>IDGotoIfNot</code> nodes with unconditional <code>IDGotoNode</code>s pointing towards the <code>n+1</code>th block in <code>ir</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L729-L736">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._ssa_to_ids-Tuple{Dict{Core.SSAValue, Mooncake.BasicBlockCode.ID}, Core.Compiler.NewInstruction}" href="#Mooncake.BasicBlockCode._ssa_to_ids-Tuple{Dict{Core.SSAValue, Mooncake.BasicBlockCode.ID}, Core.Compiler.NewInstruction}"><code>Mooncake.BasicBlockCode._ssa_to_ids</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_ssa_to_ids(d::SSAToIdDict, inst::NewInstruction)</code></pre><p>Produce a new instance of <code>inst</code> in which all instances of <code>SSAValue</code>s are replaced with the <code>ID</code>s prescribed by <code>d</code>, all basic block numbers are replaced with the <code>ID</code>s prescribed by <code>d</code>, and <code>GotoIfNot</code>, <code>GotoNode</code>, and <code>PhiNode</code> instances are replaced with the corresponding <code>ID</code> versions.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L563-L570">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._ssas_to_ids-Tuple{Vector{Core.Compiler.NewInstruction}}" href="#Mooncake.BasicBlockCode._ssas_to_ids-Tuple{Vector{Core.Compiler.NewInstruction}}"><code>Mooncake.BasicBlockCode._ssas_to_ids</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_ssas_to_ids(insts::InstVector)::Tuple{Vector{ID}, InstVector}</code></pre><p>Assigns an ID to each line in <code>stmts</code>, and replaces each instance of an <code>SSAValue</code> in each line with the corresponding <code>ID</code>. For example, a call statement of the form <code>Expr(:call, :f, %4)</code> is be replaced with <code>Expr(:call, :f, id_assigned_to_%4)</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L550-L556">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode._to_ssas-Tuple{Dict, Core.Compiler.NewInstruction}" href="#Mooncake.BasicBlockCode._to_ssas-Tuple{Dict, Core.Compiler.NewInstruction}"><code>Mooncake.BasicBlockCode._to_ssas</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">_to_ssas(d::Dict, inst::NewInstruction)</code></pre><p>Like <code>_ssas_to_ids</code>, but in reverse. Converts IDs to SSAValues / (integers corresponding to ssas).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L705-L710">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.characterise_unique_predecessor_blocks-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}" href="#Mooncake.BasicBlockCode.characterise_unique_predecessor_blocks-Tuple{Vector{Mooncake.BasicBlockCode.BBlock}}"><code>Mooncake.BasicBlockCode.characterise_unique_predecessor_blocks</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">characterise_unique_predecessor_blocks(blks::Vector{BBlock}) -&gt;
    Tuple{Dict{ID, Bool}, Dict{ID, Bool}}</code></pre><p>We call a block <code>b</code> a <em>unique</em> <em>predecessor</em> in the control flow graph associated to <code>blks</code> if it is the only predecessor to all of its successors. Put differently we call <code>b</code> a unique predecessor if, whenever control flow arrives in any of the successors of <code>b</code>, we know for certain that the previous block must have been <code>b</code>.</p><p>Returns two <code>Dict</code>s. A value in the first <code>Dict</code> is <code>true</code> if the block associated to its key is a unique precessor, and is <code>false</code> if not. A value in the second <code>Dict</code> is <code>true</code> if  it has a single predecessor, and that predecessor is a unique predecessor.</p><p><em>Context</em>:</p><p>This information is important for optimising AD because knowing that <code>b</code> is a unique predecessor means that</p><ol><li>on the forwards-pass, there is no need to push the ID of <code>b</code> to the block stack when  passing through it, and</li><li>on the reverse-pass, there is no need to pop the block stack when passing through one of  the successors to <code>b</code>.</li></ol><p>Utilising this reduces the overhead associated to doing AD. It is quite important when working with cheap loops – loops where the operations performed at each iteration are inexpensive – for which minimising memory pressure is critical to performance. It is also important for single-block functions, because it can be used to entirely avoid using a block stack at all.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L805-L832">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.characterise_used_ids-Tuple{Vector{Tuple{Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}}}" href="#Mooncake.BasicBlockCode.characterise_used_ids-Tuple{Vector{Tuple{Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}}}"><code>Mooncake.BasicBlockCode.characterise_used_ids</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">characterise_used_ids(stmts::Vector{IDInstPair})::Dict{ID, Bool}</code></pre><p>For each line in <code>stmts</code>, determine whether it is referenced anywhere else in the code. Returns a dictionary containing the results. An element is <code>false</code> if the corresponding <code>ID</code> is unused, and <code>true</code> if is used.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L886-L892">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.collect_stmts-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode.collect_stmts-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.collect_stmts</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">collect_stmts(ir::BBCode)::Vector{IDInstPair}</code></pre><p>Produce a <code>Vector</code> containing all of the statements in <code>ir</code>. These are returned in order, so it is safe to assume that element <code>n</code> refers to the <code>nth</code> element of the <code>IRCode</code> associated to <code>ir</code>. </p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L403-L409">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.collect_stmts-Tuple{Mooncake.BasicBlockCode.BBlock}" href="#Mooncake.BasicBlockCode.collect_stmts-Tuple{Mooncake.BasicBlockCode.BBlock}"><code>Mooncake.BasicBlockCode.collect_stmts</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">collect_stmts(bb::BBlock)::Vector{IDInstPair}</code></pre><p>Returns a <code>Vector</code> containing the <code>ID</code>s and instructions associated to each line in <code>bb</code>. These should be assumed to be ordered.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L267-L272">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.compute_all_predecessors-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode.compute_all_predecessors-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.compute_all_predecessors</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">compute_all_predecessors(ir::BBCode)::Dict{ID, Vector{ID}}</code></pre><p>Compute a map from the <code>ID</code> of each <code>BBlock</code> in <code>ir</code> to its possible predecessors.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L370-L374">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.compute_all_successors-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode.compute_all_successors-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.compute_all_successors</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">compute_all_successors(ir::BBCode)::Dict{ID, Vector{ID}}</code></pre><p>Compute a map from the <code>ID</code> of each <code>BBlock</code> in <code>ir</code> to its possible successors.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L335-L339">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.control_flow_graph-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode.control_flow_graph-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.control_flow_graph</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">control_flow_graph(bb_code::BBCode)::Core.Compiler.CFG</code></pre><p>Computes the <code>Core.Compiler.CFG</code> object associated to this <code>bb_code</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L429-L433">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.id_to_line_map-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode.id_to_line_map-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.id_to_line_map</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">id_to_line_map(ir::BBCode)</code></pre><p>Produces a <code>Dict</code> mapping from each <code>ID</code> associated with a line in <code>ir</code> to its line number. This is isomorphic to mapping to its <code>SSAValue</code> in <code>IRCode</code>. Terminators do not have <code>ID</code>s associated to them, so not every line in the original <code>IRCode</code> is mapped to.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L412-L418">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.insert_before_terminator!-Tuple{Mooncake.BasicBlockCode.BBlock, Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}" href="#Mooncake.BasicBlockCode.insert_before_terminator!-Tuple{Mooncake.BasicBlockCode.BBlock, Mooncake.BasicBlockCode.ID, Core.Compiler.NewInstruction}"><code>Mooncake.BasicBlockCode.insert_before_terminator!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">insert_before_terminator!(bb::BBlock, id::ID, inst::NewInstruction)::Nothing</code></pre><p>If the final instruction in <code>bb</code> is a <code>Terminator</code>, insert <code>inst</code> immediately before it. Otherwise, insert <code>inst</code> at the end of the block.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L256-L261">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.is_reachable_return_node-Tuple{Core.ReturnNode}" href="#Mooncake.BasicBlockCode.is_reachable_return_node-Tuple{Core.ReturnNode}"><code>Mooncake.BasicBlockCode.is_reachable_return_node</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">is_reachable_return_node(x::ReturnNode)</code></pre><p>Determine whether <code>x</code> is a <code>ReturnNode</code>, and if it is, if it is also reachable. This is purely a function of whether or not its <code>val</code> field is defined or not.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L877-L882">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.new_inst" href="#Mooncake.BasicBlockCode.new_inst"><code>Mooncake.BasicBlockCode.new_inst</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">new_inst(stmt, type=Any, flag=CC.IR_FLAG_REFINED)::NewInstruction</code></pre><p>Create a <code>NewInstruction</code> with fields:</p><ul><li><code>stmt</code> = <code>stmt</code></li><li><code>type</code> = <code>type</code></li><li><code>info</code> = <code>CC.NoCallInfo()</code></li><li><code>line</code> = <code>Int32(1)</code></li><li><code>flag</code> = <code>flag</code></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L47-L56">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.new_inst_vec-Tuple{Core.Compiler.InstructionStream}" href="#Mooncake.BasicBlockCode.new_inst_vec-Tuple{Core.Compiler.InstructionStream}"><code>Mooncake.BasicBlockCode.new_inst_vec</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">new_inst_vec(x::CC.InstructionStream)</code></pre><p>Convert an <code>Compiler.InstructionStream</code> into a list of <code>Compiler.NewInstruction</code>s.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L536-L540">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.phi_nodes-Tuple{Mooncake.BasicBlockCode.BBlock}" href="#Mooncake.BasicBlockCode.phi_nodes-Tuple{Mooncake.BasicBlockCode.BBlock}"><code>Mooncake.BasicBlockCode.phi_nodes</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">phi_nodes(bb::BBlock)::Tuple{Vector{ID}, Vector{IDPhiNode}}</code></pre><p>Returns all of the <code>IDPhiNode</code>s at the start of <code>bb</code>, along with their <code>ID</code>s. If there are no <code>IDPhiNode</code>s at the start of <code>bb</code>, then both vectors will be empty.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L223-L228">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.remove_unreachable_blocks!-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode.remove_unreachable_blocks!-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.remove_unreachable_blocks!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">remove_unreachable_blocks!(ir::BBCode)::BBCode</code></pre><p>If a basic block in <code>ir</code> cannot possibly be reached during execution, then it can be safely removed from <code>ir</code> without changing its functionality. A block is unreachable if either:</p><ol><li>it has no predecessors <em>and</em> it is not the first block, or</li><li>all of its predecessors are themselves unreachable.</li></ol><p>For example, consider the following IR:</p><pre><code class="language-julia-repl hljs">julia&gt; ir = Mooncake.ircode(
           Any[Core.ReturnNode(nothing), Expr(:call, sin, 5), Core.ReturnNode(Core.SSAValue(2))],
           Any[Any, Any, Any],
       );</code></pre><p>There is no possible way to reach the second basic block (lines 2 and 3). Applying this function will therefore remove it, yielding the following:</p><pre><code class="language-julia-repl hljs">julia&gt; Mooncake.IRCode(Mooncake.remove_unreachable_blocks!(Mooncake.BBCode(ir)))
1 1 ─     return nothing</code></pre><p>In the blocks which have not been removed, there may be references to blocks which have been removed. For example, the <code>edge</code>s in a <code>PhiNode</code> may contain a reference to a removed block. These references are removed in-place from these remaining blocks, so this function will (in general) modify <code>ir</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L948-L975">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.seed_id!-Tuple{}" href="#Mooncake.BasicBlockCode.seed_id!-Tuple{}"><code>Mooncake.BasicBlockCode.seed_id!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">seed_id!()</code></pre><p>Set the global counter used to ensure ID uniqueness to 0. This is useful when you want to ensure determinism between two runs of the same function which makes use of <code>ID</code>s.</p><p>This is akin to setting the random seed associated to a random number generator globally.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L91-L98">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.sort_blocks!-Tuple{Mooncake.BasicBlockCode.BBCode}" href="#Mooncake.BasicBlockCode.sort_blocks!-Tuple{Mooncake.BasicBlockCode.BBCode}"><code>Mooncake.BasicBlockCode.sort_blocks!</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">sort_blocks!(ir::BBCode)::BBCode</code></pre><p>Ensure that blocks appear in order of distance-from-entry-point, where distance the distance from block b to the entry point is defined to be the minimum number of basic blocks that must be passed through in order to reach b.</p><p>For reasons unknown (to me, Will), the compiler / optimiser needs this for inference to succeed. Since we do quite a lot of re-ordering on the reverse-pass of AD, this is a problem there.</p><p>WARNING: use with care. Only use if you are confident that arbitrary re-ordering of basic blocks in <code>ir</code> is valid. Notably, this does not hold if you have any <code>IDGotoIfNot</code> nodes in <code>ir</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L784-L798">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.BasicBlockCode.terminator-Tuple{Mooncake.BasicBlockCode.BBlock}" href="#Mooncake.BasicBlockCode.terminator-Tuple{Mooncake.BasicBlockCode.BBlock}"><code>Mooncake.BasicBlockCode.terminator</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">terminator(bb::BBlock)</code></pre><p>Returns the terminator associated to <code>bb</code>. If the last instruction in <code>bb</code> isa <code>Terminator</code> then that is returned, otherwise <code>nothing</code> is returned.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/c858c37e7c0714c25a1ecd2b6e2d56802dc7807e/src/interpreter/bbcode.jl#L248-L253">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../custom_tangent_type/">« Writing Custom Tangent Types</a><a class="docs-footer-nextpage" href="../forwards_mode_design/">Forwards-Mode Design »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.13.0 on <span class="colophon-date" title="Tuesday 1 July 2025 11:47">Tuesday 1 July 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
