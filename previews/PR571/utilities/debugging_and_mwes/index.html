<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Debugging and MWEs · Mooncake.jl</title><meta name="title" content="Debugging and MWEs · Mooncake.jl"/><meta property="og:title" content="Debugging and MWEs · Mooncake.jl"/><meta property="twitter:title" content="Debugging and MWEs · Mooncake.jl"/><meta name="description" content="Documentation for Mooncake.jl."/><meta property="og:description" content="Documentation for Mooncake.jl."/><meta property="twitter:description" content="Documentation for Mooncake.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Mooncake.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Mooncake.jl</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../interface/">Interface</a></li><li><span class="tocitem">Understanding Mooncake.jl</span><ul><li><a class="tocitem" href="../../understanding_mooncake/introduction/">Introduction</a></li><li><a class="tocitem" href="../../understanding_mooncake/algorithmic_differentiation/">Algorithmic Differentiation</a></li><li><a class="tocitem" href="../../understanding_mooncake/rule_system/">Mooncake.jl&#39;s Rule System</a></li></ul></li><li><span class="tocitem">Utilities</span><ul><li><a class="tocitem" href="../defining_rules/">Defining Rules</a></li><li><a class="tocitem" href="../debug_mode/">Debug Mode</a></li><li class="is-active"><a class="tocitem" href>Debugging and MWEs</a><ul class="internal"><li><a class="tocitem" href="#Example"><span>Example</span></a></li><li><a class="tocitem" href="#Segfaults"><span>Segfaults</span></a></li></ul></li></ul></li><li><span class="tocitem">Developer Documentation</span><ul><li><a class="tocitem" href="../../developer_documentation/running_tests_locally/">Running Tests Locally</a></li><li><a class="tocitem" href="../../developer_documentation/developer_tools/">Developer Tools</a></li><li><a class="tocitem" href="../../developer_documentation/ir_representation/">IR Representation</a></li><li><a class="tocitem" href="../../developer_documentation/forwards_mode_design/">Forwards-Mode Design</a></li><li><a class="tocitem" href="../../developer_documentation/reverse_mode_design/">Reverse-Mode Design</a></li><li><a class="tocitem" href="../../developer_documentation/misc_internals_notes/">Misc. Internals Notes</a></li><li><a class="tocitem" href="../../developer_documentation/internal_docstrings/">Internal Docstrings</a></li></ul></li><li><a class="tocitem" href="../../known_limitations/">Known Limitations</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Utilities</a></li><li class="is-active"><a href>Debugging and MWEs</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Debugging and MWEs</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chalk-lab/Mooncake.jl/blob/main/docs/src/utilities/debugging_and_mwes.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Debugging-and-MWEs"><a class="docs-heading-anchor" href="#Debugging-and-MWEs">Debugging and MWEs</a><a id="Debugging-and-MWEs-1"></a><a class="docs-heading-anchor-permalink" href="#Debugging-and-MWEs" title="Permalink"></a></h1><p>There&#39;s a reasonable chance that you&#39;ll run into an issue with Mooncake.jl at some point. In order to debug what is going on when this happens, or to produce an MWE, it is helpful to have a convenient way to run Mooncake.jl on whatever function and arguments you have which are causing problems.</p><p>We recommend making use of Mooncake.jl&#39;s testing functionality to generate your test cases:</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Mooncake.TestUtils.test_rule-utilities-debugging_and_mwes" href="#Mooncake.TestUtils.test_rule-utilities-debugging_and_mwes"><code>Mooncake.TestUtils.test_rule</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">test_rule(
    rng, x...;
    interface_only=false,
    is_primitive::Bool=true,
    perf_flag::Symbol=:none,
    interp::Mooncake.MooncakeInterpreter=Mooncake.get_interpreter(),
    debug_mode::Bool=false,
    unsafe_perturb::Bool=false,
)</code></pre><p>Run standardised tests on the <code>rule</code> for <code>x</code>. The first element of <code>x</code> should be the primal function to test, and each other element a positional argument. In most cases, elements of <code>x</code> can just be the primal values, and <code>randn_tangent</code> can be relied upon to generate an appropriate tangent to test. Some notable exceptions exist though, in partcular <code>Ptr</code>s. In this case, the argument for which <code>randn_tangent</code> cannot be readily defined should be a <code>CoDual</code> containing the primal, and a <em>manually</em> constructed tangent field.</p><p>This function uses <a href="../../developer_documentation/internal_docstrings/#Mooncake.build_rrule-Tuple"><code>Mooncake.build_rrule</code></a> to construct a rule. This will use an <code>rrule!!</code> if one exists, and derive a rule otherwise.</p><p><strong>Arguments</strong></p><ul><li><code>rng::AbstractRNG</code>: a random number generator</li><li><code>x...</code>: the function (first element) and its arguments (the remainder)</li></ul><p><strong>Keyword Arguments</strong></p><ul><li><code>interface_only::Bool=false</code>: test only that the interface is satisfied, without testing   correctness. This should generally be set to <code>false</code> (the default value), and only   enabled if the testing infrastructure is unable to test correctness for some reason   e.g. the returned value of the function is a <code>Ptr</code>, and appropriate tangents cannot,   therefore, be generated for it automatically.</li><li><code>is_primitive::Bool=true</code>: check whether the thing that you are testing has a hand-written   <code>rrule!!</code>. This option is helpful if you are testing a new <code>rrule!!</code>, as it enables you   to verify that your method of <code>is_primitive</code> has returned the correct value, and that   you are actually testing a method of the <code>rrule!!</code> function – a common mistake when   authoring a new <code>rrule!!</code> is to implement <code>is_primitive</code> incorrectly and to accidentally   wind up testing a rule which Mooncake has derived, as opposed to the one that you have   written. If you are testing something for which you have not   hand-written an <code>rrule!!</code>, or which you do not care whether it has a hand-written   <code>rrule!!</code> or not, you should set it to <code>false</code>.</li><li><code>perf_flag::Symbol=:none</code>: the value of this symbol determines what kind of performance   tests should be performed. By default, none are performed. If you believe that a rule   should be allocation-free (iff the primal is allocation free), set this to <code>:allocs</code>. If   you hand-write an <code>rrule!!</code> and believe that your test case should be type stable, set   this to <code>:stability</code> (at present we cannot verify whether a derived rule is type stable   for technical reasons). If you believe that a hand-written rule should be <em>both</em>   allocation-free and type-stable, set this to <code>:stability_and_allocs</code>.</li><li><code>interp::Mooncake.MooncakeInterpreter=Mooncake.get_interpreter()</code>: the abstract   interpreter to be used when testing this rule. The default should generally be used.</li><li><code>debug_mode::Bool=false</code>: whether or not the rule should be tested in debug mode.   Typically this should be left at its default <code>false</code> value, but if you are finding that   the tests are failing for a given rule, you may wish to temporarily set it to <code>true</code> in   order to get access to additional information and automated testing.</li><li><code>unsafe_perturb::Bool=false</code>: value passed as the third argument to <code>_add_to_primal</code>.   Should usually be left <code>false</code> – consult the docstring for <code>_add_to_primal</code> for more   info on when you might wish to set it to <code>true</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/chalk-lab/Mooncake.jl/blob/b83e6687571f11bdac7bce1e4fed9b4b836da2b1/src/test_utils.jl#L625-L683">source</a></section></article><p>This approach is convenient because it can</p><ol><li>check whether AD runs at all,</li><li>check whether AD produces the correct answers,</li><li>check whether AD is performant, and</li><li>can be used without having to manually generate tangents.</li></ol><h2 id="Example"><a class="docs-heading-anchor" href="#Example">Example</a><a id="Example-1"></a><a class="docs-heading-anchor-permalink" href="#Example" title="Permalink"></a></h2><p>For example</p><pre><code class="language-julia hljs">f(x) = Core.bitcast(Float64, x)
Mooncake.TestUtils.test_rule(Random.Xoshiro(123), f, 3; is_primitive=false)</code></pre><p>will error. (In this particular case, it is caused by Mooncake.jl preventing you from doing (potentially) unsafe casting. In this particular instance, Mooncake.jl just fails to compile, but in other instances other things can happen.)</p><p>In any case, the point here is that <code>Mooncake.TestUtils.test_rule</code> provides a convenient way to produce and report an error.</p><h2 id="Segfaults"><a class="docs-heading-anchor" href="#Segfaults">Segfaults</a><a id="Segfaults-1"></a><a class="docs-heading-anchor-permalink" href="#Segfaults" title="Permalink"></a></h2><p>These are everyone&#39;s least favourite kind of problem, and they should be <em>extremely</em> rare in Mooncake.jl. However, if you are unfortunate enough to encounter one, please re-run your problem with the <code>debug_mode</code> kwarg set to <code>true</code>. See <a href="../debug_mode/#Debug-Mode">Debug Mode</a> for more info. In general, this will catch problems before they become segfaults, at which point the above strategy for debugging and error reporting should work well.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../debug_mode/">« Debug Mode</a><a class="docs-footer-nextpage" href="../../developer_documentation/running_tests_locally/">Running Tests Locally »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.0 on <span class="colophon-date" title="Friday 9 May 2025 16:47">Friday 9 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
